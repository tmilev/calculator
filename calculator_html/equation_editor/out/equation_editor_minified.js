!function(t){var e={};function i(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(n,o,function(e){return t[e]}.bind(null,o));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){const n=i(1);function o(){const t=new n.EquationEditorOptions({editable:!0,latexInput:document.getElementById("latex"),sanitizeLatexSource:!1,removeDisplayStyle:!1,debugLogContainer:null,copyButton:!1});let e=new n.EquationEditor(document.getElementById("editor"),t);new n.EquationEditorButtonFactory("\\frac{123}{\\cursor}\\sqrt{7}","","").attachToClickById("custom-button",e),n.buttonFactories.sqrt.attachToClickById("sqrt-button",e),e.updateDOM(),e.rootNode.focus(-1)}"loading"!==document.readyState?o():window.addEventListener("load",()=>{o()})},function(t,e){class i{normalizeConstructorInput(t){for(let e in n)e in t||(t[e]=n[e]);if(void 0!==t.arrows)for(let e in s)e in t.arrows||(t.arrows[e]=s[e]);else t.arrows=s}constructor(t){this.normalizeConstructorInput(t),this.arrows=t.arrows,this.type=t.type,this.width=t.width,this.height=t.height,this.display=t.display,this.verticalAlign=t.verticalAlign,this.outline=t.outline,this.fontSizeRatio=t.fontSizeRatio,this.fontWeight=t.fontWeight,this.whiteSpace=t.whiteSpace,this.textAlign=t.textAlign,this.position=t.position,this.minWidth=t.minWidth,this.cursor=t.cursor,this.overflow=t.overflow,this.boxSizing=t.boxSizing,this.colorImplied=t.colorImplied,this.colorText=t.colorText,this.paddingBottom=t.paddingBottom,this.paddingBottomRatioForSVG=t.paddingBottomRatioForSVG,this.paddingTop=t.paddingTop,this.paddingRight=t.paddingRight,this.paddingLeft=t.paddingLeft,this.padding=t.padding,this.margin=t.margin,this.marginBottom=t.marginBottom,this.marginRight=t.marginRight,this.marginLeft=t.marginLeft,this.borderTopLeftRadius=t.borderTopLeftRadius,this.borderTopRightRadius=t.borderTopRightRadius,this.borderBottomLeftRadius=t.borderBottomLeftRadius,this.borderBottomRightRadius=t.borderBottomRightRadius,this.borderStyle=t.borderStyle,this.borderColor=t.borderColor,this.borderBottom=t.borderBottom,this.borderTop=t.borderTop,this.borderLeft=t.borderLeft,this.borderRight=t.borderRight}clone(){let t=new i({});return Object.assign(t,this),t}}const n={width:"",height:"",minWidth:"",display:"inline-block",verticalAlign:"",fontSizeRatio:1,fontWeight:"",whiteSpace:"",textAlign:"",position:"absolute",cursor:"",outline:"",overflow:"",boxSizing:"",colorText:"",colorImplied:"",paddingBottom:"",paddingBottomRatioForSVG:1,paddingTop:"",paddingLeft:"",paddingRight:"",padding:"",marginBottom:"",marginLeft:"",marginRight:"",margin:"",borderBottomLeftRadius:"",borderBottomRightRadius:"",borderTopLeftRadius:"",borderTopRightRadius:"",borderStyle:"",borderColor:"",borderBottom:"",borderTop:"",borderLeft:"",borderRight:""};let o=new class{constructor(){this.parentForward="parentForward",this.firstAtomToTheLeft="firstAtomToTheLeft",this.firstAtomToTheRight="firstAtomToTheRight",this.firstAtomUp="firstAtomUp",this.firstAtomDown="firstAtomDown"}};const s={ArrowUp:o.parentForward,ArrowDown:o.parentForward,ArrowLeft:o.firstAtomToTheLeft,ArrowRight:o.firstAtomToTheRight},r={root:new i({type:"root",padding:"2px",margin:"2px",cursor:"text",minWidth:"30px",overflow:"visible"}),atom:new i({type:"atom",outline:"0px solid transparent",width:"auto",height:"auto",minWidth:"4px",verticalAlign:"text-bottom",overflow:"hidden",boxSizing:"border-box"}),formInput:new i({type:"formInput",boxSizing:"border-box"}),atomImmutable:new i({type:"atomImmutable",paddingLeft:"0.1em",paddingRight:"0.1em",outline:"0px solid transparent",textAlign:"center",width:"auto",height:"auto",boxSizing:"border-box"}),eventCatcher:new i({type:"eventCatcher",width:"0px",maxWidth:"0px",height:"0px",maxHeight:"0px",display:"hidden",overflow:"hidden"}),error:new i({type:"error",colorText:"red",whiteSpace:"nowrap"}),leftDelimiterMark:new i({type:"leftDelimiterMark",borderLeft:"2px solid",colorImplied:"silver",boxSizing:"border-box"}),leftDelimiter:new i({type:"leftDelimiter",colorImplied:"silver"}),rightDelimiterMark:new i({type:"rightDelimiterMark",borderRight:"2px solid",colorImplied:"silver",boxSizing:"border-box"}),rightDelimiter:new i({type:"rightDelimiter",colorImplied:"silver"}),horizontalMath:new i({type:"horizontalMath",whiteSpace:"nowrap",verticalAlign:"text-bottom",textAlign:"center"}),verticalLineInTable:new i({type:"verticalLine",borderLeft:"1px solid black"}),fraction:new i({type:"fraction"}),cancel:new i({type:"cancel"}),cancelSign:new i({type:"cancelSign",borderLeft:"2px solid black"}),cancelUnderBox:new i({type:"cancelUnderBox"}),numerator:new i({type:"numerator",borderBottom:"1px solid black",fontSizeRatio:.9,arrows:{ArrowUp:o.firstAtomToTheLeft,ArrowDown:o.firstAtomToTheRight},whiteSpace:"nowrap",textAlign:"center"}),denominator:new i({type:"denominator",fontSizeRatio:.9,arrows:{ArrowUp:o.firstAtomToTheLeft,ArrowDown:o.firstAtomToTheRight},textAlign:"center"}),overLinedBox:new i({type:"overLinedBox",borderTop:"1px solid black",boxSizing:"border-box"}),genericMathBox:new i({type:"genericMathBox"}),baseWithExponent:new i({type:"baseWithExponent"}),exponent:new i({type:"exponent",fontSizeRatio:.75}),baseWithSubscript:new i({type:"baseWithSubscript"}),underBrace:new i({type:"underBrace"}),overBrace:new i({type:"overBrace"}),horizontalBrace:new i({type:"horizontalBrace"}),topRightQuarterCircle:new i({type:"topRightQuarterCircle",borderTopRightRadius:"4px"}),topLeftQuarterCircle:new i({type:"topLeftQuarterCircle",borderTopLeftRadius:"4px"}),bottomRightQuarterCircle:new i({type:"bottomRightQuarterCircle",borderBottomRightRadius:"4px"}),bottomLeftQuarterCircle:new i({type:"bottomLeftQuarterCircle",borderBottomLeftRadius:"4px"}),horizontalLineBottomMargin:new i({type:"horizontalLineBottomMargin",borderBottom:"2px solid black"}),verticalLineLeftMargin:new i({type:"verticalLineLeftMargin",borderLeft:"solid"}),verticalLineRightMargin:new i({type:"verticalLineRightMargin",borderRight:"solid"}),subscript:new i({type:"subscript",fontSizeRatio:.75}),sqrt:new i({type:"sqrt",margin:"2px"}),sqrtSign:new i({type:"sqrtSign"}),sqrtSignDecoration:new i({type:"sqrtSignDecoration",borderTop:"1px solid black"}),sqrtSignLeft:new i({type:"sqrtSignLeft",borderLeft:"1px solid black"}),sqrtSignRight:new i({type:"sqrtSignRight",borderLeft:"1px solid black"}),radicalExponentBox:new i({type:"radicalExponentBox",fontSizeRatio:.65}),radicalUnderBox:new i({type:"radicalUnderBox",borderTop:"1px solid black"}),matrix:new i({type:"matrix"}),matrixTable:new i({type:"matrixTable"}),matrixRow:new i({type:"matrixRow"}),matrixRowEntry:new i({type:"matrixRowEntry",arrows:{ArrowUp:o.firstAtomUp,ArrowDown:o.firstAtomDown}}),operatorWithSuperAndSubscript:new i({type:"operatorWithSuperAndSubscript"}),operatorWithSubscript:new i({type:"operatorWithSubscript"}),operatorStandalone:new i({type:"operatorStandalone",fontSizeRatio:1.8}),operatorSubscript:new i({type:"operatorSubscript",fontSizeRatio:.55}),operatorSuperscript:new i({type:"operatorSuperscript",fontSizeRatio:.55})};class l{constructor(t,e){this.element=t,this.position=e,null===this.element&&(this.position=-1)}assign(t){if(null===t)return this.element=null,void(this.position=-1);this.element=t.element,this.position=t.position}getPositionWholeItemIfNegative(t){return this.position>=0?this.position:t<0?0:this.element.textContentOrInitialContent().length}nextPositionInDirection(t){0===t&&(t=1);let e=this.element.textContentOrInitialContent(),i=this.position+t;for(;i>=0&&i<e.length;i+=t){let t=e.charCodeAt(i);if(t<55296||t>57343)return i}return i>=e.length?e.length:i<0?0:-1}leftHorizontalNeighborBalanced(t){if(null===this.element)return new l(null,-1);if(this.position>0&&this.element.hasHorozintalMathParent())return new l(this.element,this.nextPositionInDirection(-1));let e=null;if(t&&this.element.type.type===r.rightDelimiter.type){let t=this.element.findMatchingDelimiter();if(null===t)return new l(null,-1);e=t.firstAtomSiblingOrUncle(-1)}else e=this.element.firstAtomSiblingOrUncle(-1);return new l(null===e?null:e,-1)}rightHorizontalNeighborBalanced(t){if(null===this.element)return new l(null,-1);if(this.position>=0&&this.position<this.element.lengthContentIfAtom()&&this.element.hasHorozintalMathParent())return new l(this.element,this.nextPositionInDirection(1));let e=null;if(t&&this.element.type.type===r.leftDelimiter.type){let t=this.element.findMatchingDelimiter();if(null===t)return new l(null,-1);e=t.firstAtomSiblingOrUncle(1)}else e=this.element.firstAtomSiblingOrUncle(1);return new l(null===e?null:e,-1)}leftNeighbor(){if(null===this.element)return new l(null,-1);if(this.position>0)return new l(this.element,this.nextPositionInDirection(-1));let t=this.element.firstAtomToTheLeft();return null===t?new l(null,-1):new l(t,t.element.textContent.length)}rightNeighbor(){return null===this.element?new l(null,-1):this.position<this.element.lengthContentIfAtom()?new l(this.element,this.nextPositionInDirection(1)):new l(this.element.firstAtomToTheRight(),0)}toString(){if(null===this.element)return`[null, ${this.position}]`;let t="";return this.element.isDetached()&&(t=",<b style='color:red'> detached</b>"),`[${this.element.toString()}, ${this.position}${t}]`}}function h(t,e,i,n,o,s,r){let l=t.textContent;return null===l&&(l=""),a(t,l,e,i,n,o,s,r)}function a(t,e,i,n,o,s,r,l){let h=t.getAttribute("lineBreakWidth"),a=0;""!==h&&(a=parseInt(h,10)),"true"===t.getAttribute("copyButton")&&(l=!0);let d=new B(t,new g({editable:i,sanitizeLatexSource:n,removeDisplayStyle:o,logTiming:!0,lineBreakWidth:a,copyButton:l}),r);return d.writeLatex(e),null!=s&&s(d),d}function d(t,e){let i=document.createElement("b");return i.textContent=t,i.style.color=e,i}class c{constructor(t,e,i){this.node=t,this.content=e,this.syntacticRole=i}toHtmlDebugData(){let t=[];if(null!==this.node){let e=this.node.toLatex();""===e&&(e=`[${this.node.type.type}]`),t.push(document.createTextNode(e))}return""!==this.content&&t.push(d(this.content,"orange")),""!==this.syntacticRole&&t.push(d(this.syntacticRole,"red")),t}isExpression(){return""===this.syntacticRole&&null!==this.node}isMatrixEnder(){return this.syntacticRole in p.matrixEnder}}let u=new class{constructor(t){this.useCursorCommand=t}}(!0);const p=new class{constructor(){this.latinCharactersString="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",this.latinCharacters={};for(let t=0;t<this.latinCharactersString.length;t++)this.latinCharacters[this.latinCharactersString[t]]=!0;this.digitString="0123456789",this.digits={};for(let t=0;t<this.digitString.length;t++)this.digits[this.digitString[t]]=!0;this.characterReplacingSelectionString="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 +-*",this.characterReplacingSelection={};for(let t=0;t<this.characterReplacingSelectionString.length;t++)this.characterReplacingSelection[this.characterReplacingSelectionString[t]]=!0;this.operatorsExtraPadding={"=":"0.3em","≤":"0.3em","≥":"0.3em","→":"0.3em",">":"0.3em","<":"0.3em",mod:"0.5em","≠":"0.3em","…":"0.3em"},this.operatorsExtraVerticalPadding={"→":"0.3em"},this.operatorsExtraVerticalPaddingForSVG={"→":.85},this.operatorsNormalized={"＋":"+","+":"+",";":";",":":":",",":",",".":".","±":"±","−":"−","-":"−","*":"·","·":"·","=":"=",">":">","<":"<"},this.operatorsFromUft8={"−":"-"},this.latexSyntacticValues={"{":"{","}":"}","^":"^",_:"_","(":"(",")":")","\\":"\\","&":"&","[":"[","]":"]","|":"|"},this.latexBackslashCommands={left:"\\left",right:"\\right",cancel:"\\cancel",sqrt:"\\sqrt",begin:"\\begin",cursor:"\\cursor",formInput:"\\formInput",end:"\\end",frac:"\\frac",mathcal:"\\mathcal",mathfrak:"\\mathfrak",mathbb:"\\mathbb",langle:"\\langle",rangle:"\\rangle",lfloor:"\\lfloor",rfloor:"\\rfloor",lceil:"\\lceil",rceil:"\\rceil","{":"\\{",binom:"\\binom",stackrel:"\\stackrel",overbrace:"\\overbrace",underbrace:"\\underbrace",overline:"\\overline",color:"\\color",mathbf:"\\mathbf",hline:"\\hline"},this.latexBackslashOperators={bullet:"•",otimes:"⊗",oplus:"⊕",times:"×",circ:"∘",cdot:"·",leq:"≤",le:"≤",neq:"≠",dots:"…",vdots:"⋮",approx:"~",equiv:"≡",subset:"⊂",supset:"⊃",setminus:"\\",lt:"<",gt:">",sqcup:"⊔",to:"→",rightarrow:"→",mapsto:"↦",leftarrow:"←",nwarrow:"↖",nearrow:"↗",searrow:"↘",swarrow:"↙",perp:"⟂",pm:"±",div:"÷",det:"det",geq:"≥",ge:"≥",sin:"sin",cos:"cos",tan:"tan",cot:"cot",sec:"sec",csc:"csc",ln:"ln",log:"log",arctan:"arctan",arccos:"arccos",arcsin:"arcsin",in:"∈",cap:"∩",cup:"∪",mod:"mod"},this.latexBackslashOperatorsBackslashed={};for(let t in this.latexBackslashOperators)this.latexBackslashOperatorsBackslashed["\\"+t]=this.latexBackslashOperators[t];this.operatorWithSuperAndSubscript={sum:"∑",int:"∫"},this.operatorWithSuperAndSubscriptBackslashed={};for(let t in this.operatorWithSuperAndSubscript)this.operatorWithSuperAndSubscriptBackslashed["\\"+t]=this.operatorWithSuperAndSubscript[t];this.operatorsWithSubscript={lim:"lim"},this.operatorsWithSubscriptBackslashed={};for(let t in this.operatorsWithSubscript)this.operatorsWithSubscriptBackslashed["\\"+t]=this.operatorsWithSubscript[t];this.latexBackslashAtomsEditable={alpha:"α",beta:"β",gamma:"γ",delta:"δ",epsilon:"ε",varepsilon:"ε",zeta:"ζ",eta:"η",theta:"θ",vartheta:"",iota:"ι",emptyset:"∅",kappa:"κ",lambda:"λ",mu:"μ",nu:"ν",xi:"ξ",omicron:"ο",pi:"π",rho:"ρ",sigma:"σ",tau:"τ",upsilon:"υ",phi:"φ",varphi:"ϕ",chi:"χ",psi:"ψ",omega:"ω",Alpha:"Α",Beta:"Β",Gamma:"Γ",Delta:"Δ",Epsilon:"Ε",Zeta:"Ζ",Eta:"Η",Theta:"Θ",Iota:"Ι",Kappa:"Κ",Lambda:"Λ",Mu:"Μ",Nu:"Ν",Xi:"Ξ",Omicron:"Ο",Pi:"Π",Rho:"Ρ",Sigma:"Σ",Tau:"Τ",Upsilon:"Υ",Phi:"Φ",Chi:"Χ",Psi:"Ψ",Omega:"Ω",infty:"∞",S:"§",partial:"∂"},this.latexBackslashAtomsEditableBackslashed={};for(let t in this.latexBackslashAtomsEditable)this.latexBackslashAtomsEditableBackslashed["\\"+t]=this.latexBackslashAtomsEditable[t];this.mathcalEquivalents={A:"𝒜",C:"𝒞",D:"𝒟",G:"𝒢",J:"𝒥",K:"𝒦",L:"ℒ",N:"𝒩",O:"𝒪",P:"𝒫",Q:"𝒬",S:"𝒮",T:"𝒯",U:"𝒰",V:"𝒱",W:"𝒲",X:"𝒳",Y:"𝒴",Z:"𝒵"},this.mathfrakEquivalents={a:"𝔞",b:"𝔟",c:"𝔠",d:"𝔡",e:"𝔢",f:"𝔣",g:"𝔤",h:"𝔥",i:"𝔦",j:"𝔧",k:"𝔨",l:"𝔩",m:"𝔪",n:"𝔫",o:"𝔬",p:"𝔭",q:"𝔮",r:"𝔯",s:"𝔰",t:"𝔱",u:"𝔲",v:"𝔳",w:"𝔴",x:"𝔵",y:"𝔶",z:"𝔷"},this.mathbbEquivalents={A:"𝔸",C:"ℂ",H:"ℍ",N:"ℕ",O:"𝕆",P:"ℙ",Q:"ℚ",R:"ℝ",Z:"ℤ"},this.leftDelimiters={"\\left.":"","\\langle":"\\langle","\\lfloor":"\\lfloor","\\lceil":"\\lceil","(":"(","[":"[","|":"|","\\{":"{"},this.delimitersAmbiguous={"|":"|"},this.rightDelimiters={"\\right.":"","\\rangle":"\\rangle","\\rfloor":"\\rfloor","\\rceil":"\\rceil",")":")","|":"|","]":"]","\\}":"}"},this.leftRightDelimiterPair={"\\langle":"\\rangle","\\lfloor":"\\rfloor","\\lceil":"\\rceil","[":"]","(":")","{":"}","|":"|"},this.rightLeftDelimiterPair={"\\rangle":"\\langle","\\rfloor":"\\lfloor","\\rceil":"\\lceil","]":"[",")":"(","}":"{"},this.latexCommandsIgnored={displaystyle:!0,text:!0,mathrm:!0,phantom:!0,limits:!0},this.beginEndEnvironments={matrix:"matrix",pmatrix:"pmatrix",bmatrix:"bmatrix",vmatrix:"vmatrix",array:"array",cases:"cases",align:"align","align*":"align*"},this.matrixEnder={"\\end{pmatrix}":!0,"\\end{matrix}":!0,"\\end{bmatrix}":!0,"\\end{vmatrix}":!0,"\\end{array}":!0,"\\end{align}":!0,"\\end{align*}":!0,"\\end{cases}":!0},this.whiteSpaceCharactersIgnored={"~":!1," ":!0,"\t":!0," ":!0,"\n":!0},this.whiteSpaceUtf16={" ":" "," ":" ","​":" "," ":" "},this.utf16ToLatexMap=null,this.recognizedCommandsKeyInput={"\\langle":!0,"\\rangle":!0,"\\lfloor":!0,"\\rfloor":!0,"\\lceil":!0,"\\rceil":!0,"\\matrix":!0,"\\pmatrix":!0,"\\vmatrix":!0,"\\bmatrix":!0,"\\cancel":!0,"\\sqrt":!0};for(let t in this.operatorWithSuperAndSubscriptBackslashed)this.recognizedCommandsKeyInput[t]=!0;for(let t in this.operatorsWithSubscriptBackslashed)this.recognizedCommandsKeyInput[t]=!0;for(let t in this.latexBackslashOperatorsBackslashed)this.recognizedCommandsKeyInput[t]=!0;for(let t in this.latexBackslashAtomsEditableBackslashed)this.recognizedCommandsKeyInput[t]=!0}computeUtf16ToLatexMap(){if(null===this.utf16ToLatexMap){this.utf16ToLatexMap={};for(let t=32;t<125;t++){let e=String.fromCharCode(t);this.utf16ToLatexMap[e]=e}for(let t in this.whiteSpaceUtf16)this.utf16ToLatexMap[t]=" ";for(let t in this.latexBackslashAtomsEditable){let e=this.latexBackslashAtomsEditable[t];this.utf16ToLatexMap[e]=`\\${t} `}for(let t in this.latexBackslashOperators){let e=this.latexBackslashOperators[t];this.utf16ToLatexMap[e]=`\\${t} `}for(let t in this.operatorWithSuperAndSubscript){let e=this.operatorWithSuperAndSubscript[t];this.utf16ToLatexMap[e]=`\\${t} `}for(let t in this.operatorsWithSubscript){let e=this.operatorsWithSubscript[t];this.utf16ToLatexMap[e]=`\\${t} `}for(let t in this.mathcalEquivalents){let e=this.mathcalEquivalents[t];this.utf16ToLatexMap[e]=`\\mathcal{${t}} `}for(let t in this.mathbbEquivalents){let e=this.mathbbEquivalents[t];this.utf16ToLatexMap[e]=`\\mathbb{${t}} `}for(let t in this.operatorsFromUft8)this.utf16ToLatexMap[t]=this.operatorsFromUft8[t]}}convertUtf16ToLatex(t,e){this.computeUtf16ToLatexMap();let i=[];0===e&&i.push("\\cursor ");for(let n=0;n<t.length;n++){let o="";for(let e=0;e<4&&n+e<t.length;e++)if((o+=t[n+e])in this.utf16ToLatexMap){o=this.utf16ToLatexMap[o],n+=e,i.push(o),o="";break}""!==o&&i.push(o),n+1===e&&i.push("\\cursor ")}return new w(i.join(""))}isCharacterReplacingSelection(t){return t in this.characterReplacingSelection}isLatinCharacter(t){return t in this.latinCharacters}isDigit(t){return t in this.digits}isWhiteSpace(t){return t in this.whiteSpaceCharactersIgnored}isWhiteSpaceIgnored(t){return t in this.whiteSpaceCharactersIgnored&&this.whiteSpaceCharactersIgnored[t]}normalizeOperatorToUtf8(t){return t in this.operatorsNormalized?this.operatorsNormalized[t]:t}};class m{constructor(t,e){this.equationEditor=t,this.latex=e,this.result=new T(t,r.horizontalMath),this.words=[],this.parsingStack=[],this.dummyParsingElements=6,this.debug=!1,this.reductionLog=[],this.lastRuleName="",this.startTime=0,this.cursorFound=!1}initialize(){this.parsingStack=[];for(let t=0;t<this.dummyParsingElements;t++)this.parsingStack.push(new c(null,"",""))}parseWords(){let t=[];for(let e=0;e<this.latex.length;e++){let i=this.latex[e];p.isLatinCharacter(i)?t.push(i):(t.length>0&&this.words.push(t.join("")),this.words.push(i),t=[])}t.length>0&&this.words.push(t.join(""))}parse(){this.startTime=(new Date).getTime(),this.initialize(),this.parseWords(),this.result=new T(this.equationEditor,r.horizontalMath);let t=Rt.horizontalMath(this.equationEditor,null);this.parsingStack.push(new c(t,"",""));for(let t=0;t<this.words.length;t++)if(!this.reduceStack(new c(null,this.words[t],"")))return this.constructError();if(!this.reduceStack(new c(null,"","parsingEnd")))return this.constructError();if(this.parsingStack.length!==this.dummyParsingElements+2)return null!==this.equationEditor.options.debugLogContainer&&console.log(`Failed to parse ${this.latex}: not all syntactic elements were reduced.`),this.constructError();let e=this.parsingStack[this.parsingStack.length-2];if(null===e.node)return null!==this.equationEditor.options.debugLogContainer&&console.log(`Failed to parse ${this.latex}: final syntactic element is not a node.`),this.constructError();let i=(new Date).getTime()-this.startTime;return i>200&&this.equationEditor.options.logTiming&&console.log(`Parsing took too long: ${i}ms`),e.node.normalizeHorizontalMathRecursive(),this.equationEditor.options.editable&&e.node.ensureEditableAtomsRecursive(),i>200&&this.equationEditor.options.logTiming&&console.log(`Normalization+parsing took too long: ${i}ms`),e.node}constructError(){let t=Rt.error(this.equationEditor,this.latex),e=Rt.atom(this.equationEditor,""),i=Rt.atom(this.equationEditor,"");return Rt.horizontalMathFromArray(this.equationEditor,[e,t,i])}reduceStack(t){let e=0,i=this.parsingStack.length;for(this.parsingStack.push(t),this.debug&&(this.reductionLog.push(this.toHtmlStackDebug("append")),this.lastRuleName="");this.applyOneRule();){this.debug&&(this.reductionLog.push(this.toHtmlStackDebug(this.lastRuleName)),this.lastRuleName=""),e++;let t=i-this.parsingStack.length;if(e>Math.max(10,10*t))return console.log("Too many parsing rule applications."),!1}return!0}decreaseParsingStack(t){return this.parsingStack.length=this.parsingStack.length-t,!0}replaceParsingStackTop(t,e,i){return this.replaceParsingStackRange(t,e,i,-1)}replaceParsingStackRange(t,e,i,n){i<0&&(i+=this.parsingStack.length),n<0&&(n+=this.parsingStack.length);let o=new c(t,"",e);this.parsingStack[i]=o;let s=n-i;for(let t=n+1;t<this.parsingStack.length;t++)this.parsingStack[t-s]=this.parsingStack[t];return this.parsingStack.length-=s,!0}toHtmlStackDebug(t){let e=[];for(let t=this.dummyParsingElements;t<this.parsingStack.length;t++){let i=this.parsingStack[t].toHtmlDebugData();for(let t=0;t<i.length;t++)e.push(i[t])}return e.push(document.createTextNode(` [${t}]`)),e}toHtmlDebug(){let t=[];for(let e=0;e<this.reductionLog.length;e++){for(let i=0;i<this.reductionLog[e].length;i++)t.push(this.reductionLog[e][i]);t.push(document.createElement("hr"))}return t}specialFont(t){let e=this.parsingStack[this.parsingStack.length-1];if(p.isLatinCharacter(e.content)){if(!(e.content in t))return!1;this.lastRuleName="special font";let i=Rt.atom(this.equationEditor,t[e.content]);return this.replaceParsingStackTop(i,"",-2)}if(!e.isExpression()||e.node.type.type!==r.horizontalMath.type)return!1;if(1!==e.node.children.length)return!1;let i=e.node.children[0].contentIfAtom();if(!(i in t))return!1;this.lastRuleName="special font horizontal math";let n=Rt.atom(this.equationEditor,t[i]);return this.replaceParsingStackTop(n,"",-2)}applyOneRule(){let t=this.parsingStack[this.parsingStack.length-1];if(p.isWhiteSpace(t.content)){if(p.isWhiteSpaceIgnored(t.content))return this.lastRuleName="clean whitespace",this.parsingStack.length=this.parsingStack.length-1,!0;{this.lastRuleName="create whitespace";let t=Rt.atom(this.equationEditor," ");return this.replaceParsingStackTop(t,"",-1)}}if(t.content in p.latexSyntacticValues)return this.lastRuleName="built-in syntactic element",this.replaceParsingStackTop(null,p.latexSyntacticValues[t.content],-1);let e=this.parsingStack[this.parsingStack.length-2];if("\\"===e.syntacticRole){if("\\"===t.syntacticRole)return this.lastRuleName="double backslash",this.replaceParsingStackTop(null,"\\\\",-2);if("{"===t.syntacticRole)return this.lastRuleName="{ delimiter",this.replaceParsingStackTop(null,"\\{",-2);if("}"===t.syntacticRole)return this.lastRuleName="} delimiter",this.replaceParsingStackTop(null,"\\}",-2)}let i=this.parsingStack[this.parsingStack.length-3],n=this.parsingStack[this.parsingStack.length-4];if("{"===e.syntacticRole&&t.isExpression()&&t.node.type.type!==r.horizontalMath.type){this.lastRuleName="horizontal math after curly brace";let e=Rt.horizontalMath(this.equationEditor,t.node);return this.replaceParsingStackTop(e,"",-1)}if("{"===i.syntacticRole&&e.isExpression()&&"}"===t.syntacticRole){this.lastRuleName="remove curly braces";let t=e.node;return t.type.type!==r.horizontalMath.type&&(t=Rt.horizontalMath(this.equationEditor,t)),this.replaceParsingStackTop(t,"",-3)}if("\\"===e.syntacticRole&&t.content in p.latexBackslashCommands)return this.lastRuleName="latex command",this.replaceParsingStackTop(null,p.latexBackslashCommands[t.content],-2);if("\\left"===e.syntacticRole&&t.syntacticRole in p.leftDelimiters)return this.lastRuleName="\\left combined with left delimiter",this.parsingStack[this.parsingStack.length-2]=t,this.decreaseParsingStack(1);if("\\color"===e.syntacticRole&&t.isExpression()){if(null===e.node)return this.lastRuleName="set color",e.node=t.node,this.decreaseParsingStack(1);{this.lastRuleName="apply color";let i=Rt.genericMathBox(this.equationEditor,t.node);return i.type.colorText=e.node.toLatex(),this.replaceParsingStackTop(i,"",-2)}}if("\\mathbf"===e.syntacticRole&&t.isExpression()){this.lastRuleName="apply bold";let e=Rt.genericMathBox(this.equationEditor,t.node);return e.type.fontWeight="bold",this.replaceParsingStackTop(e,"",-2)}if("\\right"===e.syntacticRole&&t.syntacticRole in p.rightDelimiters)return this.lastRuleName="\\right combined with right delimiter",this.parsingStack[this.parsingStack.length-2]=t,this.decreaseParsingStack(1);if("\\left"===e.syntacticRole&&"."===t.content)return this.replaceParsingStackTop(null,"\\left.",-2);if("\\right"===e.syntacticRole&&"."===t.content)return this.replaceParsingStackTop(null,"\\right.",-2);if("\\mathcal"===e.syntacticRole&&this.specialFont(p.mathcalEquivalents))return!0;if("\\mathfrak"===e.syntacticRole&&this.specialFont(p.mathfrakEquivalents))return!0;if("\\mathbb"===e.syntacticRole&&this.specialFont(p.mathbbEquivalents))return!0;if(t.content in p.latexCommandsIgnored&&"\\"===e.syntacticRole)return this.decreaseParsingStack(2);if("\\"===e.syntacticRole&&t.content in p.operatorWithSuperAndSubscript){this.lastRuleName="operator with superscript and subscript";let e=p.operatorWithSuperAndSubscript[t.content],i=new c(null,e,"operatorWithSuperAndSubscript");return this.parsingStack[this.parsingStack.length-2]=i,this.decreaseParsingStack(1)}if("\\"===e.syntacticRole&&t.content in p.operatorsWithSubscript){this.lastRuleName="operator with subscript";let e=p.operatorsWithSubscript[t.content],i=new c(null,e,"operatorWithSubscript");return this.parsingStack[this.parsingStack.length-2]=i,this.decreaseParsingStack(1)}if("\\overline"===e.syntacticRole&&t.isExpression()){this.lastRuleName="over-line";let e=Rt.overLine(this.equationEditor,t.node);return this.replaceParsingStackTop(e,"",-2)}if("\\overbrace"===n.syntacticRole&&i.isExpression()&&"^"===e.syntacticRole&&t.isExpression()){this.lastRuleName="over-brace";let e=Rt.overBrace(this.equationEditor,i.node,t.node);return this.replaceParsingStackTop(e,"",-4)}if("\\underbrace"===n.syntacticRole&&i.isExpression()&&"_"===e.syntacticRole&&t.isExpression()){this.lastRuleName="under-brace";let e=Rt.underBrace(this.equationEditor,i.node,t.node);return this.replaceParsingStackTop(e,"",-4)}let o=this.parsingStack[this.parsingStack.length-5];if("operatorWithSuperAndSubscript"===o.syntacticRole&&"^"===n.syntacticRole&&i.isExpression()&&"_"===e.syntacticRole&&t.isExpression()){this.lastRuleName="operatorWithSuperAndSubscript combines with super and subscript.";let e=Rt.operatorWithSuperAndSubscript(this.equationEditor,o.content,i.node,t.node);return this.replaceParsingStackTop(e,"",-5)}if("operatorWithSuperAndSubscript"===o.syntacticRole&&"_"===n.syntacticRole&&i.isExpression()&&"^"===e.syntacticRole&&t.isExpression()){this.lastRuleName="operatorWithSuperAndSubscript combines with sub and superscript.";let e=Rt.operatorWithSuperAndSubscript(this.equationEditor,o.content,t.node,i.node);return this.replaceParsingStackTop(e,"",-5)}if("operatorWithSuperAndSubscript"===e.syntacticRole&&"^"!==t.syntacticRole&&"_"!==t.syntacticRole&&"\\"!==t.syntacticRole){this.lastRuleName="operator standalone";let t=Rt.operatorWithSuperAndSubscript(this.equationEditor,e.content,null,null);return this.replaceParsingStackRange(t,"",-2,-2)}if("operatorWithSuperAndSubscript"===n.syntacticRole&&"^"===i.syntacticRole&&e.isExpression()&&"_"!==t.syntacticRole){this.lastRuleName="operator with superscript only";let t=Rt.operatorWithSuperAndSubscript(this.equationEditor,n.content,e.node,null);return this.replaceParsingStackRange(t,"",-4,-2)}if("operatorWithSuperAndSubscript"===n.syntacticRole&&"_"===i.syntacticRole&&e.isExpression()&&"^"!==t.syntacticRole){this.lastRuleName="operator with subscript only (allows superscript)";let t=Rt.operatorWithSuperAndSubscript(this.equationEditor,n.content,null,e.node);return this.replaceParsingStackRange(t,"",-4,-2)}if("operatorWithSubscript"===i.syntacticRole&&"_"===e.syntacticRole&&t.isExpression()){this.lastRuleName="operator with subscript only";let e=Rt.operatorWithSubscript(this.equationEditor,i.content,t.node);return this.replaceParsingStackTop(e,"",-3)}if("\\"===e.syntacticRole&&t.content in p.latexBackslashOperators){this.lastRuleName="atom immutable from backslash";let e=Rt.atomImmutable(this.equationEditor,p.latexBackslashOperators[t.content]);return this.replaceParsingStackTop(e,"",-2)}if("\\"===e.syntacticRole&&t.content in p.latexBackslashAtomsEditable){this.lastRuleName="latex symbol";let e=Rt.atom(this.equationEditor,p.latexBackslashAtomsEditable[t.content]);return this.replaceParsingStackTop(e,"",-2)}if("\\cursor"===t.syntacticRole){this.lastRuleName="cursor location";let t=Rt.atom(this.equationEditor,"");return t.desiredCursorPosition=0,this.replaceParsingStackTop(t,"",-1)}if(("\\begin"===i.syntacticRole||"\\end"===i.syntacticRole)&&"{"===e.syntacticRole&&t.content in p.beginEndEnvironments)return this.lastRuleName="begin or end environment",this.replaceParsingStackTop(null,p.beginEndEnvironments[t.content],-1);if(("\\begin"===n.syntacticRole||"\\end"===n.syntacticRole)&&"{"===i.syntacticRole&&"*"===t.content&&e.syntacticRole+"*"in p.beginEndEnvironments){this.lastRuleName="begin or end environment*";let t=e.syntacticRole+"*";return this.decreaseParsingStack(1),this.replaceParsingStackTop(null,p.beginEndEnvironments[t],-1)}if("\\begin"===n.syntacticRole&&"{"===i.syntacticRole&&e.syntacticRole in p.beginEndEnvironments&&"}"===t.syntacticRole){let t=p.beginEndEnvironments[e.syntacticRole];return this.replaceParsingStackTop(null,`\\begin{${t}}`,-4)}if("\\end"===n.syntacticRole&&"{"===i.syntacticRole&&e.syntacticRole in p.beginEndEnvironments&&"}"===t.syntacticRole){let t=p.beginEndEnvironments[e.syntacticRole];return this.replaceParsingStackTop(null,`\\end{${t}}`,-4)}if("\\begin{pmatrix}"===t.syntacticRole){this.lastRuleName="begin pmatrix to matrix builder";let t=Rt.matrix(this.equationEditor,1,0,"","pmatrix");return this.replaceParsingStackTop(t,"matrixBuilder",-1)}if("\\begin{matrix}"===t.syntacticRole||"\\begin{align}"===t.syntacticRole||"\\begin{align*}"===t.syntacticRole){this.lastRuleName="begin matrix to matrix builder";let e="\\begin{matrix}"===t.syntacticRole?"matrix":"align",i="matrix"===e?"":"rl",n=Rt.matrix(this.equationEditor,1,0,i,e);return this.replaceParsingStackTop(n,"matrixBuilder",-1)}if("\\begin{bmatrix}"===t.syntacticRole){this.lastRuleName="begin bmatrix to matrix builder";let t=Rt.matrix(this.equationEditor,1,0,"","bmatrix");return this.replaceParsingStackTop(t,"matrixBuilder",-1)}if("\\begin{vmatrix}"===t.syntacticRole){this.lastRuleName="begin vmatrix to matrix builder";let t=Rt.matrix(this.equationEditor,1,0,"","vmatrix");return this.replaceParsingStackTop(t,"matrixBuilder",-1)}if("\\begin{cases}"===t.syntacticRole){this.lastRuleName="begin cases to matrix builder";let t=Rt.matrix(this.equationEditor,1,0,"","cases");return this.replaceParsingStackTop(t,"matrixBuilder",-1)}if("matrixBuilder"===e.syntacticRole&&"\\hline"===t.syntacticRole){return this.lastRuleName="matrixBuilder hline",e.node.appendHorizontalAboveLastRow(),this.decreaseParsingStack(1)}if("\\begin{array}"===n.syntacticRole&&"{"===i.syntacticRole&&e.isExpression()&&"|"===t.syntacticRole&&e.node.type.type===r.horizontalMath.type)return e.node.appendChild(Rt.atom(this.equationEditor,t.syntacticRole)),this.decreaseParsingStack(1);if("\\begin{array}"===e.syntacticRole&&t.isExpression()){this.lastRuleName="begin array to matrix builder";let e=Rt.matrix(this.equationEditor,1,0,t.node.toLatex(),"array");return this.replaceParsingStackTop(e,"matrixBuilder",-2)}if("matrixBuilder"===i.syntacticRole&&e.isExpression()&&"&"===t.syntacticRole){let t=Rt.matrixRowEntry(this.equationEditor,e.node);return i.node.getLastMatrixRow().appendChild(t),this.decreaseParsingStack(2)}if("matrixBuilder"===e.syntacticRole&&"&"===t.syntacticRole){this.lastRuleName="matrix builder ampersand";let t=Rt.matrixRowEntry(this.equationEditor,Rt.atom(this.equationEditor,""));return e.node.getLastMatrixRow().appendChild(t),this.decreaseParsingStack(1)}if("\\\\"===t.syntacticRole&&e.isExpression()&&"matrixBuilder"===i.syntacticRole){this.lastRuleName="matrix builder expression double backslash";let t=i.node.getLastMatrixRow(),n=Rt.matrixRowEntry(this.equationEditor,e.node);t.appendChild(n);let o=Rt.matrixRow(this.equationEditor,0);return t.parent.appendChild(o),this.decreaseParsingStack(2)}if("\\\\"===t.syntacticRole&&"matrixBuilder"===e.syntacticRole){this.lastRuleName="matrix builder double backslash";let t=e.node.getLastMatrixRow(),i=Rt.matrixRowEntry(this.equationEditor,Rt.atom(this.equationEditor,""));t.appendChild(i);let n=Rt.matrixRow(this.equationEditor,0);return t.parent.appendChild(n),this.decreaseParsingStack(1)}if("\\\\"===t.syntacticRole)return this.lastRuleName="remove double backslash",this.decreaseParsingStack(1);if("matrixBuilder"===i.syntacticRole&&e.isExpression()&&t.isMatrixEnder()){let t=Rt.matrixRowEntry(this.equationEditor,e.node),n=i.node;return n.getLastMatrixRow().appendChild(t),n.normalizeMatrix(),new Ct(n.latexExtraStyle).applyStyleToMatrix(n),i.syntacticRole="",this.lastRuleName="finalize matrix builder",this.decreaseParsingStack(2)}if("matrixBuilder"===e.syntacticRole&&t.isMatrixEnder()){return this.lastRuleName="finish matrix",e.node.normalizeMatrix(),new Ct(e.node.latexExtraStyle).applyStyleToMatrix(e.node),e.syntacticRole="",this.decreaseParsingStack(1)}if("\\sqrt"===e.syntacticRole&&t.isExpression()){this.lastRuleName="Square root";let i=Rt.sqrt(this.equationEditor,t.node,e.node);return this.replaceParsingStackTop(i,"",-2)}if("\\cancel"===e.syntacticRole&&t.isExpression()){this.lastRuleName="cancel expression";let e=Rt.cancel(this.equationEditor,t.node);return this.replaceParsingStackTop(e,"",-2)}if("\\formInput"===e.syntacticRole&&t.isExpression()&&!this.equationEditor.options.editable){this.lastRuleName="form input";let e=Rt.formInput(this.equationEditor,t.node.toLatex());return this.replaceParsingStackTop(e,"",-2)}if("{"===e.syntacticRole&&"}"===t.syntacticRole){this.lastRuleName="{} to empty atom";let t=Rt.atom(this.equationEditor,"");return this.replaceParsingStackTop(t,"",-2)}if("\\sqrt"===n.syntacticRole&&null===n.node&&"["===i.syntacticRole&&e.isExpression()&&"]"===t.syntacticRole)return this.lastRuleName="nth radical",n.node=e.node,this.decreaseParsingStack(3);if(e.isExpression()&&this.areMatchingDelimiters(i,t)){this.lastRuleName="parenthetic expression to expression";let n=p.leftDelimiters[i.syntacticRole],o=p.rightDelimiters[t.syntacticRole],s=Rt.leftDelimiter(this.equationEditor,n,!1),r=Rt.rightDelimiter(this.equationEditor,o,!1),l=Rt.horizontalMathFromArray(this.equationEditor,[s,e.node,r]);return this.replaceParsingStackTop(l,"",-3)}if(e.syntacticRole in p.leftDelimiters&&t.syntacticRole in p.rightDelimiters){this.lastRuleName="parenthetic expression to expression";let i=p.leftDelimiters[e.syntacticRole],n=p.rightDelimiters[t.syntacticRole],o=Rt.leftDelimiter(this.equationEditor,i,!1),s=Rt.rightDelimiter(this.equationEditor,n,!1),r=Rt.atom(this.equationEditor,"​"),l=Rt.horizontalMathFromArray(this.equationEditor,[o,r,s]);return this.replaceParsingStackTop(l,"",-2)}if(t.isExpression()&&"_"===e.syntacticRole&&i.isExpression()){this.lastRuleName="make subscript";let e=Rt.baseWithSubscript(this.equationEditor,i.node,t.node);return this.replaceParsingStackTop(e,"",-3)}if("\\frac"===i.syntacticRole&&e.isExpression()&&t.isExpression()){let i=Rt.fraction(this.equationEditor,e.node,t.node);return this.replaceParsingStackTop(i,"",-3)}if(t.isExpression()&&e.isExpression()&&p.isDigit(t.node.contentIfAtom())&&e.node.type.type===r.horizontalMath.type&&e.node.children.length>0&&p.isDigit(e.node.children[e.node.children.length-1].contentIfAtom()))return this.lastRuleName="merge digits into horizontal math",e.node.appendChild(t.node),this.decreaseParsingStack(1);if(t.isExpression()&&e.isExpression()&&p.isDigit(t.node.contentIfAtom())&&p.isDigit(e.node.contentIfAtom())){this.lastRuleName="merge two digits";let i=Rt.horizontalMath(this.equationEditor,e.node);return i.appendChild(t.node),this.replaceParsingStackTop(i,"",-2)}if(i.isExpression()&&"^"===e.syntacticRole&&t.isExpression()){this.lastRuleName="make exponent";let e=Rt.baseWithExponent(this.equationEditor,i.node,t.node);return this.replaceParsingStackTop(e,"",-3)}if("\\binom"===i.syntacticRole&&e.isExpression()&&t.isExpression()){let i=Rt.matrix(this.equationEditor,2,1,"","binom");return i.getMatrixCell(0,0).children[0].appendChild(e.node),i.getMatrixCell(1,0).children[0].appendChild(t.node),this.replaceParsingStackTop(i,"",-3)}if("\\stackrel"===i.syntacticRole&&e.isExpression()&&t.isExpression()){let i=Rt.matrix(this.equationEditor,3,1,"","stackrel");return i.getMatrixCell(0,0).children[0].appendChild(e.node),i.getMatrixCell(1,0).children[0].appendChild(t.node),i.getMatrixCell(2,0).children[0].appendChild(Rt.atom(this.equationEditor," ")),i.children[0].replaceChildAtPosition(0,Rt.leftDelimiter(this.equationEditor,"",!1)),i.children[0].replaceChildAtPosition(2,Rt.rightDelimiter(this.equationEditor,"",!1)),this.replaceParsingStackTop(i,"",-3)}if(t.content in p.operatorsNormalized){this.lastRuleName="atom immutable";let e=Rt.atomImmutable(this.equationEditor,p.operatorsNormalized[t.content]);return this.replaceParsingStackTop(e,"",-1)}if(""!==t.content&&""===t.syntacticRole&&null===t.node){this.lastRuleName="construct atom";let e=Rt.atom(this.equationEditor,t.content);return this.replaceParsingStackTop(e,"",-1)}if(i.isExpression()&&e.isExpression()&&"^"!==t.syntacticRole&&"_"!==t.syntacticRole){if(i.node.type.type===r.horizontalMath.type)return this.lastRuleName="merge node into horizontal math",i.node.appendChild(e.node),this.replaceParsingStackRange(i.node,"",-3,-2);{this.lastRuleName="merge expressions nodes into horizontal math";let t=Rt.horizontalMathFromArray(this.equationEditor,[i.node,e.node]);return this.replaceParsingStackRange(t,"",-3,-2)}}return!1}areMatchingDelimiters(t,e){return t.syntacticRole in p.leftDelimiters&&e.syntacticRole in p.rightDelimiters&&("|"!==t.syntacticRole&&"|"!==e.syntacticRole||t.syntacticRole===e.syntacticRole)}}class g{constructor(t){if(this.editable=t.editable,this.removeDisplayStyle=t.removeDisplayStyle,this.sanitizeLatexSource=t.sanitizeLatexSource,this.debugLogContainer=t.debugLogContainer,this.latexInput=t.latexInput,this.logTiming=t.logTiming,this.lineBreakWidth=0,this.copyButton=!1,null===t.lineBreakWidth&&void 0===t.lineBreakWidth||(this.lineBreakWidth=t.lineBreakWidth),this.editHandler=t.editHandler,void 0===this.editable&&(this.editable=!0),void 0===this.removeDisplayStyle&&(this.removeDisplayStyle=!1),void 0===this.sanitizeLatexSource&&(this.sanitizeLatexSource=!1),void 0===this.debugLogContainer&&(this.debugLogContainer=null),void 0===this.latexInput&&(this.latexInput=null),void 0===this.editHandler&&(this.editHandler=null),void 0===this.logTiming&&(this.logTiming=!1),!0===t.copyButton&&(this.copyButton=!0),this.highlightStyle={backgroundColor:"#f0f0f0",outline:"1px dashed black"},void 0!==t.highlightStyle&&null!==t.highlightStyle&&(null!==this.highlightStyle.backgroundColor&&void 0!==this.highlightStyle.backgroundColor&&(this.highlightStyle.backgroundColor=t.highlightStyle.backgroundColor),null!==this.highlightStyle.outline&&void 0!==this.highlightStyle.outline&&(this.highlightStyle.outline=t.highlightStyle.outline)),this.showLatexOnDoubleClick=!this.editable&&!this.copyButton,this.extraKeyHandlers={},void 0!==t.extraKeyHandlers&&null!==t.extraKeyHandlers)for(let e in t.extraKeyHandlers)this.extraKeyHandlers[e]=t.extraKeyHandlers[e]}}class x{constructor(t,e){this.preventDefault=t,this.updateAlignment=e}}class f{constructor(t){this.elements=[],this.lowestIndex=0,this.highestIndex=-1,this.capacity=t}push(t){this.highestIndex++,this.totalElements()>this.capacity&&this.lowestIndex++,this.setElement(this.highestIndex,t)}pop(){if(this.totalElements()<=0)return null;let t=this.indexToCircular(this.highestIndex),e=this.elements[t];return this.highestIndex--,e}setElement(t,e){let i=this.indexToCircular(t);for(let t=this.elements.length;t<=i;t++)this.elements.push("");this.elements[i]=e}indexToCircular(t){return t%this.capacity}get(t){if(t>this.highestIndex||t<this.lowestIndex)return null;let e=this.indexToCircular(t);return e>=this.elements.length?null:this.elements[e]}totalElements(){return this.highestIndex-this.lowestIndex+1}toString(){if(this.totalElements()<=4){let t=[];for(let e=this.lowestIndex;e<=this.highestIndex;e++)t.push(this.get(e));return t.join(", ")}let t=[];for(let e=this.lowestIndex;e<this.lowestIndex+2;e++)t.push(this.get(e));let e=[];for(let t=this.highestIndex-2+1;t<=this.highestIndex;t++)e.push(this.get(t));let i=t.join(", "),n=e.join(", ");return`${i} ...(${this.totalElements()-4} omitted)...${n}`}}class b{constructor(){this.lastFocused=null,this.lastSelectionStart=new l(null,-1),this.lastSelectionStartExpanded=new l(null,-1),this.lastSelectionEnd=new l(null,-1),this.lastSelectionEndExpanded=new l(null,-1)}setLastFocused(t){this.lastFocused=t}setLastSelection(t){this.lastSelectionStart.assign(t.selectionStart),this.lastSelectionStartExpanded.assign(t.selectionStartExpanded),this.lastSelectionEnd.assign(t.selectionEnd),this.lastSelectionEndExpanded.assign(t.selectionEndExpanded)}restoreSelection(t){t.selectionStart.assign(this.lastSelectionStart),t.selectionStartExpanded.assign(this.lastSelectionStartExpanded),t.selectionEnd.assign(this.lastSelectionEnd),t.selectionEndExpanded.assign(this.lastSelectionEndExpanded)}toHtmlDebugData(){let t=[];return null===this.lastFocused?t:(t.push(document.createElement("br")),t.push(document.createTextNode(`Last focused: ${this.lastFocused.toString()}, position: ${this.lastFocused.positionCursorBeforeKeyEvents}`)),this.lastFocused.isDetached()&&(t.push(document.createElement("br")),t.push(d("Detached last focused.","red"))),t)}}class y{constructor(t){this.equationEditor=t,this.button=null,this.container=null}initialize(){this.container=document.createElement("span"),this.button=document.createElement("button"),this.container.style.fontSize="6px",this.button.style.fontSize="6px",this.container.appendChild(this.button),this.button.style.opacity="0",this.button.style.transition="all 1s",this.equationEditor.container.addEventListener("mouseover",()=>{this.button.style.opacity="1"}),this.equationEditor.container.addEventListener("mouseleave",()=>{this.button.style.opacity="0"}),this.button.addEventListener("click",()=>{this.copy()}),this.button.textContent="📋",this.button.style.cursor="pointer",this.container.style.position="absolute",this.container.style.left="0px",this.container.style.top="-15px",this.container.style.paddingRight="-100px",this.container.style.marginRight="-100px",this.container.style.boxSizing="border-box",this.equationEditor.container.appendChild(this.container)}copy(){this.equationEditor.copyToClipboard(),this.equationEditor.container.style.transition="all 1s",this.equationEditor.container.style.backgroundColor="lightgreen",setTimeout(()=>{this.equationEditor.container.style.backgroundColor="",setTimeout(()=>{this.equationEditor.container.style.transition=""},1e3)},1e3)}}class B{constructor(t,e,i){this.container=t,this.containerSVG=i,void 0===this.containerSVG&&(this.containerSVG=null),this.containerCanvas=null,this.canvasTwoDContext=null,this.canvasPosition=[0,0],this.options=new g({editable:!0}),null!=e&&(this.options=e),this.latexContainer=null,this.initializeContainer(this.container),this.initializeContainer(this.containerSVG),this.containerDesiredHeight=0,this.containerDesiredWidth=0,this.rootNode=Rt.rootMath(this),this.options.editable||(this.rootNode.type.borderStyle="",this.rootNode.type.padding="",this.rootNode.type.margin="",this.rootNode.type.cursor="",this.rootNode.type.minWidth=""),this.pendingWriteLatex=!1,this.observer=null,this.preventEditorBlur=!1,this.mouseSelectionStarted=!1,this.selectionNoMoreDefault=!1,this.mouseIgnoreNextClick=!1,this.mouseSelectionVisible=!1,this.selectionStart=new l(null,-1),this.selectionStartExpanded=new l(null,-1),this.selectionEnd=new l(null,-1),this.selectionEndExpanded=new l(null,-1),this.latexLastWritten="",this.latexLastEdit="",this.latexLastEditWithCursor="",this.history=new f(5e3),this.redoBuffer=[],this.backslashSequenceStarted=!1,this.backslashSequence="",this.backslashPosition=-1,this.positionDebugString="",this.fontFamily="",this.hasFocusDOM=!1,this.resizingEditorFont=!1,null!==this.options.latexInput&&this.options.latexInput.addEventListener("keyup",t=>{this.writeLatexFromInput()}),this.focusInformation=new b,this.lastSelectionAction="",this.standardAtomHeight=0,this.lastCopied="",this.eventCatcher=null,this.prepareEventCatcher(),this.copyButtonContainer=null,this.prepareCopyButton()}initializeContainer(t){null!==t&&(t.style.display="inline-block",t.style.position="relative",t.textContent="",this.options.editable&&(t.style.margin="2px",t.style.padding="2px"))}getFontFamily(){return""===this.fontFamily&&(this.fontFamily=this.container.style.fontFamily),this.fontFamily}focusEventCatcher(){return null!==this.eventCatcher.element&&(this.eventCatcher.element.focus(),!0)}focusRestore(){this.rootNode.focusRestore()||this.resetSelectionFocusBestChoice()}undo(){if(this.history.totalElements()<=0)return;this.redoBuffer.push(this.latexLastEditWithCursor);let t=this.history.pop();this.writeLatex(t),this.latexLastEditWithCursor=t,this.latexLastEdit=this.rootNode.toLatexWithAnnotation(null).latex,this.focusRestore()}redo(){if(0===this.redoBuffer.length)return;let t=this.redoBuffer.pop();this.writeLatex(t),this.writeLatexToInput(!1),this.focusRestore()}pasteFromClipboard(){return this.hasSelection()&&this.selectionEscapedOriginalAtom()?(navigator.clipboard.readText().then(t=>{this.deleteSelection(t)}),new x(!0,!0)):new x(!1,!1)}copyToClipboard(){if(null===this.selectionEndExpanded.element||null===this.selectionStartExpanded.element)return this.options.editable?this.doCopy(this.rootNode.toLatexWithAnnotation(null).latex):this.doCopy(this.latexLastWritten);let t=this.selectionStartExpanded.element,e=this.selectionEndExpanded.element;if(e.isToTheLeftOf(t)){let i=e;e=t,t=i}t=t.beefUpToHorizontalParent(),e=e.beefUpToHorizontalParent();let i=[],n=t;for(;(i.push(n.toLatexWithAnnotation(null).latex),n!==e)&&null!==(n=n.horizontalSibling(1)););let o=i.join("");return this.doCopy(o)}doCopy(t){return this.lastCopied=t,navigator.clipboard.writeText(t),this.writeDebugInfo(null),t}computeStandardAtomHeight(){this.eventCatcher.initialContent=" ",this.eventCatcher.element=document.createElement("div"),this.eventCatcher.element.textContent=this.eventCatcher.initialContent,this.container.appendChild(this.eventCatcher.element);let t=this.eventCatcher.element.getBoundingClientRect();this.standardAtomHeight=t.height,this.container.removeChild(this.eventCatcher.element),this.eventCatcher.element=null}prepareCopyButton(){this.options.copyButton&&(this.copyButtonContainer=new y(this),this.copyButtonContainer.initialize())}prepareEventCatcher(){this.eventCatcher=new T(this,r.eventCatcher),this.computeStandardAtomHeight(),this.options.editable&&(this.eventCatcher.createDOMElementIfMissing(),this.container.appendChild(this.eventCatcher.element),this.eventCatcher.element.style.position="absolute",this.eventCatcher.element.style.left="",this.eventCatcher.element.style.top="",this.eventCatcher.element.addEventListener("copy",t=>{this.copyToClipboard()}),this.eventCatcher.element.addEventListener("paste",t=>{this.pasteFromClipboard()}),this.eventCatcher.element.addEventListener("keydown",t=>{this.handleKeyDownCatchAll(t)}),this.container.addEventListener("keydown",t=>{this.handleKeyDownCatchAll(t)}),this.eventCatcher.element.addEventListener("blur",t=>{this.blur()}))}resetSelectionDOM(){try{window.getSelection().removeAllRanges()}catch(t){console.log(`Failed to remove all ranges ${t}`)}}resetSelectionFullSelectEventCatcher(){this.resetSelectionLeaveRangesIntact(),this.resetSelectionDOMSelectEventCatcher()}resetSelectionDOMSelectEventCatcher(){this.resetSelectionDOM();let t=document.createRange();t.setStart(this.eventCatcher.element,0),t.setEnd(this.eventCatcher.element,0),window.getSelection().addRange(t),this.eventCatcher.focus(1)}storeSelection(){this.focusInformation.setLastSelection(this)}updateDOM(){this.rootNode.updateDOM()}writeSVG(){if(null===this.containerSVG)return;this.containerSVG.textContent="";let t=(new M).typeset(this.rootNode);t.style.display="inline-block",t.style.position="absolute",t.style.left=`${this.rootNode.boundingBox.left}px`,t.style.top=`${this.rootNode.boundingBox.top}px`,this.containerSVG.appendChild(t),this.containerSVG.style.width=this.containerDesiredWidth,this.containerSVG.style.height=this.containerDesiredHeight,this.rootNode.boundingBox.needsMiddleAlignment?this.containerSVG.style.verticalAlign="middle":this.containerSVG.style.verticalAlign="text-bottom"}drawOnCanvas(){this.drawOnCanvasAtLocation([0,0])}drawOnCanvasAtLocation(t){if(null===this.containerCanvas&&null===this.canvasTwoDContext)return;if(null===this.canvasTwoDContext&&(this.canvasTwoDContext=this.containerCanvas.getContext("2d")),null!==this.containerCanvas){let t=this.containerCanvas.getBoundingClientRect();this.canvasTwoDContext.clearRect(0,0,t.width,t.height)}let e=new C;e.left=t[0],e.top=t[1],this.rootNode.drawOnCanvas(this.canvasTwoDContext,e),null!==this.containerCanvas&&this.canvasTwoDContext.stroke()}writeDebugInfo(t){if(null===this.options.debugLogContainer)return;let e=[];if(null!==t){let i=t.toHtmlDebug();for(let t=0;t<i.length;t++)e.push(i[t]);e.push(document.createElement("hr"))}let i=this.toHtmlDebugData();for(let t=0;t<i.length;t++)e.push(i[t]);this.options.debugLogContainer.textContent="";for(let t=0;t<e.length;t++)this.options.debugLogContainer.appendChild(e[t])}writeLatexToInput(t){if(this.backslashSequenceStarted)return;let e=this.rootNode.toLatexWithAnnotation(null);this.latexLastEdit!==e.latex&&(t&&(this.redoBuffer=[]),this.history.push(this.latexLastEditWithCursor),this.latexLastEditWithCursor=this.rootNode.toLatexWithAnnotation(u).latex,this.latexLastEdit=e.latex,null!==this.options.latexInput&&(this.options.latexInput.value=e.latex))}writeLatexFromInput(){if(null===this.options.latexInput)return;let t=this.options.latexInput.value;this.writeLatex(t)}writeLatex(t){if(null===this.container)throw new Error("Attempt to write to non-initialized equation editor.");null===this.observer&&(this.observer=new IntersectionObserver((e,i)=>{this.writeLatexPartTwo(t)},{root:document.documentElement}),this.observer.observe(this.container)),this.pendingWriteLatex=!0,""===this.container.style.minWidth&&(this.container.style.minWidth="1px"),this.writeLatexPartTwo(t)}writeLatexPartTwo(t){if(!0!==this.pendingWriteLatex)return!1;if(0===this.container.getBoundingClientRect().width)return!1;this.pendingWriteLatex=!1,this.latexLastWritten=t,this.rootNode.removeAllChildren(),null!==this.rootNode.element&&(this.rootNode.element.textContent="");let e=new m(this,t);null!==this.options.debugLogContainer&&(e.debug=!0);let i=e.parse();return null===i?(this.writeDebugInfo(e),console.log(`Failed to construct node from your input ${t}.`),!1):(this.rootNode.appendChild(i),this.updateDOM(),this.updateAlignment(),this.writeSVG(),null!==this.containerCanvas&&this.drawOnCanvas(),this.writeDebugInfo(e),this.container.setAttribute("latexsource",t),null!==this.containerSVG&&this.containerSVG.setAttribute("latexsource",t),this.setLastFocused(this.rootNode.rightmostAtomChild()),!0)}writeLatexLastFocused(t){if(null===this.focusInformation.lastFocused){let e=this.rootNode.rightmostAtomChild();return null===e?void console.log("Unexpected failure to find atom child."):(e.positionCursorBeforeKeyEvents=e.textContentOrInitialContent().length,e.writeLatex(t),void this.writeLatexToInput(!1))}let e=this.focusInformation.lastFocused;this.focusInformation.lastFocused=null,e.writeLatex(t),this.writeLatexToInput(!1)}accountFrameTime(t){let e=(new Date).getTime()-t;e>100&&console.log(`Warning: last equation editor frame took a full ${e}ms.`)}setLastFocused(t){this.focusInformation.setLastFocused(t)}toHtmlDebugData(){let t=this.rootNode.toLatexWithAnnotation(null),e=[];e.push(document.createTextNode(`Latex: ${t.latex}`));let i=t.latex.split("\\").join("\\\\");e.push(document.createTextNode(`Latex, backslash-escaped: ${i}`)),e.push(document.createElement("br")),e.push(document.createTextNode(`URL-encoded: ${encodeURIComponent(t.latex)}`)),""!==this.lastCopied&&(e.push(document.createElement("br")),e.push(document.createTextNode(`Last copied: ${this.lastCopied}`)));let n=this.focusInformation.toHtmlDebugData();for(let t=0;t<n.length;t++)e.push(n[t]);e.push(document.createElement("br")),e.push(document.createTextNode(`History: ${this.toStringHistory()}`)),""!==this.lastSelectionAction&&(e.push(document.createElement("br")),e.push(document.createTextNode(`Last selection action: ${this.lastSelectionAction}`))),e.push(document.createElement("br")),e.push(document.createTextNode(this.toStringSelection())),e.push(document.createElement("br")),e.push(document.createTextNode("Structure: "));let o=this.rootNode.toHtmlDebugData(0);for(let t=0;t<o.length;t++)e.push(document.createElement("br")),e.push(o[t]);return e.push(document.createElement("br")),e.push(document.createTextNode(`Backslash position: ${this.backslashPosition}; started: ${this.backslashSequenceStarted}, sequence: ${this.backslashSequence}.`)),e.push(document.createElement("br")),e.push(document.createTextNode(`Position computation string: ${this.positionDebugString}.`)),e}toStringHistory(){let t=this.history.toString();return this.redoBuffer.length>0&&(t+=`<br>Redo buffer: ${this.redoBuffer.join(", ")}`),t}dispatchKey(t){let e=this.restoreSelectionOrFocusBestChoice();this.dispatchKeyToNode(e,t)}dispatchKeyToNode(t,e){if(null===t)return;if("ArrowLeft"===e&&t.positionCursorBeforeKeyEvents>0)return void t.focus(0);let i=new KeyboardEvent("keydown",{key:e});t!==this.eventCatcher?t.handleKeyDownDontComputeCursorPosition(i):this.handleKeyDownCatchAll(i)}getLastFocused(){return null===this.focusInformation.lastFocused?this.rootNode.rightmostAtomChild():this.focusInformation.lastFocused.isDetached()?this.rootNode.rightmostAtomChild():this.focusInformation.lastFocused}arrowShiftHeld(t,e){this.initializeSelectionStart(t);let i=this.computeSelectionEndFromShiftKey(e);return new x(i,i)}restoreSelectionOrFocusBestChoice(){return this.hasSelection()?(this.eventCatcher.focus(0),this.eventCatcher):this.resetSelectionFocusBestChoice()}resetSelectionFocusBestChoice(){if(this.hasSelection()){let t=this.selectionEndExpanded.element,e=-1;return this.selectionStartToTheLeftOfSelectionEnd()&&(e=1),this.resetSelectionFullSelectEventCatcher(),t.focus(e),t}let t=this.getLastFocused();this.resetSelectionFullSelectEventCatcher();let e=-1;return t.isAtomEditable()&&(e=t.positionCursorBeforeKeyEvents),t.focus(1),-1!==e&&(t.positionCursorBeforeKeyEvents=e),t}makeSqrtFromSelection(t){if(null===t)return;let e=t.ancestor;e.removeAllChildren();let i=Rt.horizontalMathFromArray(this,t.split);i.ensureEditableAtoms();let n=Rt.sqrt(this,i,null);e.appendChildren(t.beforeSplit),e.appendChild(n),e.appendChildren(t.afterSplit),e.ensureEditableAtoms(),e.updateDOM(),n.children[2].focusStandard(0)}makeFractionNumeratorFromSelection(t){if(null===t)return;let e=t.ancestor;e.removeAllChildren();for(let i=0;i<t.beforeSplit.length;i++)e.appendChild(t.beforeSplit[i]);let i=Rt.horizontalMathFromArray(this,t.split);i.ensureEditableAtoms();let n=Rt.fraction(this,i,null);e.appendChild(n);for(let i=0;i<t.afterSplit.length;i++)e.appendChild(t.afterSplit[i]);e.normalizeHorizontalMath(),e.ensureEditableAtoms(),e.updateDOM(),n.children[1].focus(-1)}shouldDeleteSelection(t){return this.hasSelection()&&this.selectionEscapedOriginalAtom()&&p.isCharacterReplacingSelection(t)}handleControlKeys(t){if(!t.ctrlKey)return new x(!1,!1);switch(t.key){case"Z":return this.redo(),new x(!0,!0);case"z":return this.undo(),new x(!0,!0);case"c":return this.copyToClipboard(),new x(!0,!1);case"x":return this.copyToClipboard(),this.deleteSelection(null);case"v":return this.pasteFromClipboard(),new x(!1,!1);default:return new x(!1,!1)}}handleKeyDownCatchAll(t){t.stopPropagation(),t.preventDefault();let e=t.key;if(t.ctrlKey)this.handleControlKeys(t);else if(this.shouldDeleteSelection(e))this.deleteSelection(e);else switch(e){case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":return t.shiftKey?void this.arrowShiftHeld(this.getLastFocused(),e):void this.resetSelectionFocusBestChoice();case"/":return void this.makeFractionNumeratorFromSelection(this.splitAtomsBySelection());case"\\sqrt":return this.hasSelection()?void this.makeSqrtFromSelection(this.splitAtomsBySelection()):void this.resetSelectionFocusBestChoice().makeSqrt();case"Delete":case"Backspace":return this.hasSelection()?void this.deleteSelection(null):void this.resetSelectionFocusBestChoice();default:return}}hasSelection(){return null!==this.selectionStart.element}selectionEscapedOriginalAtom(){return-1===this.selectionStartExpanded.position}deleteFullSelection(){return this.rootNode.removeAllChildren(),this.rootNode.appendChild(Rt.horizontalMath(this,null)),this.resetSelectionLeaveRangesIntact(),this.updateDOM(),this.rootNode.focus(0),this.writeLatexToInput(!0),this.writeDebugInfo(null),new x(!0,!0)}deleteSelection(t){if(!this.hasSelection())return new x(!1,!1);if(!this.selectionEscapedOriginalAtom())return this.resetSelectionLeaveRangesIntact(),new x(!1,!1);let e=this.selectionStartExpanded.element.beefUpToHorizontalParent();if(e.type.type===r.root.type)return this.deleteFullSelection();let i=e.parent,n=i.parent;if(null===n)return this.deleteFullSelection();let o=this.splitAtomsBySelection();if(null===o)return console.log("Unexpected failure to split by selection"),this.resetSelectionLeaveRangesIntact(),new x(!1,!1);let s=Rt.horizontalMathFromArray(this,o.beforeSplit),l=null;return(l=null!==t?new m(this,t).parse():Rt.atom(this,"")).type.type===r.atom.type?l.desiredCursorPosition=l.textContentOrInitialContent().length:l.desiredCursorPosition=1,s.appendChild(l),s.appendChildren(o.afterSplit),s.normalizeHorizontalMath(),s.ensureEditableAtoms(),n.replaceChildAtPosition(i.indexInParent,s),this.resetSelectionLeaveRangesIntact(),n.updateDOM(),n.focusRestore(),this.writeLatexToInput(!0),this.writeDebugInfo(null),new x(!0,!0)}computeContainerDimensions(){let t=this.rootNode.element.getBoundingClientRect();this.containerDesiredHeight=Math.max(t.height,this.rootNode.boundingBox.height,this.standardAtomHeight),this.options.editable&&(this.containerDesiredHeight+=2),this.containerDesiredWidth=Math.max(t.width,this.rootNode.boundingBox.width)}updateAlignment(){this.rootNode.computeBoundingBox(),this.rootNode.doAlign(),this.computeContainerDimensions(),this.container.style.height=`${this.containerDesiredHeight}px`,this.container.style.width=`${this.containerDesiredWidth}px`,this.rootNode.boundingBox.needsMiddleAlignment&&!this.options.editable?this.container.style.verticalAlign="middle":this.container.style.verticalAlign="sub"}toStringSelection(){if(null===this.selectionStart.element)return"";let t="[expanded selection null]";null!==this.selectionStartExpanded.element&&(t=this.selectionStartExpanded.element.toLatexWithAnnotation(null).latex);let e=this.selectionEnd.element.toLatexWithAnnotation(null).latex,i=`Selection: from: ${this.selectionStartExpanded.toString()} to: ${this.selectionEndExpanded.toString()}.`;return i+=` Actually selected: ${this.selectionStart.toString()} to: ${this.selectionEnd.toString()}.`,i+=` Latex from: ${t} to ${e}`}splitOneAtomBySelection(){if(null===this.selectionStartExpanded.element)return null;if(this.selectionEnd.element!==this.selectionStartExpanded.element||!this.selectionEnd.element.isAtomEditable())return null;let t=this.selectionEnd.element;if(!t.hasHorozintalMathParent())return console.log("Atom has non-horizontal math parent."),null;let e=t.parent,i=new S(e);for(let n=0;n<t.indexInParent;n++)i.beforeSplit.push(e.children[n]);let n=null,o=null,s=null,r=this.selectionStartExpanded.position,l=this.selectionEnd.position;if(l<r){let t=l;l=r,r=t}if(r<0)return console.log("Unexpected negative left position."),null;let h=l-r;if(h<0)return console.log("Unexpected negative shifted right position."),null;let a=t.splitByPosition(r);if(null!==a[0]&&(n=a[0]),null===a[1])return null;let d=a[1].splitByPosition(h);o=d[0],s=d[1],null!==n&&i.beforeSplit.push(n),i.split.push(o),null!==s&&i.afterSplit.push(s);for(let n=t.indexInParent+1;n<e.children.length;n++)i.afterSplit.push(e.children[n]);return i}splitAtomsBySelection(){if(null===this.selectionStartExpanded.element||null===this.selectionEndExpanded.element)return null;let t=this.selectionStartExpanded,e=this.selectionEndExpanded;if(e.element.isToTheLeftOf(t.element)){let i=t;t=e,e=i}if(this.selectionStartExpanded.element===this.selectionEndExpanded.element&&this.selectionStartExpanded.element.isAtomEditable()&&!this.selectionEscapedOriginalAtom())return this.splitOneAtomBySelection();let i=t.element.commonAncestor(e.element);if(null===i)return console.log(`Not expected: no common ancestor element between ${t} and ${e}. `),null;if(i.type.type!==r.horizontalMath.type&&null===(i=i.beefUpToHorizontalParent().parent)){let t=new S(this.rootNode.children[0]);for(let e=0;e<t.ancestor.children.length;e++)t.split.push(t.ancestor.children[e]);return t}if(t.element===i||e.element===i)return null;for(;t.element.parent!==i&&null!==t.element.parent;)t.element=t.element.parent;for(;e.element.parent!==i&&null!==e.element.parent;)e.element=e.element.parent;let n=new S(i);for(let e=0;e<t.element.indexInParent;e++)n.beforeSplit.push(i.children[e]);for(let o=t.element.indexInParent;o<=e.element.indexInParent;o++)n.split.push(i.children[o]);for(let t=e.element.indexInParent+1;t<i.children.length;t++)n.afterSplit.push(i.children[t]);return n}elementFromPath(t){let e=this.rootNode;for(let i=0;i<t.length;i++)e=e.children[t[i]];return e}handleDoubleClick(t){if(!this.options.showLatexOnDoubleClick)return;if(t.preventDefault(),t.stopPropagation(),null!==this.latexContainer)return this.container.removeChild(this.latexContainer),this.latexContainer=null,void(this.container.style.width=this.rootNode.element.style.width);this.latexContainer=document.createElement("SPAN");let e="",i=!1,n=!1;this.rootNode.children[0].type.type===r.error.type?i=!0:this.options.editable||""===this.latexLastWritten||this.options.sanitizeLatexSource||(i=!0,n=!0),e=i?n?this.latexLastWritten.split("\\displaystyle").join(""):this.latexLastWritten:this.rootNode.toLatex(),this.latexContainer.textContent=e,this.latexContainer.style.position="absolute",this.latexContainer.style.left=`${this.rootNode.element.style.width}`,this.latexContainer.style.whiteSpace="nowrap",this.container.appendChild(this.latexContainer);let o=this.rootNode.element.getBoundingClientRect().width+this.latexContainer.getBoundingClientRect().width;this.container.style.width=o;let s=window.getSelection().getRangeAt(0).cloneRange();s.selectNode(this.latexContainer),this.resetSelectionDOM(),window.getSelection().addRange(s)}resetSelectionLeaveRangesIntact(){null!==this.selectionStart.element&&this.rootNode.unSelectMouseRecursive(),this.selectionStart.element=null,this.selectionStart.position=-1,this.selectionEnd.element=null,this.selectionEnd.position=-1,this.selectionStartExpanded.element=null,this.selectionStartExpanded.position=-1,this.mouseSelectionStarted=!1,this.mouseIgnoreNextClick=!1,this.selectionNoMoreDefault=!1,this.mouseSelectionVisible=!1}initializeSelectionStart(t){null!==t&&null===this.selectionStart.element&&(this.resetSelectionLeaveRangesIntact(),this.selectionStart=new l(t,t.positionCursorBeforeKeyEvents),this.selectionEnd=new l(t,t.positionCursorBeforeKeyEvents))}computeNewSelectionFromShiftKey(t){if("ArrowLeft"===t||"ArrowUp"===t){let t=this.selectionStartToTheLeftOfSelectionEnd();return this.selectionEnd.leftHorizontalNeighborBalanced(t)}{let t=!this.selectionStartToTheLeftOfSelectionEnd();return this.selectionEnd.rightHorizontalNeighborBalanced(t)}}computeSelectionEndFromShiftKey(t){let e=this.computeNewSelectionFromShiftKey(t);return null!==e&&(null!==e.element&&(this.selectionEnd=e,setTimeout(()=>{this.selectFromElement(e.element)},0),!!this.selectionNoMoreDefault||e.element!==this.selectionStart.element))}selectFromElement(t){return this.mouseIgnoreNextClick=!0,t!==this.selectionStart.element||this.selectionNoMoreDefault?(this.preventEditorBlur=!0,this.selectionNoMoreDefault=!0,this.resetSelectionDOMSelectEventCatcher(),this.eventCatcher.focus(0),this.selectionStart.position=-1,this.selectionEnd.element=t,this.selectionEnd.position=-1,this.computeSelectionExpanded(),this.highlightSelectionMouse(),null!==this.options.debugLogContainer&&(this.lastSelectionAction=`Mouse move selection above ${t.toString()}.`),this.storeSelection(),this.writeDebugInfo(null),this.preventEditorBlur=!1,!0):(this.selectionStartExpanded.assign(this.selectionStart),this.selectionEnd.element.storeCursorPosition("",!1),this.selectionEnd.position=this.selectionEnd.element.positionCursorBeforeKeyEvents,this.selectionEnd.position===this.selectionStart.position&&0!==this.selectionEnd.element.selectionLength&&(this.selectionEnd.position-=this.selectionEnd.element.selectionLength),this.selectionEndExpanded.assign(this.selectionEnd),this.storeSelection(),this.writeDebugInfo(null),!1)}expandElementForSelection(t,e){let i=t.commonParent(e);if(null===i.parent)return new l(this.rootNode,-1);let n=i.parent.children[i.indexInParent];return new l(n.beefUpToHorizontalParent(),-1)}computeSelectionExpanded(){null!==this.selectionStart.element&&null!==this.selectionEnd.element&&(this.selectionStartExpanded=this.expandElementForSelection(this.selectionStart.element,this.selectionEnd.element),this.selectionEndExpanded=this.expandElementForSelection(this.selectionEnd.element,this.selectionStartExpanded.element),this.balanceSelection())}balanceSelection(){let t=this.selectionStartExpanded.element,e=this.selectionEndExpanded.element,i=t.parent;if(null===i)return;if(i.type.type!==r.horizontalMath.type)return void(i.type.type!==r.root.type&&(console.log("Unexpected: null, non-horizontal parent or different parent."),console.log(`Parent type: ${i.type.type}`),console.log(this.toStringSelection())));let n=t.indexInParent,o=e.indexInParent,s=o<n;if(s){let t=o;o=n,n=t}let l=0,h=0;function a(t){t.type.type===r.rightDelimiter.type?l>0?l--:h++:t.type.type===r.leftDelimiter.type&&l++}for(let t=n;t<=o;t++)a(i.children[t]);for(;l>0||h>0;){if(l>0){if(++o>=i.children.length)return void console.log("Missing right deliimiter");a(i.children[o])}if(h>0){if(--n<0)return void console.log("Missing left delimiter");(d=i.children[n]).type.type===r.leftDelimiter.type?h>0?h--:l++:d.type.type===r.rightDelimiter.type&&h++}}var d;s?(this.selectionStartExpanded.element=i.children[o],this.selectionEndExpanded.element=i.children[n],this.selectionEnd.element=i.children[n]):(this.selectionStartExpanded.element=i.children[n],this.selectionEndExpanded.element=i.children[o],this.selectionEnd.element=i.children[o])}selectionStartToTheLeftOfSelectionEnd(){return null===this.selectionStartExpanded.element||null===this.selectionEnd.element||this.selectionStartExpanded.element.isToTheLeftOf(this.selectionEnd.element)}highlightSelectionMouse(){if(null===this.selectionStartExpanded.element||null===this.selectionEnd.element)return;let t=this.selectionStartExpanded.element,e=this.selectionEndExpanded.element;if(e.isToTheLeftOf(t)){let i=e;e=t,t=i}t=t.beefUpToHorizontalParent(),e=e.beefUpToHorizontalParent();let i=t;for(this.rootNode.unSelectMouseRecursive(),this.rootNode.blurRecursive();(i.selectElementByMouse(),i!==e)&&null!==(i=i.horizontalSibling(1)););}handleMouseMoveSelection(t,e){this.mouseSelectionStarted&&(t.stopPropagation(),this.selectFromElement(e)&&t.preventDefault())}handleMouseSelectionStart(t,e){this.preventEditorBlur=!0,this.hasFocusDOM||(this.eventCatcher.focus(1),this.hasFocusDOM=!0),t.stopPropagation(),e.storeCursorPosition("",!1),this.resetSelectionLeaveRangesIntact(),this.initializeSelectionStart(e),this.resetSelectionDOMSelectEventCatcher(),this.mouseSelectionStarted=!0,this.mouseSelectionVisible=!0,null!==this.options.debugLogContainer&&(this.lastSelectionAction=`Mouse selection start over ${e.toString()}, position:${e.positionCursorBeforeKeyEvents}.`),setTimeout(()=>{e.storeCursorPosition("",!1),this.selectionStart.position=e.positionCursorBeforeKeyEvents,this.writeDebugInfo(null)},0),this.writeDebugInfo(null)}handleMouseSelectionEnd(t){null!==this.options.debugLogContainer&&(this.lastSelectionAction="Mouse selection end."),this.mouseSelectionStarted=!1,this.preventEditorBlur=!1,this.writeDebugInfo(null),t.preventDefault(),t.stopPropagation()}blur(){this.preventEditorBlur||(this.hasFocusDOM=!1,this.backslashSequenceStarted=!1,this.resetSelectionLeaveRangesIntact(),this.rootNode.blurRecursive())}}class S{constructor(t){this.beforeSplit=[],this.afterSplit=[],this.split=[],this.ancestor=t}}class C{constructor(){this.left=0,this.top=0,this.width=0,this.height=0,this.lineHeight=-1,this.fractionLineHeight=0,this.needsMiddleAlignment=!1,this.columnOffsets=[],this.superScriptWidth=0,this.subScriptWidth=0,this.transform="",this.transformOrigin="",this.heightBeforeTransform=-1,this.widthBeforeTransform=-1,this.fontSizeInPixels=0}getColumnOffset(t){return t<0?0:t>=this.columnOffsets.length?this.width:this.columnOffsets[t]}toString(){return`w: ${this.width.toFixed(2)}, h: ${this.height.toFixed(2)}, fl:${this.fractionLineHeight.toFixed(2)}`}}class w{constructor(t){this.latex=t}}class E{constructor(t,e){this.keyAccountedCarryOutDefaultEvent=t,this.command=e}}class T{constructor(t,e){if(!(t instanceof B))throw new Error(`Unexpected equation editor ${t}`);this.children=[],this.type=e.clone(),this.element=null,this.parent=null,this.indexInParent=-1,this.positionCursorBeforeKeyEvents=-1,this.selectionLength=-1,this.desiredCursorPosition=-1,this.initialContent="",this.focused=!1,this.implied=!1,this.selectedByMouse=!1,this.equationEditor=t,this.boundingBox=new C,this.latexExtraStyle="",this.extraData=null}createDOMElementIfMissing(){null===this.element&&(this.type.type===r.formInput.type?this.element=document.createElement("input"):this.element=document.createElement("div"),this.type.type!==r.eventCatcher.type&&this.type.type!==r.atom.type||!this.equationEditor.options.editable||(this.element.contentEditable=!0),this.type.type===r.root.type&&this.equationEditor.options.editable&&(this.element.classList.add("equationeditoreditable"),""===getComputedStyle(this.element).borderWidth&&(this.element.style.borderStyle="solid")),""!==this.type.padding&&(this.element.style.padding=this.type.padding),""!==this.type.paddingBottom&&(this.element.style.paddingBottom=this.type.paddingBottom),""!==this.type.paddingTop&&(this.element.style.paddingTop=this.type.paddingTop),""!==this.type.paddingLeft&&(this.element.style.paddingLeft=this.type.paddingLeft),""!==this.type.paddingRight&&(this.element.style.paddingRight=this.type.paddingRight),""!==this.type.colorText&&(this.element.style.color=this.type.colorText),""!==this.type.margin&&(this.element.style.margin=this.type.margin),""!==this.type.marginBottom&&(this.element.style.marginBottom=this.type.marginBottom),""!==this.type.marginLeft&&(this.element.style.marginLeft=this.type.marginLeft),""!==this.type.marginRight&&(this.element.style.marginRight=this.type.marginRight),""!==this.type.boxSizing&&(this.element.style.boxSizing=this.type.boxSizing),""!==this.type.borderStyle&&(this.element.style.border=this.type.borderStyle),""!==this.type.borderColor&&(this.element.style.borderColor=this.type.borderColor),""!==this.type.borderBottom&&(this.element.style.borderBottom=this.type.borderBottom),""!==this.type.borderTopLeftRadius&&(this.element.style.borderTopLeftRadius=this.type.borderTopLeftRadius),""!==this.type.borderTopRightRadius&&(this.element.style.borderTopRightRadius=this.type.borderTopRightRadius),""!==this.type.borderBottomLeftRadius&&(this.element.style.borderBottomLeftRadius=this.type.borderBottomLeftRadius),""!==this.type.borderBottomRightRadius&&(this.element.style.borderBottomRightRadius=this.type.borderBottomRightRadius),""!==this.type.borderTop&&(this.element.style.borderTop=this.type.borderTop),""!==this.type.borderLeft&&(this.element.style.borderLeft=this.type.borderLeft),""!==this.type.borderRight&&(this.element.style.borderRight=this.type.borderRight),this.element.style.width=this.type.width,this.element.style.height=this.type.height,this.element.style.display=this.type.display,""!==this.type.minWidth&&(this.element.style.minWidth=this.type.minWidth),""!==this.type.overflow&&(this.element.style.overflow=this.type.overflow),this.element.style.verticalAlign=this.type.verticalAlign,this.element.style.outline=this.type.outline,""!==this.type.cursor&&(this.element.style.cursor=this.type.cursor),""!==this.type.textAlign&&(this.element.style.textAlign=this.type.textAlign),""!==this.type.whiteSpace&&(this.element.style.whiteSpace=this.type.whiteSpace),""!==this.type.fontWeight&&(this.element.style.fontWeight=this.type.fontWeight),1!==this.type.fontSizeRatio&&(this.element.style.fontSize=`${100*this.type.fontSizeRatio}%`),""!==this.initialContent&&(this.type.type===r.formInput.type?this.element.value=this.initialContent:this.element.textContent=this.initialContent),""!==this.type.position&&(this.element.style.position=this.type.position),this.element.setAttribute("mathTagName",this.type.type),this.equationEditor.options.editable&&(this.element.addEventListener("copy",t=>{this.equationEditor.copyToClipboard()}),this.type.type===r.atom.type&&(this.element.addEventListener("paste",t=>{this.pasteFromClipboard(t)}),this.element.addEventListener("keyup",t=>{this.handleKeyUp(t)}),this.element.addEventListener("keydown",t=>{this.handleKeyDown(t)}),this.element.addEventListener("focus",t=>{this.handleFocus(t)}),this.element.addEventListener("blur",t=>{this.handleBlur(t)})),this.type.type!==r.eventCatcher.type&&(this.element.addEventListener("click",t=>{this.handleSingleClick(t)}),this.element.addEventListener("mousedown",t=>{this.equationEditor.handleMouseSelectionStart(t,this)}),this.element.addEventListener("mouseup",t=>{this.equationEditor.handleMouseSelectionEnd(t)}),this.element.addEventListener("mousemove",t=>{this.equationEditor.handleMouseMoveSelection(t,this)})),this.type.type===r.root.type&&(this.element.addEventListener("focusin",()=>{this.element.classList.add("equationeditoreditablehighlighted")}),this.element.addEventListener("focusout",()=>{this.element.classList.remove("equationeditoreditablehighlighted")}))),this.type.type===r.root.type&&this.element.addEventListener("dblclick",t=>{this.equationEditor.handleDoubleClick(t)}))}handleSingleClick(t){if(t.stopPropagation(),t.preventDefault(),this.equationEditor.mouseIgnoreNextClick)return this.equationEditor.mouseIgnoreNextClick=!1,this.equationEditor.selectionEscapedOriginalAtom()&&(this.equationEditor.resetSelectionDOMSelectEventCatcher(),null!==this.equationEditor.options.debugLogContainer&&(this.equationEditor.lastSelectionAction="Set mouse ignore next to true.")),void this.equationEditor.writeDebugInfo(null);null!==this.equationEditor.options.debugLogContainer&&(this.equationEditor.lastSelectionAction="Reset selection on single click."),this.equationEditor.resetSelectionLeaveRangesIntact(),this.storeCursorPosition("",!1),this.type.type!==r.atom.type&&this.focus(1)}findFirstFocusedChild(){if(this.focused)return this;for(let t=0;t<this.children.length;t++){let e=this.children[t].findFirstFocusedChild();if(null!==e)return e}return null}selectElementByMouse(){this.selectedByMouse||null===this.element||(this.element.style.backgroundColor="lightskyblue"),this.selectedByMouse=!0}unSelectElementByMouse(){this.selectedByMouse&&null!==this.element&&(this.element.style.backgroundColor=""),this.selectedByMouse=!1}unSelectMouseRecursive(){this.unSelectElementByMouse();for(let t=0;t<this.children.length;t++)null!==this.children[t]&&this.children[t].unSelectMouseRecursive()}focusElement(){let t=this.equationEditor.options.highlightStyle;this.element.style.background=t.backgroundColor,this.element.style.outline=t.outline,this.focused=!0,this.equationEditor.hasFocusDOM=!0}beefUpToHorizontalParent(){let t=this.findHorizontalMathParent();return null===t.parent?this:t.parent.children[t.indexInParent]}blurElement(){this.focused=!1,null!==this.element&&(this.element.style.outline=this.type.outline,this.element.style.backgroundColor="")}blurRecursive(){this.blurElement();for(let t=0;t<this.children.length;t++)this.children[t].blurRecursive()}updateDOM(){this.updateDOMRecursive(0),this.equationEditor.updateAlignment()}lengthContentIfAtom(){return this.isAtomEditable()?null===this.element?this.initialContent.length:null===this.element.textContent?this.initialContent.length:this.element.textContent.length:-1}contentIfAtom(){return this.isAtomEditable()?this.textContentOrInitialContent():""}textContentOrInitialContent(){if(null===this.element)return null===this.initialContent?(console.log("Unexpected: initial content is null."),"[null]"):this.initialContent;let t=this.element.textContent;return null===t?"":t}contentIfAtomic(){return this.isAtomic()?this.textContentOrInitialContent():""}isAtomicNonEmptyOrHorizontalMathWithNonEmptyAtomic(){if(this.isAtomic())return""!==this.contentIfAtomic();if(this.type.type!==r.horizontalMath.type)return!1;let t=0;for(let e=0;e<this.children.length;e++){let i=this.children[e];if(!i.isAtomic())return!1;if(""!==i.contentIfAtomic()&&++t>1)return!1}return 1===t}isAtomic(){return this.type.type===r.atom.type||this.type.type===r.atomImmutable.type||this.type.type===r.sqrtSign.type}isAtomOrAtomImmutable(){return this.type.type===r.atom.type||this.type.type===r.atomImmutable.type}isDelimiter(){return this.type.type===r.leftDelimiter.type||this.type.type===r.rightDelimiter.type}isAtomEditable(){return this.type.type===r.atom.type}hasHorozintalMathParent(){return null!==this.parent&&this.parent.type.type===r.horizontalMath.type}updateDOMRecursive(t){if(this.type.type===r.atom.type||this.type.type===r.atomImmutable.type||this.type.type===r.formInput.type)return void this.createDOMElementIfMissing();for(let e=0;e<this.children.length;e++){this.children[e].updateDOMRecursive(t+1)}const e=this.element;this.element=null,this.createDOMElementIfMissing(),this.implied?(this.element.style.color=this.type.colorImplied,this.element.style.borderColor=this.type.colorImplied):(this.element.style.color=this.type.colorText,this.element.style.borderColor=this.type.colorText);for(let t=0;t<this.children.length;t++)this.element.appendChild(this.children[t].element);0===t&&this.updateParentDOM(e)}computeBoundingBox(){for(let t=0;t<this.children.length;t++){this.children[t].computeBoundingBox()}this.computeDimensions()}computeDimensionsDelimiter(){let t=this.element.getBoundingClientRect();this.boundingBox.width=t.width}computeDimensionsAtomic(){let t=this.element.getBoundingClientRect();this.boundingBox.width=t.width,this.boundingBox.height=t.height,0===this.boundingBox.height&&(this.boundingBox.height=this.equationEditor.standardAtomHeight),this.boundingBox.fractionLineHeight=this.boundingBox.height/2}computeDimensionsOverLine(){this.computeDimensionsStandard(),this.boundingBox.fractionLineHeight=this.children[0].boundingBox.fractionLineHeight+1}findBaselineBox(t){let e=new C;if(e.top=t.top+this.boundingBox.top,e.height=this.boundingBox.height,this.isAtomOrAtomImmutable()&&0!==this.boundingBox.width&&""!==this.contentIfAtomic())return e.width=this.boundingBox.width,e;for(let t=0;t<this.children.length;t++){let i=this.children[t].findBaselineBox(e);if(null!==i)return i}return null}containsFractionLineRecursive(){if(this.type.type===r.fraction.type)return!0;for(let t=0;t<this.children.length;t++)if(this.children[t].containsFractionLineRecursive())return!0;return!1}requiresTallExponent(){return!1}computeBoundingBoxLeftSingleChild(){let t=this.children[0];t.boundingBox.left=(this.boundingBox.width-t.boundingBox.width)/2}verticallyStretch(t,e){throw new Error("verticallyStretch not defined for a general MathNode")}verticallyStretchParenthesis(t,e){if(0===this.children.length)return;let i=this.children[0];i.verticallyStretch(t,e),this.boundingBox.top=0,this.boundingBox.height=i.boundingBox.height,this.boundingBox.fractionLineHeight=i.boundingBox.fractionLineHeight,this.boundingBox.width=i.boundingBox.width}computeDimensionsNumerator(){this.computeDimensionsStandard(),this.boundingBox.height=this.children[0].boundingBox.height}computeDimensionsMatrix(){this.boundingBox=new C,this.boundingBox.height=this.children[0].boundingBox.height,this.boundingBox.width=this.children[0].boundingBox.width,this.boundingBox.fractionLineHeight=this.children[0].boundingBox.fractionLineHeight,this.boundingBox.needsMiddleAlignment=!0;let t=this.children[0].children[1];for(let e=1;e<this.children.length;e++){let i=this.children[e];i.boundingBox.height=this.boundingBox.height,i.boundingBox.width=1;let n=i.extraData.columnIndex,o=t.boundingBox.getColumnOffset(n);i.boundingBox.left=o}}computeDimensionsMatrixTable(){this.boundingBox=new C;if(this.children.length<=0)return this.boundingBox.height=10,this.boundingBox.width=10,void(this.boundingBox.fractionLineHeight=this.boundingBox.height/2);let t=this.children[0].children.length,e=this.children.length,i=0;for(let n=0;n<t;n++){this.boundingBox.columnOffsets.push(i);let t=0;for(let i=0;i<e;i++)t=Math.max(t,this.children[i].children[n].boundingBox.width);for(let o=0;o<e;o++){let e=this.children[o].children[n],s=(t-e.boundingBox.width)/2;"l"===e.latexExtraStyle?s=0:"r"===e.latexExtraStyle&&(s=t-e.boundingBox.width),e.boundingBox.left=i+s,e.computeBoundingBoxLeftSingleChild()}i+=t+10}let n=i-10,o=0;for(let t=0;t<e;t++){let e=this.children[t];e.boundingBox=new C,e.mergeVerticalComponentsBoundingBoxesHorizontallyAlignedElements(),e.boundingBox.top=o,e.boundingBox.width=n,o+=e.boundingBox.height+10}this.boundingBox.height=o-10,this.boundingBox.width=n,this.boundingBox.fractionLineHeight=this.boundingBox.height/2}computeDimensionsRadicalUnderBox(){this.computeDimensionsStandard();let t=this.children[0];this.boundingBox.height=t.boundingBox.height+1,this.boundingBox.fractionLineHeight=t.boundingBox.fractionLineHeight+1}computeDimensions(){if(this.isAtomic())this.computeDimensionsAtomic();else if(this.type.type!==r.error.type){if(this.type.type===r.sqrt.type)throw new Error("This case should be handled by MathNodeSqrt.computeDimensions()");this.type.type!==r.matrixRow.type&&(this.type.type!==r.matrixTable.type?this.type.type!==r.matrix.type?this.type.type!==r.radicalUnderBox.type?(this.type.type===r.numerator.type&&this.computeDimensionsNumerator(),this.type.type!==r.overLinedBox.type?this.computeDimensionsStandard():this.computeDimensionsOverLine()):this.computeDimensionsRadicalUnderBox():this.computeDimensionsMatrix():this.computeDimensionsMatrixTable())}else this.computeDimensionsAtomic()}computeDimensionsStandard(){this.boundingBox=new C,this.computeDimensionsParenthesesHeight();for(let t=0;t<this.children.length;t++){let e=this.children[t];e.boundingBox.left=this.boundingBox.width,this.boundingBox.width+=e.boundingBox.width}this.mergeVerticalComponentsBoundingBoxesHorizontallyAlignedElements(),this.computeMiddleAlignment()}computeDimensionsParenthesesHeight(){let t=[],e=[],i=[];for(let n=0;n<this.children.length;n++)this.computeDimensionsParenthesesAccountChild(n,t,e,i)}computeDimensionsParenthesesAccountChild(t,e,i,n){let o=this.children[t];if(o.type.type===r.leftDelimiter.type)return e.push(0),i.push(0),void n.push(t);if(o.type.type===r.rightDelimiter.type){if(e.length<=0)return void console.log("Warning: unbalanced right parenthesis.");let t=e.pop(),s=i.pop();o.verticallyStretchParenthesis(t,s),this.children[n.pop()].verticallyStretchParenthesis(t,s)}e.length>0&&(e[e.length-1]=Math.max(o.boundingBox.height,e[e.length-1]),i[i.length-1]=Math.max(o.boundingBox.fractionLineHeight,i[i.length-1]))}mergeVerticalComponentsBoundingBoxesHorizontallyAlignedElements(){for(let t=0;t<this.children.length;t++){let e=this.children[t];this.boundingBox.fractionLineHeight=Math.max(this.boundingBox.fractionLineHeight,e.boundingBox.fractionLineHeight)}for(let t=0;t<this.children.length;t++){let e=this.children[t];e.boundingBox.top=this.boundingBox.fractionLineHeight-e.boundingBox.fractionLineHeight}for(let t=0;t<this.children.length;t++){let e=this.children[t],i=e.boundingBox.height-e.boundingBox.fractionLineHeight+this.boundingBox.fractionLineHeight;this.boundingBox.height=Math.max(this.boundingBox.height,i)}}computeMiddleAlignment(){for(let t=0;t<this.children.length;t++){if(this.children[t].boundingBox.needsMiddleAlignment)return void(this.boundingBox.needsMiddleAlignment=!0)}}doAlign(){""!==this.boundingBox.transform&&(this.element.style.transformOrigin=this.boundingBox.transformOrigin,this.element.style.transform=this.boundingBox.transform),"auto"!==this.element.style.width&&(this.element.style.width=`${this.boundingBox.width}px`),"auto"!==this.element.style.height&&(this.element.style.height=`${this.boundingBox.height}px`),this.element.style.left=`${this.boundingBox.left}px`,this.element.style.top=`${this.boundingBox.top}px`;for(let t=0;t<this.children.length;t++)this.children[t].doAlign()}updateParentDOM(t){let e=null;this.type.type===r.root.type?e=this.equationEditor.container:null!==t&&(e=t.parentElement),null!==e&&(e.contains(t)?e.replaceChild(this.element,t):e.appendChild(this.element))}handleFocus(t){this.focusElement(),this.storeCursorPosition("",!1)}handleBlur(t){this.blurElement(),this.equationEditor.blur()}handleKeyDown(t){"Shift"!==t.key&&"Ctrl"!==t.key?(this.storeCursorPosition(t.key,t.shiftKey),this.handleKeyDownDontComputeCursorPosition(t)):t.stopPropagation()}handleKeyDownDontComputeCursorPosition(t){let e=(new Date).getTime();t.stopPropagation();let i=this.handleKeyDownCases(t);i.preventDefault&&(t.preventDefault(),this.equationEditor.accountFrameTime(e)),setTimeout(()=>{this.equationEditor.storeSelection(),i.updateAlignment&&(this.storeCursorPosition(t.key,t.shiftKey),this.element.style.maxWidth="",this.element.style.maxHeight="",this.equationEditor.updateAlignment(),this.equationEditor.accountFrameTime(e)),this.equationEditor.writeLatexToInput(!0),this.equationEditor.writeDebugInfo(null),this.equationEditor.writeSVG(),this.equationEditor.drawOnCanvas(),null!==this.equationEditor.options.editHandler&&this.equationEditor.options.editHandler(this.equationEditor,this)},0)}handleKeyUp(t){t.shiftKey||"Shift"===t.key||(this.equationEditor.selectionStart=new l(null,-1),this.equationEditor.selectionEnd=new l(null,-1));let e=this.equationEditor.options.extraKeyHandlers;t.key in e&&e[t.key](this.equationEditor,t.shiftKey)}processBackslash(t,e){let i=new E(!1,t);return"Shift"===t?i:this.type.type!==r.atom.type?i:"\\"!==t||e?this.equationEditor.backslashSequenceStarted?" "===t&&this.equationEditor.backslashSequenceStarted?(this.equationEditor.backslashSequenceStarted=!1,this.equationEditor.backslashSequence in p.recognizedCommandsKeyInput?this.removeBackslashSequence():i):p.isLatinCharacter(t)?(this.equationEditor.backslashSequence+=t,i.keyAccountedCarryOutDefaultEvent=!0,i):"Backspace"===t?("\\"===this.equationEditor.backslashSequence?this.equationEditor.backslashSequenceStarted=!1:this.equationEditor.backslashSequence=this.equationEditor.backslashSequence.slice(0,this.equationEditor.backslashSequence.length-1),i.keyAccountedCarryOutDefaultEvent=!0,i):(this.equationEditor.backslashSequenceStarted=!1,i):i:(this.equationEditor.backslashSequenceStarted=!0,this.equationEditor.backslashSequence="\\",this.equationEditor.backslashPosition=this.positionCursorBeforeKeyEvents,i.keyAccountedCarryOutDefaultEvent=!0,i)}pasteFromClipboard(t){t.preventDefault();let e=t.clipboardData.getData("text");t.preventDefault(),this.storeCursorPosition("",!1),this.writeLatex(e)}writeLatex(t){if(this.type.type!==r.atom.type)return;if(null===this.equationEditor)throw new Error("Equation editor cannot be null here");let e=new m(this.equationEditor,t).parse();if(null===e){let e=this.textContentOrInitialContent(),i=e.slice(0,this.positionCursorBeforeKeyEvents)+t+e.slice(this.positionCursorBeforeKeyEvents);return this.element.textContent=i,this.desiredCursorPosition=this.positionCursorBeforeKeyEvents+t.length,this.updateDOM(),this.equationEditor.updateAlignment(),void this.focusRestore()}let i=this.splitByCursorEmptyAtoms(),n=e.rightmostAtomChild();null===n?i[1].desiredCursorPosition=0:n.desiredCursorPosition=n.textContentOrInitialContent().length;let o=Rt.horizontalMathFromArray(this.equationEditor,[i[0],e,i[1]]);o.normalizeHorizontalMath();let s=this.parent;s.replaceChildAtPosition(this.indexInParent,o),s.normalizeHorizontalMath(),s.updateDOM(),this.equationEditor.updateAlignment(),s.focusRestore()}insertString(t){let e=this.splitByCursor(),i=Rt.atom(this.equationEditor,t);i.desiredCursorPosition=t.length;let n=Rt.horizontalMathFromArray(this.equationEditor,[e[0],i,e[1]]);n.normalizeHorizontalMath();let o=this.parent;return o.replaceChildAtPosition(this.indexInParent,n),o.normalizeHorizontalMath(),o.updateDOM(),o.focusRestore(),!0}handleKeyDownCases(t){let e=t.key;if(t.ctrlKey)return this.equationEditor.handleControlKeys(t);let i=t.shiftKey,n=this.processBackslash(e,i);if(n.keyAccountedCarryOutDefaultEvent)return new x(!1,!0);let o=n.command;if(o in p.operatorWithSuperAndSubscriptBackslashed){let t=p.operatorWithSuperAndSubscriptBackslashed[o];return this.makeOperatorWithSuperscriptAndSubscript(t),new x(!0,!1)}if(o in p.operatorsWithSubscriptBackslashed){let t=p.operatorsWithSubscriptBackslashed[o];return this.makeOperatorWithSubscript(t),new x(!0,!1)}if(o in p.latexBackslashOperatorsBackslashed){let t=p.latexBackslashOperatorsBackslashed[o];return this.makeHorizontalOperator(t),new x(!0,!1)}if(o in p.leftDelimiters&&!(o in p.delimitersAmbiguous))return this.makeDelimiterLeft(o),new x(!0,!1);if(o in p.rightDelimiters&&!(o in p.delimitersAmbiguous))return this.makeDelimiterRight(o),new x(!0,!1);if(o in p.latexBackslashAtomsEditableBackslashed){let t=p.latexBackslashAtomsEditableBackslashed[o];return this.insertString(t),new x(!0,!1)}switch(n.command){case"/":return this.makeFractionNumerator(),new x(!0,!1);case";":case":":case"*":case"+":case"-":case"=":case">":case"<":case",":case".":return this.makeHorizontalOperatorCorrectInput(e),new x(!0,!1);case"^":return this.makeBaseWithExponent(),new x(!0,!1);case"_":return this.makeBaseWithSubscript(),new x(!0,!1);case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":return this.arrow(e,i);case"|":return this.makeDelimiterAmbiguous(e),new x(!0,!1);case"Enter":return new x(!0,!1);case"Delete":return this.deleteButton();case"Backspace":return this.backspace();case"{":return this.makeDelimiterLeft("{"),new x(!0,!1);case"}":return this.makeDelimiterRight("}"),new x(!0,!1);case"\\sqrt":return this.makeSqrt(),new x(!0,!1);case"\\cancel":return this.makeCancel(),new x(!0,!1);case"\\pmatrix":return this.makeMatrix(2,2,"pmatrix"),new x(!0,!1);case"\\bmatrix":return this.makeMatrix(2,2,"bmatrix"),new x(!0,!1);case"\\vmatrix":return this.makeMatrix(2,2,"vmatrix"),new x(!0,!1);case"\\matrix":return this.makeMatrix(2,2,"matrix"),new x(!0,!1);default:return new x(!1,!0)}}arrowRight(t,e){this.type.type===r.atom.type?this.isAtomWithRightmostCursor()&&this.arrow(t,e):this.arrow(t,e)}getPathToRoot(){let t=[],e=this;for(;null!==e;)-1!==e.indexInParent&&t.push(e.indexInParent),e=e.parent;return t.reverse()}commonPathToRoot(t){if(this.equationEditor!==t.equationEditor)return null;let e=this.getPathToRoot(),i=t.getPathToRoot(),n=[];for(let t=0;t<e.length;t++){if(t>=i.length)return n;if(e[t]!==i[t])return n;n.push(e[t])}return n}commonAncestor(t){if(this===t||null===t)return this;if(this.equationEditor!==t.equationEditor)return null;let e=this.commonPathToRoot(t);return this.equationEditor.elementFromPath(e)}commonParent(t){let e=this.commonPathToRoot(t),i=this.getPathToRoot();return i.length===e.length?new wt(this.parent,this.indexInParent):new wt(this.equationEditor.elementFromPath(e),i[e.length])}isToTheLeftOf(t){let e=this.getPathToRoot(),i=t.getPathToRoot();for(let t=0;t<e.length;t++){if(t>=i.length)return!1;if(e[t]<i[t])return!0;if(e[t]>i[t])return!1}return!1}arrow(t,e){if(e)return this.equationEditor.arrowShiftHeld(this,t);if(this.equationEditor.resetSelectionLeaveRangesIntact(),this.arrowAbsorbedByAtom(t))return"ArrowLeft"===t?this.positionCursorBeforeKeyEvents--:this.positionCursorBeforeKeyEvents++,new x(!1,!1);const i=this.getAtomToFocus(t);return null!==i.element&&(i.element.positionCursorBeforeKeyEvents=i.element.element.textContent.length+1,i.element.focus(i.position)),new x(!0,!0)}arrowAbsorbedByAtom(t){return this.type.type===r.atom.type&&(" "!==this.element.textContent&&("ArrowLeft"===t?0!==this.positionCursorBeforeKeyEvents:"ArrowRight"===t&&this.positionCursorBeforeKeyEvents!==this.element.textContent.length))}getAtomToFocus(t){return this.getAtomToFocusFromAction(t,this.type.arrows[t])}getAtomToFocusFromAction(t,e){return this.getAtomToFocusFromActionDefault(t,e)}getAtomToFocusFromActionDefault(t,e){return e===o.parentForward?null===this.parent?new l(null,-1):this.parent.getAtomToFocus(t):e===o.firstAtomToTheLeft?new l(this,0).leftNeighbor():e===o.firstAtomToTheRight?new l(this,this.textContentOrInitialContent().length).rightNeighbor():new l(null,-1)}firstAtom(t){return t>0?this.firstAtomToTheRight():this.firstAtomToTheLeft()}firstAtomSiblingOrUncle(t){t=t<0?-1:1;let e=this;for(;;){let i=e.findHorizontalMathParent();if(null===i.parent)return null;for(let e=i.indexInParent+t;e>=0&&e<i.parent.children.length;e+=t){let t=i.parent.children[e];if(t.isAtomic())return t}e=i.parent}}firstAtomToTheRight(){return null===this.parent?null:this.parent.firstAtomToTheRightOf(this.indexInParent)}firstAtomToTheRightOf(t){for(let e=t+1;e<this.children.length;e++){let t=this.children[e].leftmostAtomChild();if(null!==t)return t}return this.firstAtomToTheRight()}firstAtomToTheLeft(){return null===this.parent?null:this.parent.firstAtomToTheLeftOf(this.indexInParent)}firstAtomToTheLeftOf(t){for(let e=t-1;e>=0;e--){let t=this.children[e].rightmostAtomChild();if(null!==t)return t}return this.firstAtomToTheLeft()}leftmostAtomChild(){if(this.type.type===r.atom.type)return this;for(let t=0;t<this.children.length;t++){let e=this.children[t].leftmostAtomChild();if(null!==e)return e}return null}rightmostAtomChild(){if(this.type.type===r.atom.type)return this;for(let t=this.children.length-1;t>=0;t--){let e=this.children[t].rightmostAtomChild();if(null!==e)return e}return null}storeCursorPositionPreExisingRange(t,e){let i=this.positionCursorBeforeKeyEvents,n=window.getSelection(),o=null,s=null;(s=(o=n.rangeCount>0?n.getRangeAt(0):document.createRange()).cloneRange()).selectNodeContents(this.element),s.setEnd(o.endContainer,o.endOffset),this.positionCursorBeforeKeyEvents=s.toString().length,this.selectionLength=o.toString().length,this.equationEditor.setLastFocused(this),this.equationEditor.positionDebugString=`Computed position: ${this.positionCursorBeforeKeyEvents}.`,this.equationEditor.positionDebugString+=`Range: [${o}], clone: [${s}], previous position: ${i}.`,this.equationEditor.positionDebugString+=`end offset: ${o.endOffset}, start offset: ${o.startOffset}`,this.equationEditor.writeDebugInfo(null)}storeCursorPosition(t,e){if(this.type.type!==r.eventCatcher.type){if(this.type.type!==r.atom.type)return this.positionCursorBeforeKeyEvents=-1,this.selectionLength=0,void this.equationEditor.setLastFocused(null);try{this.storeCursorPositionPreExisingRange(t,e)}catch(t){console.log(`Failed to store cursor position ${t}.`)}}}appendChild(t){null!==t&&(t.parent!==this&&null!==t.parent&&t.indexInParent>=0&&(t.parent.children[t.indexInParent]=null),t.parent=this,t.indexInParent=this.children.length,this.children.push(t))}appendChildren(t){for(let e=0;e<t.length;e++)null!==t[e]&&this.appendChild(t[e])}ensureEditableAtomsRecursive(){for(let t=0;t<this.children.length;t++)this.children[t].ensureEditableAtomsRecursive();this.type.type===r.horizontalMath.type&&(null!==this.parent&&this.parent.type.type===r.matrix.type||this.ensureEditableAtoms())}normalizeHorizontalMathRecursive(){for(let t=0;t<this.children.length;t++)this.children[t].normalizeHorizontalMathRecursive();this.type.type===r.horizontalMath.type&&(null!==this.parent&&this.parent.type.type===r.matrix.type||this.normalizeHorizontalMath())}normalizeHorizontalMath(){if(this.type.type!==r.horizontalMath.type)return!1;let t=!1;for(;this.normalizeHorizontalMathInHorizontalMathOnce()||this.normalizeHorizontalMathAtomNextToAtomOnce();)t=!0;return t}normalizeHorizontalMathInHorizontalMathOnceAccountOneChild(t,e){if(e.type.type!==r.horizontalMath.type)return t.push(e),!1;for(let i=0;i<e.children.length;i++)0===e.desiredCursorPosition&&0===i?e.children[i].desiredCursorPosition=0:e.desiredCursorPosition>0&&i===e.children.length-1&&(e.children[i].desiredCursorPosition=1),t.push(e.children[i]);return!0}normalizeHorizontalMathInHorizontalMathOnce(){let t=[],e=!1;for(let i=0;i<this.children.length;i++)this.normalizeHorizontalMathInHorizontalMathOnceAccountOneChild(t,this.children[i])&&(e=!0);return!!e&&(this.replaceChildRangeWithChildren(0,this.children.length-1,t),!0)}mergeAtomContentToTheRight(t){let e=this.initialContent;null!==this.element&&(e=this.element.textContent);let i=t.initialContent;null!==t.element&&(i=t.element.textContent),-1!==t.desiredCursorPosition&&(this.desiredCursorPosition=e.length+t.desiredCursorPosition),e+=i,null===this.element?this.initialContent=e:this.element.textContent=e}normalizeHorizontalMathAtomNextToAtomOnce(){for(let t=0;t<this.children.length-1;t++){let e=this.children[t],i=this.children[t+1];if(e.type.type===r.atom.type&&i.type.type===r.atom.type)return e.mergeAtomContentToTheRight(i),this.removeChildRange(t+1,t+1),!0}return!1}replaceChildAtPositionWithChildren(t,e){this.replaceChildRangeWithChildren(t,t,e)}replaceChildAtPosition(t,e){this.replaceChildRangeWithChildren(t,t,[e])}insertChildAtPosition(t,e){this.replaceChildRangeWithChildren(t,t-1,[e])}removeChildReplaceWithNull(t){let e=this.children[t];return e.parent=null,e.indexInParent=-1,this.children[t]=null,e}removeChild(t){this.replaceChildRangeWithChildren(t,t,[])}removeChildRange(t,e){this.replaceChildRangeWithChildren(t,e,[])}replaceChildRangeWithChildren(t,e,i){let n=[];for(let i=t;i<=e&&i>=0&&i<this.children.length;i++)null!==this.children[i]&&(this.children[i].parent=null);for(let t=e+1;t<this.children.length;t++)n.push(this.removeChildReplaceWithNull(t));this.children.length=t;for(let t=0;t<i.length;t++)null!==i[t]&&this.appendChild(i[t]);for(let t=0;t<n.length;t++)this.appendChild(n[t])}isAtomWithLeftmostCursor(){if(this.type.type!==r.atom.type)return!1;return 0===window.getSelection().getRangeAt(0).startOffset}isAtomWithRightmostCursor(){if(this.type.type!==r.atom.type)return!1;return window.getSelection().getRangeAt(0).startOffset===this.element.textContent.length}deleteButton(){if(this.equationEditor.hasSelection())return this.equationEditor.deleteSelection(null);if(this.positionCursorBeforeKeyEvents!==this.element.textContent.length||this.type.type!==r.atom.type)return new x(!1,!0);let t=this.firstAtom(1);if(null===t)return new x(!1,!1);let e=t.previousHorizontalSibling();if(null!==e&&e.implied)return t.desiredCursorPosition=0,this.parent.focusRestore(),new x(!0,!1);let i=this.nextHorizontalSibling();return null!==i&&i.type.type===r.baseWithExponent.type?(i.focus(-1),new x(!0,!1)):(this.positionCursorBeforeKeyEvents=-1,t.positionCursorBeforeKeyEvents=0,t.backspace())}backspace(){if(this.equationEditor.hasSelection())return this.equationEditor.deleteSelection(null);if(0!==this.positionCursorBeforeKeyEvents||this.type.type!==r.atom.type)return new x(!1,!0);this.desiredCursorPosition=0;let t=this.applyBackspaceToTheLeft();return new x(t,!t)}applyBackspaceToTheLeftChildWithSiblingWrapper(){let t=this.parent,e=t.indexInParent,i=t.children[0];this.children[0].children[0].desiredCursorPosition=0,i.appendChild(this.children[0]),i.normalizeHorizontalMath();let n=t.parent;return n.replaceChildAtPosition(e,i),n.normalizeHorizontalMath(),n.updateDOM(),n.focusRestore(),!0}applyBackspaceToTheLeftWrapperChildWithSiblingWrapper(){let t=this.parent,e=t.indexInParent,i=t.children[0].children[0];i.appendChild(t.children[1].children[0]),i.normalizeHorizontalMath();let n=t.parent;return n.replaceChildAtPosition(e,i),n.normalizeHorizontalMath(),n.updateDOM(),n.focusRestore(),!0}applyBackspaceToTheLeftHorizontalMathParent(){let t=this.parent;if(t.type.type!==r.horizontalMath.type)return!1;if(0===this.indexInParent)return this.parent.applyBackspaceToTheLeft();let e=this.indexInParent-1;return t.children[e].applyBackspaceToTheRight()}applyBackspaceToTheLeft(){return null===this.parent?(this.focusCancelOnce(),!1):0===this.indexInParent?this.parent.applyBackspaceToTheLeft():!!this.applyBackspaceToTheLeftHorizontalMathParent()||(this.parent.focusCancelOnce(),!1)}applyBackspaceToTheRightAsLeftArrow(){let t=this.nextHorizontalSibling();return null!==t&&t.focusCancelOnce(),this.rightmostAtomChild().focus(1),!0}applyBackspaceToTheLeftAsLeftArrow(){let t=this.previousHorizontalSibling();return null!==t&&(t.rightmostAtomChild().focus(1),!0)}applyBackspaceToTheRight(){return!1}applyBackspaceToTheRightDelimiter(){if(this.type.type!==r.rightDelimiter.type&&this.type.type!==r.leftDelimiter.type)return!1;let t=this.parent.findIndexMatchingDelimiter(this.indexInParent);if(-1===t)return console.log("Unexpected failure to find matching left parenthesis."),!1;if(!this.parent.children[t].implied)return this.implied=!0,this.children[0].implied=!0,this.parent.focusCancelOnce(),this.focus(-1),this.updateDOM(),!0;let e=this.parent,i=this.indexInParent;return e.removeChild(Math.max(i,t)),e.removeChild(Math.min(i,t)),e.normalizeHorizontalMath(),e.updateDOM(),e.focusRestore(),!0}computePositionOfOperator(){let t=1;return 0===this.positionCursorBeforeKeyEvents&&this.element.textContent.length>0?t=-1:this.positionCursorBeforeKeyEvents>0&&this.positionCursorBeforeKeyEvents<this.element.textContent.length&&(t=0),t}findHorizontalMathParent(){let t=new wt(this.parent,this.indexInParent);for(;null!==t.parent;){if(t.parent.type.type===r.horizontalMath.type)return t;t.indexInParent=t.parent.indexInParent,t.parent=t.parent.parent}return t}makeHorizontalOperatorCorrectInput(t){this.makeHorizontalOperator(p.normalizeOperatorToUtf8(t))}makeHorizontalOperator(t){let e=this.splitByCursorEmptyAtoms();this.makeHorizontalOperatorFromSplit(t,e)}makeHorizontalOperatorFromSplit(t,e){if(!this.hasHorozintalMathParent())return void console.log("Warning: horizontal operator made on element not contained in horizontal math.");let i=this.parent,n=Rt.atomImmutable(this.equationEditor,t);i.replaceChildAtPositionWithChildren(this.indexInParent,[e[0],n,e[1]]),i.normalizeHorizontalMath(),i.ensureEditableAtoms(),i.updateDOM(),n.focus(1)}makeDelimiterAmbiguous(t){this.makeDelimiterCommon(t,p.leftRightDelimiterPair[t],!0,!0)}makeDelimiterLeft(t){this.makeDelimiterCommon(t,p.leftRightDelimiterPair[t],!0,!1)}makeDelimiterRight(t){this.makeDelimiterCommon(p.rightLeftDelimiterPair[t],t,!1,!1)}makeMatrix(t,e,i){let n=this.splitByCursorEmptyAtoms();this.makeMatrixFromSplit(t,e,n,i)}makeMatrixFromSplit(t,e,i,n){if(!this.hasHorozintalMathParent())return void console.log("Warning: horizontal operator made on element not contained in horizontal math.");let o=this.parent,s=Rt.matrix(this.equationEditor,t,e,"",n);o.replaceChildAtPositionWithChildren(this.indexInParent,[i[0],s,i[1]]),o.normalizeHorizontalMath(),o.ensureEditableAtoms(),o.updateDOM(),s.children[0].children[1].children[0].children[0].focus(0)}makeCancel(){let t=this.equationEditor.splitAtomsBySelection();null===t?this.makeCancelFromSplit(this.splitByCursor()):this.makeCancelFromSplit(t.split)}makeSqrt(){let t=this.equationEditor.splitAtomsBySelection();null!==t?this.equationEditor.makeSqrtFromSelection(t):this.makeSqrtFromCursor()}makeSum(){this.makeOperatorWithSuperscriptAndSubscript(p.operatorWithSuperAndSubscript.sum)}makeOperatorWithSuperscriptAndSubscript(t){let e=this.splitByCursor();this.makeOperatorWithSuperscriptAndSubscriptFromSplit(t,e)}makeOperatorWithSuperscriptAndSubscriptFromSplit(t,e){let i=this.parent,n=this.indexInParent,o=Rt.operatorWithSuperAndSubscript(this.equationEditor,t,null,null);null===e[0]?i.replaceChildAtPosition(n,o):(i.replaceChildAtPosition(n,e[0]),n++,i.insertChildAtPosition(n,o)),null!==e[1]&&i.insertChildAtPosition(n+1,e[1]),i.ensureEditableAtoms(),i.updateDOM(),o.focus(1)}makeOperatorWithSubscript(t){let e=this.splitByCursor();this.makeOperatorWithSubscriptFromSplit(t,e)}makeOperatorWithSubscriptFromSplit(t,e){let i=this.parent,n=this.indexInParent,o=Rt.operatorWithSubscript(this.equationEditor,t,null);null===e[0]?i.replaceChildAtPosition(n,o):(i.replaceChildAtPosition(n,e[0]),n++,i.insertChildAtPosition(n,o)),null!==e[1]&&i.insertChildAtPosition(n+1,e[1]),i.ensureEditableAtoms(),i.updateDOM(),o.focus(1)}makeCancelFromSplit(t){let e=this.parent,i=this.indexInParent,n=Rt.cancel(this.equationEditor,t[1]);null===t[0]?e.replaceChildAtPosition(i,n):(e.replaceChildAtPosition(i,t[0]),e.insertChildAtPosition(i+1,n)),e.ensureEditableAtoms(),e.updateDOM(),n.children[1].focusStandard(-1)}makeSqrtFromCursor(){let t=this.splitByCursor();this.makseSqrtFromSplit(t)}makseSqrtFromSplit(t){let e=this.parent,i=this.indexInParent,n=Rt.sqrt(this.equationEditor,t[1],null);null===t[0]?e.replaceChildAtPosition(i,n):(e.replaceChildAtPosition(i,t[0]),e.insertChildAtPosition(i+1,n)),e.ensureEditableAtoms(),e.updateDOM(),n.children[2].focusStandard(0)}makeDelimiterCommon(t,e,i,n){let o=this.computePositionOfOperator(),s=this.findHorizontalMathParent();if(null===s.parent)return void console.log("Warning: could not find ancestor of type horizontal math.");let r=s.indexInParent;s.parent.children[r].doMakeDelimiterCommon(t,e,o,i,n)}isDelimiterBalancingBreaker(t){return t.type.type===r.operatorStandalone.type||t.type.type===r.operatorWithSubscript.type||t.type.type===r.operatorWithSuperAndSubscript.type}findIndexToInsertRightDelimiter(t){let e=0;for(let i=t;i<this.children.length;i++){let t=this.children[i];if(t.type.type===r.rightDelimiter.type?e--:t.type.type===r.leftDelimiter.type&&e++,e<0)return i;if(0===e&&this.isDelimiterBalancingBreaker(t))return i}return this.children.length}findIndexToInsertLeftDelimiter(t){let e=0;for(let i=t-1;i>=0;i--){let t=this.children[i];if(t.type.type===r.rightDelimiter.type?e++:t.type.type===r.leftDelimiter.type&&e--,e<0)return i+1;if(0===e&&this.isDelimiterBalancingBreaker(t))return i+1}return 0}findMatchingDelimiter(){if(this.type.type!==r.rightDelimiter.type&&this.type.type!==r.leftDelimiter.type)return null;if(!this.hasHorozintalMathParent())return null;let t=this.parent,e=t.findIndexMatchingDelimiter(this.indexInParent);return-1===e?null:t.children[e]}findIndexMatchingDelimiter(t){let e=r.leftDelimiter.type,i=r.rightDelimiter.type,n=1;this.children[t].type.type===r.rightDelimiter.type&&(i=r.leftDelimiter.type,e=r.rightDelimiter.type,n=-1);let o=1;for(let s=t+n;s<this.children.length&&s>=0;s+=n){let t=this.children[s];if(t.type.type===e?o++:t.type.type===i&&o--,0===o)return s}return-1}splitByCursor(){return this.splitByPosition(this.positionCursorBeforeKeyEvents)}splitByCursorEmptyAtoms(){return this.splitByPositionEmptyAtoms(this.positionCursorBeforeKeyEvents)}splitByPositionEmptyAtoms(t){let e=this.splitByPosition(t);return null===e[0]&&(e[0]=Rt.atom(this.equationEditor,"")),null===e[1]&&(e[1]=Rt.atom(this.equationEditor,"")),e}splitByPosition(t){return this.splitByPositionChopOffCharacters(t,0)}splitByPositionIntoStringsChopOffCharacters(t,e){if(!this.isAtomEditable()||t<0)return["",""];let i=this.contentIfAtom();return[i.slice(0,t),i.slice(t+e,i.length)]}splitByPositionChopOffCharacters(t,e){if(!this.isAtomEditable()||t<0)return t<=0?[null,this]:[this,null];let i=this.splitByPositionIntoStringsChopOffCharacters(t,e),n=i[0],o=i[1],s=Rt.atom(this.equationEditor,n),r=Rt.atom(this.equationEditor,o);return""===n?[null,r]:""===o?[s,null]:[s,r]}adjustIsLeft(t,e,i){for(let n=e;n>=0;n--){let e=i.children[n];e.type.type!==r.leftDelimiter.type||"|"!==e.initialContent||e.implied||(t=!0)}if(t&&e+1<i.children.length){let n=i.children[e+1];n.type.type===r.rightDelimiter.type&&!0===n.implied&&(t=!1)}return t}doMakeDelimiterCommon(t,e,i,n,o){let s=this.parent;s.type.type!==r.horizontalMath.type&&console.log("Warning: making parentheses in non-horizontal math.");let l=this.indexInParent,h=Rt.leftDelimiter(this.equationEditor,t,!n),a=Rt.rightDelimiter(this.equationEditor,e,n);if(0===i){let t=this.splitByCursor();s.replaceChildAtPositionWithChildren(l,t)}let d=-1,c=-1;if(o&&(n=this.adjustIsLeft(n,l,s)),n){if(-1===(d=s.replaceImpliedLeftDelimiter(t,l,i)))return;c=s.findIndexToInsertRightDelimiter(d)}else{if(-1===(c=s.replaceImpliedRightDelimiter(e,this.indexInParent,i)))return;d=s.findIndexToInsertLeftDelimiter(c)}s.insertChildAtPosition(c,a),s.insertChildAtPosition(d,h),s.normalizeHorizontalMath(),s.ensureEditableAtoms(),s.updateDOM(),n?h.focus(1):a.focus(1)}replaceImpliedLeftDelimiter(t,e,i){let n=-1,o=this.children[e].contentIfAtomic();n=1===i&&o.length>0?e+1:0===i&&o.length>0?e+1:e;let s=0;for(let i=e;i>=0;i--){let e=this.children[i];if(e.type.type!==r.rightDelimiter.type){if(e.type.type===r.leftDelimiter.type){if(--s>=0)continue;if(e.implied)return this.moveDelimiterMarkExplicit(t,n,i),-1;break}}else s++}for(let i=e;i<this.children.length;i++){let e=this.children[i];if(e.type.type===r.rightDelimiter.type)return n;if(e.type.type===r.leftDelimiter.type&&e.implied)return this.moveDelimiterMarkExplicit(t,n,i),-1}return n}replaceImpliedRightDelimiter(t,e,i){let n=-1,o=this.children[e].contentIfAtomic();n=1===i&&o.length>0?e+1:0===i&&o.length>0?e+1:e;let s=0;for(let i=e;i<this.children.length;i++){let e=this.children[i];if(e.type.type!==r.leftDelimiter.type){if(e.type.type===r.rightDelimiter.type){if(--s>=0)continue;if(e.implied)return this.moveDelimiterMarkExplicit(t,n,i),-1;break}}else s++}for(let i=e-1;i>=0;i--){let e=this.children[i];if(e.type.type===r.leftDelimiter.type)return n;if(e.type.type===r.rightDelimiter.type&&e.implied)return this.moveDelimiterMarkExplicit(t,n,i),-1}return n}moveDelimiterMarkExplicit(t,e,i){let n=this.children[i].type.type===r.leftDelimiter.type;this.removeChild(i),e>i&&e--;let o=null;return o=n?Rt.leftDelimiter(this.equationEditor,t,!1):Rt.rightDelimiter(this.equationEditor,t,!1),this.insertChildAtPosition(e,o),this.ensureEditableAtoms(),this.updateDOM(),o.focus(1),!0}hasExponentOrSubscriptParent(){if(null===this.parent)return!1;if(0!==this.indexInParent)return!1;let t=this.parent.type.type;return t===r.baseWithExponent.type||t===r.baseWithSubscript.type}ensureEditableAtoms(){if(this.type.type!==r.horizontalMath.type)return void console.log("Warning: call ensureEditableAtomToTheRight on non-horizontal math. ");let t=[];0===this.children.length?t.push(Rt.atom(this.equationEditor,"")):this.children[0].isAtomEditable()||this.hasExponentOrSubscriptParent()||t.push(Rt.atom(this.equationEditor,""));for(let e=0;e<this.children.length-1;e++){let i=this.children[e],n=this.children[e+1];t.push(i),i.isAtomEditable()||n.isAtomEditable()||t.push(Rt.atom(this.equationEditor,""))}t.push(this.children[this.children.length-1]),t[t.length-1].isAtomEditable()||this.hasExponentOrSubscriptParent()||t.push(Rt.atom(this.equationEditor,"")),t.length>this.children.length&&this.replaceChildRangeWithChildren(0,this.children.length,t)}setTextContent(t){null!==this.element?this.element.textContent=t:this.initialContent=t}removeBackslashSequence(){let t=this.equationEditor.backslashSequence,e=this.splitByPositionIntoStringsChopOffCharacters(this.equationEditor.backslashPosition,t.length);return this.positionCursorBeforeKeyEvents=this.equationEditor.backslashPosition,this.setTextContent(e[0]+e[1]),new E(!1,t)}makeFractionNumerator(){if(null===this.parent)return;let t=this.equationEditor.splitAtomsBySelection();null===t?this.makeFractionNumeratorFromCursorPosition():this.equationEditor.makeFractionNumeratorFromSelection(t)}makeFractionNumeratorFromCursorPosition(){const t=this.parent,e=this.indexInParent;let i=null,n=1;0===this.positionCursorBeforeKeyEvents&&this.element.textContent.length>0&&(n=0);let o=this.splitByCursor(),s=this.previousHorizontalSibling(),l=this.nextHorizontalSibling(),h=Rt.atom(this.equationEditor,""),a=Rt.atom(this.equationEditor,"");if(null===o[0]&&null!==s&&s.type.type===r.rightDelimiter.type){let s=e-1,r=t.findIndexMatchingDelimiter(s),l=t.children.slice(r,s+1),d=Rt.horizontalMathFromArray(this.equationEditor,l);d.ensureEditableAtoms(),d.normalizeHorizontalMath(),i=Rt.fraction(this.equationEditor,d,o[1]),t.replaceChildRangeWithChildren(r,s+1,[h,i,a]),n=1}else if(null===o[0]&&null!==s&&s.type.type!==r.rightDelimiter.type&&s.type.type!==r.leftDelimiter.type){let e=s.indexInParent,l=Rt.horizontalMath(this.equationEditor,s);l.ensureEditableAtoms(),l.normalizeHorizontalMath(),i=Rt.fraction(this.equationEditor,l,o[1]),t.replaceChildRangeWithChildren(e,e+1,[h,i,a]),t.type.type===r.horizontalMath.type&&t.normalizeHorizontalMath(),n=1}else if(null===o[1]&&null!==l&&l.type.type===r.leftDelimiter.type){let s=e+1,r=t.findIndexMatchingDelimiter(s),l=t.children.slice(s,r+1),d=Rt.horizontalMathFromArray(this.equationEditor,l);d.ensureEditableAtoms(),d.normalizeHorizontalMath(),i=Rt.fraction(this.equationEditor,o[0],d),t.replaceChildRangeWithChildren(e,r,[h,i,a]),n=1}else i=Rt.fraction(this.equationEditor,o[0],o[1]),t.replaceChildAtPosition(e,Rt.atom(this.equationEditor,"")),t.insertChildAtPosition(e+1,i),t.insertChildAtPosition(e+2,Rt.atom(this.equationEditor,""));i.parent.updateDOM(),i.children[n].focus(-1)}removeAllChildren(){this.removeChildRange(0,this.children.length-1)}isEmptyAtom(){return this.type.type===r.atom.type&&(null!==this.element&&""===this.element.textContent)}previousHorizontalSibling(){return this.horizontalSibling(-1)}nextHorizontalSibling(){return this.horizontalSibling(1)}horizontalSibling(t){if(null===this.parent)return null;if(this.parent.type.type!==r.horizontalMath.type)return null;let e=this.indexInParent+t;return e<0||e>=this.parent.children.length?null:this.parent.children[e]}makeBaseWithExponent(){if(null===this.parent)return;if(this.positionCursorBeforeKeyEvents>0)return void this.makeBaseDefaultWithExponentNoDelimiter();let t=this.previousHorizontalSibling();null!==t?t.type.type!==r.rightDelimiter.type?t.type.type!==r.matrix.type?t.isAtomEditable()?t.makeBaseDefaultWithExponentNoDelimiter():this.makeBaseDefaultWithExponentNoDelimiter():t.makeBaseDefaultWithExponent():t.makeBaseWithExponentRightDelimiter():this.makeBaseDefaultWithExponentNoDelimiter()}makeBaseWithExponentRightDelimiter(){let t=this.indexInParent,e=this.parent,i=e.findIndexMatchingDelimiter(t),n=e.children.slice(i,t+1),o=Rt.horizontalMathFromArray(this.equationEditor,n);const s=Rt.baseWithExponent(this.equationEditor,o,null);s.children[1].children[0].children[0].desiredCursorPosition=0,e.replaceChildRangeWithChildren(i,t,[s]),e.ensureEditableAtoms(),e.updateDOM(),e.focusRestore()}makeBaseDefaultWithExponentNoDelimiter(){if(!this.isAtomEditable())return void this.makeBaseDefaultWithExponent();let t=this.splitByCursor(),e=this.parent,i=this.indexInParent,n=Rt.baseWithExponent(this.equationEditor,t[0],t[1]);null===t[0]?(n.children[0].appendChild(Rt.atom(this.equationEditor,"")),n.children[0].children[0].desiredCursorPosition=0):n.children[1].children[0].children[0].desiredCursorPosition=0,e.replaceChildAtPosition(i,n),e.ensureEditableAtoms(),e.updateDOM(),e.focusRestore()}makeBaseDefaultWithExponent(){let t=this.parent,e=this.indexInParent;const i=Rt.baseWithExponent(this.equationEditor,this,null);i.children[1].children[0].children[0].desiredCursorPosition=0,t.replaceChildAtPosition(e,i),t.ensureEditableAtoms(),t.updateDOM(),t.focusRestore()}makeBaseWithSubscript(){if(null!==this.parent){if(this.isEmptyAtom()){let t=this.previousHorizontalSibling();if(null!==t)return void t.makeBaseWithSubscript()}this.type.type!==r.rightDelimiter.type?this.makeBaseDefaultWithSubscript():this.makeBaseWithSubscriptRightDelimiter()}}makeBaseWithSubscriptRightDelimiter(){let t=this.indexInParent,e=this.parent,i=e.findIndexMatchingDelimiter(t),n=e.children.slice(i,t+1),o=Rt.horizontalMathFromArray(this.equationEditor,n);const s=Rt.baseWithSubscript(this.equationEditor,o,null);s.children[1].children[0].children[0].desiredCursorPosition=0,e.replaceChildRangeWithChildren(i,t,[s]),e.ensureEditableAtoms(),e.updateDOM(),e.focusRestore()}makeBaseDefaultWithSubscript(){let t=this.parent,e=this.indexInParent;const i=Rt.baseWithSubscript(this.equationEditor,this,null);i.children[1].children[0].children[0].desiredCursorPosition=0,t.replaceChildAtPosition(e,i),t.ensureEditableAtoms(),t.updateDOM(),t.focusRestore()}focusAtom(t){if(null===this.element)return this.desiredCursorPosition=-1,!1;let e=this.desiredCursorPosition,i=0;return 0===t&&(i=e),t>0&&(i=this.element.textContent.length),i<0&&(i=0),i>this.element.textContent.length&&(i=this.element.textContent.length),this.setCursorPosition(i),this.equationEditor.setLastFocused(this),this.desiredCursorPosition=-1,!0}focus(t){return this.type.type===r.atom.type?this.focusAtom(t):this.type.type===r.eventCatcher.type?null!==this.element&&(this.element.focus(),!0):this.focusStandard(t)}focusStandard(t){if(1===t){for(let e=this.children.length-1;e>=0;e--)if(this.children[e].focus(t))return!0}else for(let e=0;e<this.children.length;e++)if(this.children[e].focus(t))return!0;if(0===t)return!1;let e=this.firstAtom(t);return null!==e&&e.focus(-t)}focusCancelOnce(){if(-1!==this.desiredCursorPosition)return this.desiredCursorPosition=-1,!0;for(let t=0;t<this.children.length;t++)if(this.children[t].focusCancelOnce())return!0;return!1}focusRestore(){if(-1!==this.desiredCursorPosition)return this.focus(0),!0;this.desiredCursorPosition=-1;for(let t=0;t<this.children.length;t++)if(this.children[t].focusRestore())return!0;let t=null;return this.desiredCursorPosition>0?t=this.firstAtomToTheRight():0===this.desiredCursorPosition&&(t=this.firstAtomToTheLeft()),null!==t&&(t.focus(0),!0)}setRangeStartEntireElement(t){this.element.childNodes.length>0?t.setStart(this.element.childNodes[0],0):(this.element.textContent,t.setStart(this.element,0))}setRangeEndEntireElement(t){this.element.childNodes.length>0?t.setEndAfter(this.element.lastChild):null===this.element.textContent?t.setEnd(this.element,0):t.setEnd(this.element,this.element.textContent.length)}setRangeStart(t,e){null!==t&&(!this.isAtomEditable()||e<0)?this.setRangeStartEntireElement(t):this.element.childNodes.length>0?t.setStart(this.element.childNodes[0],e):t.setStart(this.element,0)}setRangeEnd(t,e){!this.isAtomEditable()||e<0?this.setRangeEndEntireElement(t):this.element.childNodes.length>0?t.setEnd(this.element.childNodes[0],e):t.setEnd(this.element,0)}setCursorPosition(t){let e=window.getSelection();null!==this.element&&e.rangeCount<=0&&this.element.focus();let i=document.createRange(),n=!0;t>=this.element.textContent.length?(n=!1,i.selectNodeContents(this.element)):t>0?(n=!1,this.setRangeStart(i,t)):(n=!0,this.setRangeStart(i,0)),i.collapse(n),this.equationEditor.resetSelectionDOM(),e.addRange(i),this.positionCursorBeforeKeyEvents=t}isDetached(){let t=this;for(;null!==t.parent;)t=t.parent;return t.type.type!==r.root.type}boundingBoxForChildren(t){let e=new C;return e.left=this.boundingBox.left+t.left,e.top=this.boundingBox.top+t.top,e.width=this.boundingBox.width,e.height=this.boundingBox.height,e.fontSizeInPixels=this.type.fontSizeRatio*t.fontSizeInPixels,e}toScalableVectorGraphicsAtomic(t,e){let i=new L,n=e.left+this.boundingBox.left,o=e.top+this.boundingBox.top,s=this.boundingBox.height;1!==this.type.paddingBottomRatioForSVG&&(s*=this.type.paddingBottomRatioForSVG),o+=s,i.setX(n),i.setY(o),i.setAlignmentBaseline("text-after-edge"),i.setFontFamily(this.equationEditor.getFontFamily());let r=this.type.fontSizeRatio*e.fontSizeInPixels;0!=r&&i.setFontSize(r),""!==this.type.colorText&&i.setFontColor(this.type.colorText);let l=this.textContentOrInitialContent(),h=document.createTextNode(l);i.appendTextChild(h),t.appendChild(i.element)}toScalableVectorGraphicsBase(t,e){let i=this.boundingBoxForChildren(e);for(let e=0;e<this.children.length;e++)this.children[e].toScalableVectorGraphics(t,i)}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsBase(t,e)}toString(){const t=[];if(this.isAtomic()&&t.push(this.textContentOrInitialContent()),t.push(`[${this.type.type}]`),this.children.length>0){t.push("{");for(let e=0;e<this.children.length;e++)null!==this.children[e]?(t.push(this.children[e].toString()),e!==this.children.length-1&&t.push(",")):t.push("null");t.push("}")}return t.join("")}toHtmlDebugData(t){null==t&&(t=0);const e=[];let i=`${"-".repeat(t)}${this.type.type}[${this.constructor.name}]`;null!==this.element&&(i+=`[${this.element.textContent}]`),this.focused&&(i+=", F"),-1!==this.desiredCursorPosition&&(i+=`, FD[${this.desiredCursorPosition}]`),0!==this.boundingBox.width&&(i+=`, w: ${this.boundingBox.width}`),0!==this.boundingBox.height&&(i+=`, h: ${this.boundingBox.height}`),0!==this.boundingBox.left&&(i+=`, l: ${this.boundingBox.left}`),0!==this.boundingBox.top&&(i+=`, t: ${this.boundingBox.top}`),0!==this.boundingBox.fractionLineHeight&&(i+=`, fl: ${this.boundingBox.fractionLineHeight}`),this.type.type===r.atom.type&&(i+=`, cursor: ${this.positionCursorBeforeKeyEvents}, `),e.push(document.createTextNode(i));for(let i=0;i<this.children.length;i++){let n=this.children[i].toHtmlDebugData(t+1);for(let t=0;t<n.length;t++)e.push(n[t])}return e}toLatexWithAnnotationAtomic(t){let e=-1;null!==t&&t.useCursorCommand&&(e=this.desiredCursorPosition);let i=this.contentIfAtomic();return this.type.type===r.atomImmutable.type&&i in p.latexBackslashOperators?new w(`\\${i} `):p.convertUtf16ToLatex(i,e)}toLatex(){return this.toLatexWithAnnotation(null).latex}toLatexWithAnnotation(t){let e=[],i=new w("");for(let i=0;i<this.children.length;i++){let n=this.children[i];if(null===n){e.push("[[null]]");continue}let o=n.toLatexWithAnnotation(t);e.push(o.latex)}return i.latex=e.join(""),i}getMatrixCell(t,e){if(this.type.type!==r.matrix.type)return null;let i=this.children[0].children[1];if(t>=i.children.length)return null;let n=i.children[t];return e>=n.children.length?null:n.children[e]}matrixColumnCount(){if(this.type.type!==r.matrix.type)return-1;let t=this.children[0].children[1],e=0,i=t.children.length;for(let n=0;n<i;n++)e=Math.max(e,t.children[n].children.length);return e}drawOnCanvasBase(t,e){let i=this.boundingBoxForChildren(e);for(let e=0;e<this.children.length;e++)this.children[e].drawOnCanvas(t,i)}drawOnCanvas(t,e){0!==this.children.length&&this.drawOnCanvasBase(t,e)}drawOnCanvasAtomic(t,e){let i=e.left+this.boundingBox.left,n=e.top+this.boundingBox.top+this.boundingBox.fractionLineHeight;t.textBaseline="middle";let o=this.type.fontSizeRatio*e.fontSizeInPixels,s=this.equationEditor.getFontFamily();0!==o&&(t.font=`${o}px ${s}`),t.beginPath(),t.fillText(this.contentIfAtomic(),i,n,this.boundingBox.width),t.stroke()}}class A{constructor(t){this.element=t}appendChild(t){this.element.appendChild(t)}appendTextChild(t){this.element.appendChild(t)}}class k extends A{constructor(){super(document.createElementNS("http://www.w3.org/2000/svg","svg"))}setWidth(t){this.element.setAttribute("width",t)}setHeight(t){this.element.setAttribute("height",t)}}class L extends A{constructor(){super(document.createElementNS("http://www.w3.org/2000/svg","text"))}setX(t){this.element.setAttribute("x",t)}setY(t){this.element.setAttribute("y",t)}setAlignmentBaseline(t){this.element.setAttribute("alignment-baseline",t)}setFontFamily(t){this.element.setAttribute("font-family",t)}setFontSize(t){this.element.setAttribute("font-size",t)}setFontColor(t){this.element.setAttribute("font-color",t)}}class R extends A{constructor(){super(document.createElementNS("http://www.w3.org/2000/svg","line"))}setX1(t){this.element.setAttribute("x1",t)}setY1(t){this.element.setAttribute("y1",t)}setX2(t){this.element.setAttribute("x2",t)}setY2(t){this.element.setAttribute("y2",t)}setStroke(t){this.element.setAttribute("stroke",t)}setLineWidth(t){this.element.setAttribute("stroke-width",t)}}class v extends A{constructor(){super(document.createElementNS("http://www.w3.org/2000/svg","path"))}setPathString(t){this.element.setAttribute("d",t)}setStrokeColor(t){this.element.setAttribute("stroke",t)}setFillColor(t){this.element.setAttribute("fill",t)}setLineWidth(t){this.element.setAttribute("stroke-width",t)}}class M{constructor(){this.underConstruction=null}typeset(t){return this.underConstruction=new k,t.toScalableVectorGraphics(this.underConstruction.element,new C),this.underConstruction.setWidth(t.boundingBox.width),this.underConstruction.setHeight(t.boundingBox.height),this.underConstruction.element}}class D extends T{constructor(t){super(t,r.atom)}toLatexWithAnnotation(t){return this.toLatexWithAnnotationAtomic(t)}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsAtomic(t,e)}drawOnCanvas(t,e){this.drawOnCanvasAtomic(t,e)}}class P extends T{constructor(t){super(t,r.atomImmutable)}toLatexWithAnnotation(t){return this.toLatexWithAnnotationAtomic(t)}applyBackspaceToTheRight(){let t=this.parent;return t.children[this.indexInParent+1].desiredCursorPosition=0,t.removeChild(this.indexInParent),t.normalizeHorizontalMath(),t.updateDOM(),t.focusRestore(),!0}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsAtomic(t,e)}drawOnCanvas(t,e){this.drawOnCanvasAtomic(t,e)}}class I extends T{constructor(t){super(t,r.fraction),this.extraSpaceBetweenNumeratorAndDenominator=3,this.extraWidth=4}computeDimensions(){let t=this.children[0],e=this.children[1];this.boundingBox.fractionLineHeight=t.boundingBox.height+1,this.boundingBox.height=t.boundingBox.height+e.boundingBox.height+this.extraSpaceBetweenNumeratorAndDenominator,this.boundingBox.width=Math.max(t.boundingBox.width,e.boundingBox.width)+this.extraWidth,this.boundingBox.needsMiddleAlignment=!0,t.boundingBox.width=this.boundingBox.width,e.boundingBox.width=this.boundingBox.width,e.boundingBox.top=t.boundingBox.height+this.extraSpaceBetweenNumeratorAndDenominator,t.computeBoundingBoxLeftSingleChild(),e.computeBoundingBoxLeftSingleChild()}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsBase(t,e);let i=this.horizontalLineFromBoundingBoxParent(e),n=new R;n.setX1(i[0][0]),n.setX2(i[1][0]),n.setY1(i[0][1]),n.setY2(i[1][1]);let o=this.type.colorText;""===o&&(o="black"),n.setStroke(o),t.appendChild(n.element)}horizontalLineFromBoundingBoxParent(t){return[[t.left+this.boundingBox.left,t.top+this.boundingBox.top+this.boundingBox.fractionLineHeight],[t.left+this.boundingBox.left+this.boundingBox.width+this.extraWidth/2,t.top+this.boundingBox.top+this.boundingBox.fractionLineHeight]]}drawOnCanvas(t,e){this.drawOnCanvasBase(t,e);let i=this.horizontalLineFromBoundingBoxParent(e);t.beginPath(),t.moveTo(i[0][0],i[0][1]-this.extraSpaceBetweenNumeratorAndDenominator),t.lineTo(i[1][0],i[1][1]-this.extraSpaceBetweenNumeratorAndDenominator),t.stroke()}toLatexWithAnnotation(t){let e=this.children[0].toLatexWithAnnotation(t),i=this.children[1].toLatexWithAnnotation(t),n=new w(`\\frac{${e.latex}}{${i.latex}}`);if(this.children.length<=2)return n;n.latex+="[";for(let t=2;t<this.children.length;t++)n.latex+=this.children[t].toLatex();return n.latex+="]",n}applyBackspaceToTheRight(){return this.applyBackspaceToTheRightAsLeftArrow()}}class z extends T{constructor(t){super(t,r.numerator)}applyBackspaceToTheLeft(){return this.applyBackspaceToTheLeftWrapperChildWithSiblingWrapper()}}class q extends T{constructor(t){super(t,r.denominator)}applyBackspaceToTheLeft(){return this.applyBackspaceToTheLeftWrapperChildWithSiblingWrapper()}}class W extends T{constructor(t){super(t,r.baseWithExponent)}toLatexWithAnnotation(t){let e=this.children[0],i=e.toLatexWithAnnotation(t),n=this.children[1].toLatexWithAnnotation(t),o=!1;return e.type.type===r.fraction.type&&(o=!0),new w(o?`{${i.latex}}^{${n.latex}}`:`${i.latex}^{${n.latex}}`)}applyBackspaceToTheRight(){return this.applyBackspaceToTheRightAsLeftArrow()}applyBackspaceToTheLeft(){return this.applyBackspaceToTheLeftAsLeftArrow()}computeDimensions(){let t=this.children[0],e=this.children[1],i=.35;t.requiresTallExponent()&&(i=.1);let n=t.boundingBox.height*i;this.boundingBox.height=e.boundingBox.height+t.boundingBox.height-n,e.boundingBox.height>this.boundingBox.height&&(this.boundingBox.height=e.boundingBox.height),t.boundingBox.top=e.boundingBox.height-n,t.boundingBox.top<0&&(e.boundingBox.top=-t.boundingBox.top,t.boundingBox.top=0),t.boundingBox.left=0;let o=null;t.type.type===r.horizontalMath.type&&1===t.children.length&&t.children[0].type.type===r.baseWithSubscript.type&&(o=t.children[0]),null===o?(this.boundingBox.width=t.boundingBox.width+e.boundingBox.width,this.boundingBox.superScriptWidth=e.boundingBox.width,e.boundingBox.left=t.boundingBox.width):(this.boundingBox.width=Math.max(o.boundingBox.width+e.boundingBox.width-o.boundingBox.subScriptWidth,o.boundingBox.width),this.boundingBox.superScriptWidth=0,this.boundingBox.subScriptWidth=0,e.boundingBox.left=t.boundingBox.width-o.boundingBox.subScriptWidth),this.boundingBox.fractionLineHeight=t.boundingBox.top+t.boundingBox.fractionLineHeight,this.computeMiddleAlignment()}requiresTallExponent(){return this.children[0].requiresTallExponent()}}class $ extends T{constructor(t){super(t,r.horizontalMath)}toScalableVectorGraphics(t,e){let i=this.boundingBoxForChildren(e);for(let e=0;e<this.children.length;e++){this.children[e].toScalableVectorGraphics(t,i)}}computeDimensions(){this.computeDimensionsHorizontalMath()}computeDimensionsHorizontalMath(){this.boundingBox=new C,this.computeDimensionsParenthesesHeight();for(let t=0;t<this.children.length;t++){let e=this.children[t];e.boundingBox.left=this.boundingBox.width,this.boundingBox.width+=e.boundingBox.width}this.mergeVerticalComponentsBoundingBoxesHorizontallyAlignedElements(),this.computeMiddleAlignment(),this.computeLineBreaks()}computeLineBreaks(){null!==this.parent&&this.parent.type.type===r.root.type&&(this.equationEditor.options.lineBreakWidth<=0||this.computeLineBreaksPartTwo(this.equationEditor.options.lineBreakWidth))}computeLineBreaksPartTwo(t){let e=0,i=0;this.boundingBox.lineHeight=this.boundingBox.height;let n=0,o=!1,s=!1;for(let r=0;r<this.children.length;r++){let l=this.children[r],h=l.boundingBox.left+l.boundingBox.width,a=h-e;s&&a>0&&(o=!0,i++,s=!1),n=Math.max(a,n),l.boundingBox.top+=this.boundingBox.lineHeight*i,l.boundingBox.left-=e,a>t&&(e=h,s=!0)}this.boundingBox.height=this.boundingBox.lineHeight*(i+1),this.boundingBox.width=n,o&&(this.boundingBox.needsMiddleAlignment=!0),o||(this.boundingBox.lineHeight=-1)}requiresTallExponent(){for(let t=this.children.length-1;t>=0;t--){let e=this.children[t],i=e.type.type;if(i===r.matrix.type)return!0;if(i===r.rightDelimiter.type)return this.boundingBox.needsMiddleAlignment;if(i===r.baseWithSubscript.type||i===r.baseWithExponent.type)return e.requiresTallExponent();if(i!==r.atom.type||""!==e.textContentOrInitialContent())return!1}return!1}}class O extends T{constructor(t){super(t,r.genericMathBox)}toLatexWithAnnotation(t){let e=this.children[0].toLatexWithAnnotation(t),i=this.type.colorText;return new w(""===i?`{${e.latex}}`:`{\\color{${i}}{${e.latex}}}`)}}class H extends T{constructor(t){super(t,r.root)}computeDimensions(){if(this.computeDimensionsStandard(),this.boundingBox.lineHeight=this.children[0].boundingBox.lineHeight,this.equationEditor.options.editable)return;if(!this.boundingBox.needsMiddleAlignment)return void this.computeDimensionsBaselineAlignment();let t=this.boundingBox.height;this.boundingBox.lineHeight>0&&(t=this.boundingBox.lineHeight);let e=t-this.boundingBox.fractionLineHeight;e>this.boundingBox.fractionLineHeight?(this.boundingBox.height+=2*e-t,this.boundingBox.top+=e-this.boundingBox.fractionLineHeight,this.boundingBox.fractionLineHeight=e):this.boundingBox.height+=2*this.boundingBox.fractionLineHeight-t}computeDimensionsBaselineAlignment(){let t=this.findBaselineBox(new C);null!==t&&(this.boundingBox.top=this.boundingBox.height-(t.top+t.height))}prepareBoundingBox(t){let e=new C;e.top=t.top,e.left=t.left;let i=window.getComputedStyle(this.element,null).getPropertyValue("font-size");return e.fontSizeInPixels=parseInt(i,10),e}toScalableVectorGraphics(t,e){let i=this.prepareBoundingBox(e);this.children[0].toScalableVectorGraphics(t,i)}drawOnCanvas(t,e){let i=this.prepareBoundingBox(e);this.children[0].drawOnCanvas(t,i)}}class F extends T{constructor(t){super(t,r.error)}applyBackspaceToTheRight(){let t=this.parent;return t.children[this.indexInParent+1].desiredCursorPosition=0,t.removeChild(this.indexInParent),t.normalizeHorizontalMath(),t.updateDOM(),t.focusRestore(),!0}toLatexWithAnnotation(t){return new w(this.textContentOrInitialContent())}}class N extends T{constructor(t){super(t,r.cancel)}toLatexWithAnnotation(t){let e=this.children[1].toLatexWithAnnotation(t);return new w(`\\cancel{${e.latex}}`)}applyBackspaceToTheRight(){return this.applyBackspaceToTheRightAsLeftArrow()}computeDimensions(){let t=this.children[1];t.boundingBox.left=0,this.boundingBox.height=t.boundingBox.height,this.boundingBox.width=t.boundingBox.width,this.boundingBox.fractionLineHeight=t.boundingBox.fractionLineHeight;let e=this.children[0];e.boundingBox.width=4,e.boundingBox.height=t.boundingBox.height,e.boundingBox.left=0,null!==e.element&&(e.element.style.width=e.boundingBox.width,e.element.style.height=e.boundingBox.height);let i=t.boundingBox.width/e.boundingBox.height;e.boundingBox.transformOrigin="top left",e.boundingBox.transform=`matrix(1,0,${-i},1,${t.boundingBox.width},0)`}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsBase(t,e);let i=this.computeCoordinates(e),n=new R;n.setX1(i.leftX),n.setY1(i.leftY),n.setX2(i.rightX),n.setY2(i.rightY),n.setLineWidth(2);let o=this.type.colorText;""===o&&(o="black"),n.setStroke(o),t.appendChild(n.element)}computeCoordinates(t){return{leftX:t.left+this.boundingBox.left,leftY:t.top+this.boundingBox.top+this.boundingBox.height,rightX:t.left+this.boundingBox.left+this.boundingBox.width,rightY:t.top+this.boundingBox.top}}drawOnCanvas(t,e){this.drawOnCanvasBase(t,e);let i=this.computeCoordinates(e);t.beginPath(),t.lineWidth=2,t.moveTo(i.leftX,i.leftY),t.lineTo(i.rightX,i.rightY),t.stroke()}}class V extends T{constructor(t){super(t,r.cancelUnderBox)}applyBackspaceToTheLeft(){let t=this.parent,e=t.indexInParent,i=this.children[0];i.children[0].desiredCursorPosition=0;let n=t.parent;return n.replaceChildAtPosition(e,i.children[0]),n.normalizeHorizontalMath(),n.updateDOM(),n.focusRestore(),!0}}class K extends T{constructor(t){super(t,r.sqrtSign)}verticallyStretchSqrt(t){let e=this.children[0],i=this.children[1],n=this.children[2],o=.1*t;e.boundingBox.width=3,e.boundingBox.height=1,e.boundingBox.top=.5*t,o>10&&(o=10),i.boundingBox.height=.5*t,i.boundingBox.width=o,i.boundingBox.top=.5*t,i.boundingBox.left=e.boundingBox.width-1,n.boundingBox.height=t,n.boundingBox.width=1,n.boundingBox.left=i.boundingBox.left+o,n.boundingBox.top=0,i.boundingBox.transformOrigin="top left",n.boundingBox.transformOrigin="top left";let s=i.boundingBox.width/i.boundingBox.height;i.boundingBox.transform=`matrix(1,0,${s},1,0,0)`;let r=o/n.boundingBox.height;n.boundingBox.transform=`matrix(1,0,${-r},1,${o},0)`,this.boundingBox.height=t,this.boundingBox.width=i.boundingBox.width+o+e.boundingBox.width}}class G extends T{constructor(t){super(t,r.sqrt),this.sqrtProportionOverlapped=.7,this.widthSqrtSign=.99}toLatexWithAnnotation(t){if(null===this.element)return new w("[null(]");let e=new w(""),i=null,n=null;return this.children.length>0&&(i=this.children[0].toLatexWithAnnotation(t)),this.children.length>2&&(n=this.children[2].toLatexWithAnnotation(t)),null!==i&&""!==i.latex?(e.latex=`\\sqrt[${i.latex}]{${n.latex}}`,e):(e.latex=`\\sqrt{${n.latex}}`,e)}sqrtSignLeftShift(){let t=this.children[0],e=this.children[1];return Math.max(0,t.boundingBox.width-e.boundingBox.width*this.sqrtProportionOverlapped)}computeDimensions(){let t=this.children[0],e=this.children[1],i=this.children[2];e.verticallyStretchSqrt(i.boundingBox.height),t.boundingBox.top=-.15*t.boundingBox.height,e.boundingBox.left=this.sqrtSignLeftShift(),i.boundingBox.left=e.boundingBox.left+e.boundingBox.width*this.widthSqrtSign,this.boundingBox=new C,this.boundingBox.height=1.15*i.boundingBox.height,this.boundingBox.fractionLineHeight=i.boundingBox.fractionLineHeight+2.2;this.boundingBox.width=i.boundingBox.left+i.boundingBox.width+4,this.boundingBox.needsMiddleAlignment=i.boundingBox.needsMiddleAlignment}computeCoordinates(t){let e=this.children[1],i=e.children[0],n=e.children[1],o=e.children[2],s=this.children[2],r=t.top+this.boundingBox.top+e.boundingBox.top,l=t.left+this.boundingBox.left+e.boundingBox.left,h=r+n.boundingBox.top+n.boundingBox.height,a=l+o.boundingBox.left,d=r+i.boundingBox.top,c=l+i.boundingBox.left;return{bottom:h,midX:a,decorationY:d,decorationLeft:c,decorationRight:c+i.boundingBox.width,topY:r+o.boundingBox.top,rightX:t.left+this.boundingBox.left+s.boundingBox.left,overlineRight:t.left+this.boundingBox.left+s.boundingBox.left+s.boundingBox.width}}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsBase(t,e);let i=this.computeCoordinates(e),n=new v,o=`M ${i.decorationLeft} ${i.decorationY} L ${i.decorationRight} ${i.decorationY} `;o+=`L ${i.midX} ${i.bottom} `,o+=`L ${i.rightX} ${i.topY} `,o+=`L ${i.overlineRight} ${i.topY} `,n.setPathString(o);let s=this.type.colorText;""===s&&(s="black"),n.setStrokeColor(s),n.setFillColor("none"),t.appendChild(n.element)}drawOnCanvas(t,e){this.drawOnCanvasBase(t,e);let i=this.computeCoordinates(e);t.beginPath(),t.moveTo(i.decorationLeft,i.decorationY),t.lineTo(i.decorationRight,i.decorationY),t.lineTo(i.midX,i.bottom),t.lineTo(i.rightX,i.topY),t.lineTo(i.overlineRight,i.topY),t.stroke()}applyBackspaceToTheRight(){return this.applyBackspaceToTheRightAsLeftArrow()}}class U extends T{constructor(t){super(t,r.overLinedBox)}toLatexWithAnnotation(t){let e=this.children[0].toLatexWithAnnotation(t);return new w(`\\overline{${e.latex}}`)}}class Y extends T{constructor(t,e,i){super(t,r.formInput),this.value=e,this.name=i,this.initialContent=this.value}computeDimensions(){this.computeDimensionsStandard(),this.boundingBox.height=this.equationEditor.standardAtomHeight,0===this.boundingBox.height&&(this.boundingBox.height=20),this.boundingBox.width=this.value.length*this.boundingBox.height/2,this.boundingBox.fractionLineHeight=this.boundingBox.height/2}}class j extends T{constructor(t,e){super(t,r.horizontalBrace),this.pointsUp=e}radius(t){return Math.max(4,Math.floor(.08*t))}computeDimensions(){let t=this.parent.boundingBox.width;this.boundingBox.width=t;const e=this.children[0],i=this.children[1],n=this.children[2],o=this.children[3],s=this.children[4],r=this.children[5],l=this.radius(t),h=l,a=`${l}px`;this.pointsUp?(e.element.style.borderTopLeftRadius=a,e.element.style.borderTop="2px solid",n.element.style.borderBottomRightRadius=a,n.element.style.borderBottom="2px solid",o.element.style.borderBottomLeftRadius=a,o.element.style.borderBottom="2px solid",r.element.style.borderTopRightRadius=a,r.element.style.borderTop="2px solid"):(e.element.style.borderBottomLeftRadius=a,e.element.style.borderBottom="2px solid",n.element.style.borderTopRightRadius=a,n.element.style.borderTop="2px solid",o.element.style.borderTopLeftRadius=a,o.element.style.borderTop="2px solid",r.element.style.borderBottomRightRadius=a,r.element.style.borderBottom="2px solid");const d=t/2;e.boundingBox.width=l,r.boundingBox.width=l,n.boundingBox.width=l,o.boundingBox.width=l,e.boundingBox.height=h,n.boundingBox.height=h,o.boundingBox.height=h,r.boundingBox.height=h,this.pointsUp?(e.boundingBox.top=h,n.boundingBox.top=0,o.boundingBox.top=0,r.boundingBox.top=h):(e.boundingBox.top=0,n.boundingBox.top=h,o.boundingBox.top=h,r.boundingBox.top=0),n.boundingBox.left=d-l,o.boundingBox.left=d,r.boundingBox.left=t-l,i.boundingBox.width=d-2*l,i.boundingBox.left=l,s.boundingBox.width=d-2*l,s.boundingBox.left=d+l,i.boundingBox.height=h,s.boundingBox.height=h,this.boundingBox.height=2*h+2}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsBase(t,e);let i=new v,n=this.radius(this.boundingBox.width),o=this.pointsUp?n:-n,s=n/2,r=this.pointsUp?s:-s,l=e.top+this.boundingBox.top+this.boundingBox.height/2,h=e.left+this.boundingBox.left,a=this.pointsUp?1:0,d=1-a,c=this.boundingBox.width/2,u=h+c-n,p=h+c,m=h+c+n,g=h+this.boundingBox.width,x=`M ${h} ${l+o} `;x+=`A ${n} ${n} 0 0 ${a} ${h+n} ${l} `,x+=`L ${u} ${l} `,x+=`A ${n} ${n} 0 0 ${d} ${p} ${l-o} `,x+=`A ${n} ${n} 0 0 ${d} ${m} ${l} `,x+=`L ${g-n} ${l} `,x+=`A ${n} ${n} 0 0 ${a} ${g} ${l+o} `,x+=`A ${n} ${s} 0 0 ${d} ${g-n} ${l+r} `,x+=`L ${m} ${l+r} `,x+=`A ${n} ${s} 0 0 ${a} ${p} ${l} `,x+=`A ${n} ${s} 0 0 ${a} ${u} ${l+r} `,x+=`L ${h+n} ${l+r} `,x+=`A ${n} ${s} 0 0 ${d} ${h} ${l+o} `,i.setPathString(x);let f=this.type.colorText;""===f&&(f="black"),i.setStrokeColor("none"),i.setFillColor(f),t.appendChild(i.element)}drawOnCanvas(t,e){this.drawOnCanvasBase(t,e);let i=e.top+this.boundingBox.top+this.boundingBox.height/2,n=this.pointsUp?-1:1,o=this.radius(this.boundingBox.width),s=n*o,r=o/2,l=n*r,h=e.left+this.boundingBox.left,a=this.boundingBox.width/2,d=h+a-o,c=h+a,u=h+this.boundingBox.width,p=h+a+o;t.beginPath(),t.moveTo(h,i-s),t.ellipse(h+o,i-s,o,o,0,Math.PI,(1-.5*n)*Math.PI,!this.pointsUp),t.lineTo(d,i),t.ellipse(d,i+s,o,o,0,.5*-n*Math.PI,0,this.pointsUp),t.ellipse(c+o,i+s,o,o,0,Math.PI,.5*-n*Math.PI,this.pointsUp),t.lineTo(u-o,i),t.ellipse(u-o,i-s,o,o,0,n*Math.PI/2,0,!this.pointsUp),t.ellipse(u-o,i-s,o,r,0,0,n*Math.PI/2,this.pointsUp),t.lineTo(p,i-l),t.ellipse(c+o,i,o,r,0,.5*-n*Math.PI,Math.PI,!this.pointsUp),t.ellipse(d,i,o,r,0,0,.5*-n*Math.PI,!this.pointsUp),t.lineTo(h+o,i-l),t.ellipse(h+o,i-s,o,r,0,(1-.5*n)*Math.PI,Math.PI,this.pointsUp),t.fill()}}class Q extends T{constructor(t){super(t,r.overBrace)}computeDimensions(){let t=this.children[0],e=this.children[1],i=this.children[2];this.boundingBox.width=t.boundingBox.width,e.computeDimensions(),i.boundingBox.width=t.boundingBox.width,i.computeBoundingBoxLeftSingleChild(),this.boundingBox.height=t.boundingBox.height+e.boundingBox.height+i.boundingBox.height,this.boundingBox.fractionLineHeight=e.boundingBox.height+i.boundingBox.height+t.boundingBox.fractionLineHeight,e.boundingBox.top=i.boundingBox.height,t.boundingBox.top=i.boundingBox.height+e.boundingBox.height}toLatexWithAnnotation(t){let e=this.children[0].toLatexWithAnnotation(t),i=this.children[2].toLatexWithAnnotation(t);return new w(`\\overbrace{${e.latex}}^${i.latex}`)}}class X extends T{constructor(t){super(t,r.underBrace)}computeDimensions(){let t=this.children[0],e=this.children[1],i=this.children[2];this.boundingBox.width=t.boundingBox.width,e.computeDimensions(),i.boundingBox.width=t.boundingBox.width,i.computeBoundingBoxLeftSingleChild(),this.boundingBox.height=t.boundingBox.height+e.boundingBox.height+i.boundingBox.height,this.boundingBox.fractionLineHeight=t.boundingBox.fractionLineHeight,e.boundingBox.top=t.boundingBox.height,i.boundingBox.top=t.boundingBox.height+e.boundingBox.height}toLatexWithAnnotation(t){let e=this.children[0].toLatexWithAnnotation(t),i=this.children[2].toLatexWithAnnotation(t);return new w(`\\underbrace{${e.latex}}_${i.latex}`)}}class _ extends T{constructor(t){super(t,r.exponent)}applyBackspaceToTheLeft(){return this.applyBackspaceToTheLeftChildWithSiblingWrapper()}}class Z extends T{constructor(t){super(t,r.subscript)}applyBackspaceToTheLeft(){return this.applyBackspaceToTheLeftChildWithSiblingWrapper()}}class J extends T{constructor(t){super(t,r.baseWithSubscript)}computeDimensions(){this.computeDimensionsBaseWithSubscript()}computeDimensionsBaseWithSubscript(){let t=this.children[0],e=this.children[1],i=.35;t.requiresTallExponent()&&(i=.1);let n=t.boundingBox.height*i;this.boundingBox.height=e.boundingBox.height+t.boundingBox.height-n,e.boundingBox.height>this.boundingBox.height&&(this.boundingBox.height=e.boundingBox.height);let o=null;t.type.type===r.horizontalMath.type&&1===t.children.length&&t.children[0].type.type===r.baseWithExponent.type&&(o=t.children[0]),t.boundingBox.left=0,this.boundingBox.width=t.boundingBox.width+e.boundingBox.width,e.boundingBox.top=t.boundingBox.height*(1-i),null===o?(e.boundingBox.left=t.boundingBox.width,this.boundingBox.subScriptWidth=e.boundingBox.width):(e.boundingBox.left=t.boundingBox.width-o.boundingBox.superScriptWidth,this.boundingBox.superScriptWidth=0,this.boundingBox.subScriptWidth=0,this.boundingBox.width=Math.max(o.boundingBox.width+e.boundingBox.width-o.boundingBox.superScriptWidth,o.boundingBox.width)),this.boundingBox.fractionLineHeight=t.boundingBox.fractionLineHeight,this.boundingBox.needsMiddleAlignment=!0}toLatexWithAnnotation(t){let e=null,i=this.children[0].toLatexWithAnnotation(t),n=this.children[1].toLatexWithAnnotation(t);return e=this.children[0].isAtomicNonEmptyOrHorizontalMathWithNonEmptyAtomic()?new w(`${i.latex}_{${n.latex}}`):new w(`{${i.latex}}_{${n.latex}}`)}applyBackspaceToTheRight(){return this.applyBackspaceToTheRightAsLeftArrow()}requiresTallExponent(){return this.children[0].requiresTallExponent()}}class tt extends T{constructor(t){super(t,r.leftDelimiter)}toLatexWithAnnotation(t){let e=null;return e=0===this.children.length?new w("\\left."):"{"===this.extraData?new w("\\{"):new w(this.extraData)}applyBackspaceToTheRight(){return this.applyBackspaceToTheRightDelimiter()}computeDimensions(){this.computeDimensionsDelimiter()}}class et extends T{constructor(t){super(t,r.rightDelimiter)}toLatexWithAnnotation(t){let e=null;return e=0===this.children.length?new w("\\right."):"{"===this.extraData?new w("\\}"):new w(this.extraData)}applyBackspaceToTheRight(){return this.applyBackspaceToTheRightDelimiter()}computeDimensions(){this.computeDimensionsDelimiter()}}class it extends T{constructor(t,e){super(t,e?r.leftDelimiterMark:r.rightDelimiterMark),this.parenthesisThickness=0}verticallyStretchCommon(t,e){this.parenthesisThickness=t/24,this.parenthesisThickness=Math.min(3,this.parenthesisThickness),this.parenthesisThickness=Math.max(1.5,this.parenthesisThickness),t=Math.max(2*e,2*(t-e)),this.boundingBox.top=0,this.boundingBox.height=1.1*t,this.boundingBox.fractionLineHeight=this.boundingBox.height/2}}class nt extends it{constructor(t,e){super(t,e),this.left=e}verticallyStretch(t,e){this.verticallyStretchCommon(t,e),this.boundingBox.width=Math.max(t/6,3),this.element.style.borderWidth=`${this.parenthesisThickness}px`}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsBase(t,e);let i=new v,n=this.computeCoordinates(e),o=`M ${n.x} ${n.yLow} L ${n.x} ${n.yHigh}`;i.setPathString(o),i.setLineWidth(this.parenthesisThickness);let s=this.type.colorText;""===s&&(s="black"),i.setStrokeColor(s),i.setFillColor("none"),t.appendChild(i.element)}computeCoordinates(t){let e=t.left+this.boundingBox.left;this.left||(e+=this.boundingBox.width);let i=t.top+this.boundingBox.top;return{x:e,yLow:i+this.boundingBox.height-this.parenthesisThickness,yHigh:i+=this.parenthesisThickness}}drawOnCanvas(t,e){this.drawOnCanvasBase(t,e);let i=this.computeCoordinates(e);t.beginPath(),t.lineWidth=this.parenthesisThickness,t.moveTo(i.x,i.yLow),t.lineTo(i.x,i.yHigh),t.stroke()}}class ot extends it{constructor(t,e){super(t,e),this.left=e}verticallyStretchBase(t,e){this.verticallyStretchCommon(t,e),this.parenthesisThickness=t/30,this.parenthesisThickness=Math.max(.5,this.parenthesisThickness),this.parenthesisThickness=Math.min(3,this.parenthesisThickness),this.boundingBox.width=t/5,this.boundingBox.width=Math.min(this.boundingBox.width,10),this.boundingBox.width=Math.max(this.boundingBox.width,2);this.left?this.boundingBox.left=1:this.boundingBox.left=-1}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsBase(t,e);let i=new v,n=this.computeBracketCoordinates(e),o=`M ${n.xStart} ${n.yLow} L ${n.xMiddle} ${n.yLow} L ${n.xMiddle} ${n.yHigh} L ${n.xStart} ${n.yHigh}`;i.setPathString(o),i.setLineWidth(this.parenthesisThickness);let s=this.type.colorText;""===s&&(s="black"),i.setStrokeColor(s),i.setFillColor("none"),t.appendChild(i.element)}computeBracketCoordinates(t){let e=t.left+this.boundingBox.left,i=t.left+this.boundingBox.left;this.left?e+=this.boundingBox.width:i+=this.boundingBox.width;let n=t.top+this.boundingBox.top,o=n+this.boundingBox.height-this.parenthesisThickness;return{xStart:e,xMiddle:i,yHigh:n+=this.parenthesisThickness,yLow:o}}drawOnCanvas(t,e){this.drawOnCanvasBase(t,e);let i=this.computeBracketCoordinates(e);t.beginPath(),t.moveTo(i.xStart,i.yLow),t.lineTo(i.xMiddle,i.yLow),t.lineTo(i.xMiddle,i.yHigh),t.lineTo(i.xStart,i.yHigh),t.stroke()}}class st extends ot{constructor(t,e){super(t,e)}verticallyStretch(t,e){this.verticallyStretchBase(t,e),null!==this.element&&(this.element.style.borderTop="solid",this.element.style.borderBottom="solid",this.element.style.borderWidth=`${this.parenthesisThickness}px`)}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsBase(t,e);let i=new v,n=this.computeBracketCoordinates(e),o=`M ${n.xStart} ${n.yLow} L ${n.xMiddle} ${n.yLow} L ${n.xMiddle} ${n.yHigh} L ${n.xStart} ${n.yHigh}`;i.setPathString(o),i.setLineWidth(this.parenthesisThickness);let s=this.type.colorText;""===s&&(s="black"),i.setStrokeColor(s),i.setFillColor("none"),t.appendChild(i.element)}drawOnCanvas(t,e){this.drawOnCanvasBase(t,e);let i=this.computeBracketCoordinates(e);t.beginPath(),t.moveTo(i.xStart,i.yLow),t.lineTo(i.xMiddle,i.yLow),t.lineTo(i.xMiddle,i.yHigh),t.lineTo(i.xStart,i.yHigh),t.stroke()}}class rt extends ot{constructor(t,e){super(t,e)}verticallyStretch(t,e){this.verticallyStretchBase(t,e),null!==this.element&&(this.element.style.borderBottom="solid",this.element.style.borderWidth=`${this.parenthesisThickness}px`)}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsBase(t,e);let i=new v,n=this.computeBracketCoordinates(e),o=`M ${n.xStart} ${n.yLow} L ${n.xMiddle} ${n.yLow} L ${n.xMiddle} ${n.yHigh}`;i.setPathString(o),i.setLineWidth(this.parenthesisThickness);let s=this.type.colorText;""===s&&(s="black"),i.setStrokeColor(s),i.setFillColor("none"),t.appendChild(i.element)}drawOnCanvas(t,e){this.drawOnCanvasBase(t,e);let i=this.computeBracketCoordinates(e);t.beginPath(),t.moveTo(i.xStart,i.yLow),t.lineTo(i.xMiddle,i.yLow),t.lineTo(i.xMiddle,i.yHigh),t.stroke()}}class lt extends ot{constructor(t,e){super(t,e)}verticallyStretch(t,e){this.verticallyStretchBase(t,e),null!==this.element&&(this.element.style.borderTop="solid",this.element.style.borderWidth=`${this.parenthesisThickness}px`)}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsBase(t,e);let i=new v,n=this.computeBracketCoordinates(e),o=`M ${n.xMiddle} ${n.yLow} L ${n.xMiddle} ${n.yHigh} L ${n.xStart} ${n.yHigh}`;i.setPathString(o),i.setLineWidth(this.parenthesisThickness);let s=this.type.colorText;""===s&&(s="black"),i.setStrokeColor(s),i.setFillColor("none"),t.appendChild(i.element)}drawOnCanvas(t,e){this.drawOnCanvasBase(t,e);let i=this.computeBracketCoordinates(e);t.beginPath(),t.moveTo(i.xMiddle,i.yLow),t.lineTo(i.xMiddle,i.yHigh),t.lineTo(i.xStart,i.yHigh),t.stroke()}}class ht extends it{constructor(t,e){super(t,e),this.left=e}verticallyStretch(t,e){this.verticallyStretchCommon(t,e);let i=this.children[0],n=this.children[1],o=this.boundingBox.height/2,s=t/6;i.boundingBox.height=o,n.boundingBox.height=o,i.boundingBox.width=this.parenthesisThickness,n.boundingBox.width=this.parenthesisThickness,n.boundingBox.top=o;i.boundingBox.left=2,n.boundingBox.left=2,i.boundingBox.transformOrigin="top left",n.boundingBox.transformOrigin="top left";let r=s/o;this.left?(i.boundingBox.transform=`matrix(1,0,${-r},1,${s},0)`,n.boundingBox.transform=`matrix(1,0,${r},1,0,0)`):(i.boundingBox.transform=`matrix(1,0,${r},1,0,0)`,n.boundingBox.transform=`matrix(1,0,${-r},1,${s},0)`),this.element.style.borderLeft="",this.element.style.borderRight="",this.boundingBox.width=Math.max(s+4+2*this.parenthesisThickness,3),this.element.style.borderWidth=`${this.parenthesisThickness}px`}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsBase(t,e);let i=new v,n=this.computeCoordinates(e),o=`M ${n.xEnd} ${n.yLow} L ${n.xMiddle} ${n.yMiddle} L ${n.xEnd} ${n.yHigh}`;i.setPathString(o),i.setLineWidth(this.parenthesisThickness);let s=this.type.colorText;""===s&&(s="black"),i.setStrokeColor(s),i.setFillColor("none"),t.appendChild(i.element)}computeCoordinates(t){let e=this.boundingBox.height/1.1/6,i=t.left+this.boundingBox.left,n=t.left+this.boundingBox.left+e;if(!this.left){let t=i;i=n,n=t}let o=t.top+this.boundingBox.top,s=o+this.boundingBox.height-this.parenthesisThickness;return{xEnd:n,xMiddle:i,yLow:s,yHigh:o+=this.parenthesisThickness,yMiddle:(o+s)/2}}drawOnCanvas(t,e){this.drawOnCanvasBase(t,e);let i=this.computeCoordinates(e);t.beginPath(),t.lineWidth=this.parenthesisThickness,t.moveTo(i.xEnd,i.yLow),t.lineTo(i.xMiddle,i.yMiddle),t.lineTo(i.xEnd,i.yHigh),t.stroke()}}class at extends it{constructor(t,e){super(t,e),this.left=e}verticallyStretch(t,e){this.verticallyStretchCommon(t,e),this.boundingBox.width=Math.min(this.boundingBox.height/4,20),this.element.style.borderLeft="",this.element.style.borderRight="";let i=this.scale(),n=this.boundingBox.height/2,o=this.children[0];o.element.style.borderRadius=`${n}px`,o.element.style.borderWidth=`${this.borderWidth()}px`,o.boundingBox.width=this.boundingBox.height,o.boundingBox.height=this.boundingBox.height,o.boundingBox.transformOrigin="top left",o.boundingBox.left+=this.horizontalShift(),o.boundingBox.transform=`matrix(${i},0,0,1,0,0)`}scale(){return this.boundingBox.width/this.boundingBox.height}borderWidth(){return this.parenthesisThickness/this.scale()}horizontalShift(){let t=this.boundingBox.width/3.5;return this.left?t:-t}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsParenthesis(t,e)}computeArcs(t){let e=this.parenthesisThickness+1;this.left||(e*=-1);let i=t.left+this.boundingBox.left+this.horizontalShift()+e;this.left||(i+=this.boundingBox.width);let n=t.top+this.boundingBox.top,o=t.top+this.boundingBox.height;if(this.left){let t=n;n=o,o=t}let s=this.boundingBox.width/2,r=s-this.parenthesisThickness;return r<0&&(r=s/2),{x:i,startY:n,endY:o,rx:s,rxInner:r,ry:this.boundingBox.height/2}}toScalableVectorGraphicsParenthesis(t,e){this.toScalableVectorGraphicsBase(t,e);let i=new v,n=this.computeArcs(e),o=n.x,s=n.startY,r=n.endY,l=n.rx,h=n.ry,a=`${`M ${o} ${s}`} ${`A ${l} ${h} 180 1 1 ${o} ${r}`} ${`A ${n.rxInner} ${h} 180 0 0 ${o} ${s}`}`;i.setPathString(a);let d=this.type.colorText;""===d&&(d="black"),i.setStrokeColor("none"),i.setFillColor(d),t.appendChild(i.element)}drawOnCanvas(t,e){this.drawOnCanvasBase(t,e);let i=this.computeArcs(e),n=i.x,o=i.startY,s=i.endY,r=i.rx,l=i.ry,h=i.rxInner,a=(o+s)/2;t.beginPath(),t.ellipse(n,a,r,l,0,3*Math.PI/2,Math.PI/2,this.left),t.ellipse(n,a,h,l,0,Math.PI/2,3*Math.PI/2,!this.left),t.fill()}}class dt extends it{constructor(t,e){super(t,e),this.left=e}radius(){let t=Math.floor(this.boundingBox.height/12);return t<2&&(t=2),t}verticallyStretch(t,e){this.verticallyStretchCommon(t,e);let i=this.children[1],n=this.children[4],o=this.radius(),s=(this.boundingBox.height-4*o)/2;this.boundingBox.width=2*o+1,this.boundingBox.height+=o;let r=`${this.parenthesisThickness}px`;i.boundingBox.width=this.parenthesisThickness,i.boundingBox.top=o,i.boundingBox.height=s,i.boundingBox.left=o,i.element.style.borderWidth=r,n.boundingBox.width=this.parenthesisThickness,n.boundingBox.height=s,n.boundingBox.top=s+3*o,n.boundingBox.left=o,n.element.style.borderWidth=r;let l=this.children[0],h=this.children[2],a=this.children[3],d=this.children[5],c=[l,h,a,d];for(let t=0;t<c.length;t++){let e=c[t];e.boundingBox.width=o,e.boundingBox.height=o,e.element.style.borderWidth=r}let u=`${o}px`;l.boundingBox.top=0,l.boundingBox.left=this.left?o:0,h.boundingBox.top=s+o,h.boundingBox.left=this.left?0:o,a.boundingBox.top=s+2*o,a.boundingBox.left=this.left?0:o,d.boundingBox.top=2*s+3*o,d.boundingBox.left=this.left?o:0,null!==this.element&&(this.element.style.borderLeft="",this.element.style.borderRight="");let p=`solid ${r}`;this.left?(l.element.style.borderTopLeftRadius=u,l.element.style.borderLeft=p,h.element.style.borderBottomRightRadius=u,h.element.style.borderRight=p,a.element.style.borderTopRightRadius=u,a.element.style.borderRight=p,d.element.style.borderBottomLeftRadius=u,d.element.style.borderLeft=p):(l.element.style.borderTopRightRadius=u,l.element.style.borderRight=p,h.element.style.borderBottomLeftRadius=u,h.element.style.borderLeft=p,a.element.style.borderTopLeftRadius=u,a.element.style.borderLeft=p,d.element.style.borderBottomRightRadius=u,d.element.style.borderRight=p)}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsBase(t,e);let i=new v,n=this.computeCoordinates(e),o=`M ${n.xEnd} ${n.yLow} `;o+=`A ${n.radius} ${n.radius} 0 0 ${n.arcChoiceBottom} ${n.xMiddle} ${n.yLow-n.radius} `,o+=`L ${n.xMiddle} ${n.yMiddle+n.radius} `,o+=`A ${n.radius} ${n.radius} 0 0 ${n.arcChoiceOther} ${n.xStickyPart} ${n.yMiddle} `,o+=`A ${n.radius} ${n.radius} 0 0 ${n.arcChoiceOther} ${n.xMiddle} ${n.yMiddle-n.radius} `,o+=`L ${n.xMiddle} ${n.yHigh+n.radius} `,o+=`A ${n.radius} ${n.radius} 0 0 ${n.arcChoiceBottom} ${n.xEnd} ${n.yHigh} `,o+=`A ${n.radius} ${n.radius} 0 0 ${n.arcChoiceOther} ${n.xMiddle+n.thicknessShift} ${n.yHigh+n.radius} `,o+=`L ${n.xMiddle+n.thicknessShift} ${n.yMiddle-n.radius} `,o+=`A ${n.radius} ${n.radius} 0 0 ${n.arcChoiceBottom} ${n.xStickyPart+n.thicknessShift} ${n.yMiddle} `,o+=`A ${n.radius} ${n.radius} 0 0 ${n.arcChoiceBottom} ${n.xMiddle+n.thicknessShift} ${n.yMiddle+n.radius} `,o+=`L ${n.xMiddle+n.thicknessShift} ${n.yLow-n.radius} `,o+=`A ${n.radius} ${n.radius} 0 0 ${n.arcChoiceOther} ${n.xEnd} ${n.yLow} `,i.setPathString(o);let s=this.type.colorText;""===s&&(s="black"),i.setStrokeColor("none"),i.setFillColor(s),t.appendChild(i.element)}drawOnCanvas(t,e){this.drawOnCanvasBase(t,e);let i=this.computeCoordinates(e);t.beginPath(),this.left?(t.ellipse(i.xMiddle+i.radius,i.yLow-i.radius,i.radius,i.radius,0,Math.PI/2,Math.PI,!1),t.lineTo(i.xMiddle,i.yMiddle+i.radius),t.ellipse(i.xMiddle-i.radius,i.yMiddle+i.radius,i.radius,i.radius,0,0,-Math.PI/2,!0),t.ellipse(i.xMiddle-i.radius,i.yMiddle-i.radius,i.radius,i.radius,0,Math.PI/2,0,!0),t.lineTo(i.xMiddle,i.yHigh+i.radius),t.ellipse(i.xMiddle+i.radius,i.yHigh+i.radius,i.radius,i.radius,0,Math.PI,3*Math.PI/2,!1),t.ellipse(i.xMiddle+i.radius,i.yHigh+i.radius,i.radius-this.parenthesisThickness,i.radius,0,3*Math.PI/2,Math.PI,!0),t.lineTo(i.xMiddle+this.parenthesisThickness,i.yMiddle-i.radius),t.ellipse(i.xMiddle-i.radius+this.parenthesisThickness,i.yMiddle-i.radius,i.radius,i.radius,0,0,Math.PI/2,!1),t.ellipse(i.xMiddle-i.radius+this.parenthesisThickness,i.yMiddle+i.radius,i.radius,i.radius,0,3*Math.PI/2,2*Math.PI,!1),t.lineTo(i.xMiddle+this.parenthesisThickness,i.yLow-i.radius),t.ellipse(i.xMiddle+i.radius,i.yLow-i.radius,i.radius-this.parenthesisThickness,i.radius,0,Math.PI,Math.PI/2,!0)):(t.ellipse(i.xMiddle-i.radius,i.yLow-i.radius,i.radius,i.radius,0,Math.PI/2,0,!0),t.lineTo(i.xMiddle,i.yMiddle+i.radius),t.ellipse(i.xMiddle+i.radius,i.yMiddle+i.radius,i.radius,i.radius,0,Math.PI,3*Math.PI/2,!1),t.ellipse(i.xMiddle+i.radius,i.yMiddle-i.radius,i.radius,i.radius,0,Math.PI/2,Math.PI,!1),t.lineTo(i.xMiddle,i.yHigh+i.radius),t.ellipse(i.xMiddle-i.radius,i.yHigh+i.radius,i.radius,i.radius,0,0,-Math.PI/2,!0),t.ellipse(i.xMiddle-i.radius,i.yHigh+i.radius,i.radius-this.parenthesisThickness,i.radius,0,-Math.PI/2,0,!1),t.lineTo(i.xMiddle-this.parenthesisThickness,i.yMiddle-i.radius),t.ellipse(i.xMiddle+i.radius-this.parenthesisThickness,i.yMiddle-i.radius,i.radius,i.radius,0,Math.PI,Math.PI/2,!0),t.ellipse(i.xMiddle+i.radius-this.parenthesisThickness,i.yMiddle+i.radius,i.radius,i.radius,0,3*Math.PI/2,Math.PI,!0),t.lineTo(i.xMiddle-this.parenthesisThickness,i.yLow-i.radius),t.ellipse(i.xMiddle-i.radius,i.yLow-i.radius,i.radius-this.parenthesisThickness,i.radius,0,0,Math.PI/2,!1)),t.fill()}computeCoordinates(t){let e=this.radius(),i=t.left+this.boundingBox.left,n=i+e,o=i,s=i;this.left?s+=2*e:o+=2*e;let r=t.top+this.boundingBox.top,l=r+this.boundingBox.height,h=(r+l)/2,a=0,d=1;this.left&&(a=1,d=0);let c=this.parenthesisThickness;return this.left||(c*=-1),{radius:e,xEnd:s,xMiddle:n,xLeft:i,yLow:l,yMiddle:h,yHigh:r,arcChoiceBottom:a,arcChoiceOther:d,xStickyPart:o,thicknessShift:c}}}class ct extends T{constructor(t,e){super(t,r.matrix),this.matrixEnvironment=e}toLatexWithAnnotation(t){if(null===this.element)return new w("[(null)]");let e=this.children[0].children[1];if(this.isBinom()){let i=e.children[0].children[0].toLatexWithAnnotation(t).latex,n=e.children[1].children[0].toLatexWithAnnotation(t).latex;return new w(`\\binom{${i}}{${n}}`)}let i=[];i.push(`\\begin{${this.matrixEnvironment}}`),"array"===this.matrixEnvironment&&(i.push("{"),i.push(this.latexExtraStyle),i.push("}"));let n=[];for(let i=0;i<e.children.length;i++){let o=e.children[i],s=[];for(let e=0;e<o.children.length;e++){let i=o.children[e];s.push(i.toLatexWithAnnotation(t).latex)}n.push(s.join("&"))}return i.push(n.join("\\\\")),i.push(`\\end{${this.matrixEnvironment}}`),new w(i.join(""))}isBinom(){if("binom"!==this.matrixEnvironment)return!1;let t=this.children[0].children[1];return 2===t.children.length&&(1===t.children[0].children.length&&1===t.children[1].children.length)}applyBackspaceToTheRight(){let t=this.parent;return t.removeChild(this.indexInParent),t.normalizeHorizontalMath(),t.updateDOM(),t.focusRestore(),!0}appendHorizontalAboveLastRow(){let t=this.children[0].children[1];0!==t.children.length&&t.children[t.children.length-1].addTopBorder()}getLastMatrixRow(){let t=this.children[0].children[1];return 0===t.children.length?null:t.children[t.children.length-1]}normalizeMatrix(){let t=this.children[0].children[1],e=this.matrixColumnCount(),i=t.children.length,n=t.children[i-1];if(0===n.children.length){if(i>1&&n.topLineCount>0){t.children[i-2].addBottomBorder()}i--,t.removeChild(i)}for(let i=0;i<t.children.length;i++){let n=t.children[i];for(let t=n.children.length;t<e;t++)n.appendChild(Rt.matrixRowEntry(this.equationEditor,null))}}}class ut extends T{constructor(t){super(t,r.radicalUnderBox)}applyBackspaceToTheLeft(){let t=this.parent,e=t.indexInParent,i=t.children[0].children[0];this.children[0].children[0].desiredCursorPosition=0;let n=t.parent;return n.replaceChildAtPositionWithChildren(e,[i,t.children[2].children[0]]),n.normalizeHorizontalMath(),n.updateDOM(),n.focusRestore(),!0}}class pt extends T{constructor(t){super(t,r.matrixRow),this.topLineCount=0,this.bottomLineCount=0}applyBackspaceToTheLeft(){return this.indexInParent>0?this.parent.children[this.indexInParent-1].applyBackspaceToTheRightAsLeftArrow():this.parent.parent.parent.applyBackspaceToTheLeftAsLeftArrow()}addTopBorder(){this.topLineCount++,this.type.borderTop="1px solid black"}addBottomBorder(){this.bottomLineCount++,this.type.borderBottom="1px solid black"}}class mt extends T{constructor(t){super(t,r.matrixRowEntry)}applyBackspaceToTheLeft(){return this.indexInParent>0?this.parent.children[this.indexInParent-1].applyBackspaceToTheRightAsLeftArrow():this.parent.applyBackspaceToTheLeft()}getAtomToFocusFromAction(t,e){if(e===o.firstAtomDown){let t=this.parent,e=t.parent;if(t.indexInParent+1<e.children.length)return new l(e.children[t.indexInParent+1].children[this.indexInParent],-1)}if(e===o.firstAtomUp){let t=this.parent,e=t.parent;if(t.indexInParent>0)return new l(e.children[t.indexInParent-1].children[this.indexInParent],1)}return this.getAtomToFocusFromActionDefault(t,e)}}class gt extends T{constructor(t){super(t,r.verticalLineInTable)}toScalableVectorGraphics(t,e){this.toScalableVectorGraphicsBase(t,e);let i=new R,n=this.boundingBox.left+e.left,o=this.boundingBox.top+e.top,s=o+this.boundingBox.height;i.setX1(n),i.setX2(n),i.setY1(s),i.setY2(o);let r=this.type.colorText;""===r&&(r="black"),i.setStroke(r),t.appendChild(i.element)}}class xt extends T{constructor(t){super(t,r.operatorWithSuperAndSubscript)}toLatexWithAnnotation(t){let e=this.children[0].toLatexWithAnnotation(t).latex,i=this.children[1].toLatexWithAnnotation(t).latex,n=this.children[2].toLatexWithAnnotation(t).latex;return""!==n&&(i+=`_{${n}}`),""!==e&&(i+=`^{${e}}`),new w(i)}applyBackspaceToTheRight(){return this.applyBackspaceToTheRightAsLeftArrow()}applyBackspaceToTheLeftEndOfOperatorSubscript(){let t=this.children[0],e=this.children[2],i=Rt.horizontalMathFromArray(this.equationEditor,[t.children[0],e.children[0]]);i.normalizeHorizontalMath();let n=this.parent,o=this.indexInParent;return n.replaceChildAtPosition(o,i),n.normalizeHorizontalMath(),n.updateDOM(),n.focusRestore(),!0}computeDimensions(){this.computeDimensionsOperatorWithSuperAndSubscript()}computeDimensionsOperatorWithSuperAndSubscript(){let t=this.children[0],e=this.children[1],i=this.children[2];t.boundingBox.top=0,e.boundingBox.top=t.boundingBox.height,i.boundingBox.top=t.boundingBox.height+e.boundingBox.height,this.boundingBox.height=t.boundingBox.height+e.boundingBox.height+i.boundingBox.height,this.boundingBox.width=Math.max(t.boundingBox.width,e.boundingBox.width,i.boundingBox.width),this.boundingBox.fractionLineHeight=t.boundingBox.height+e.boundingBox.fractionLineHeight,this.boundingBox.needsMiddleAlignment=!0,t.boundingBox.width=this.boundingBox.width,i.boundingBox.width=this.boundingBox.width,e.boundingBox.width=this.boundingBox.width,t.computeBoundingBoxLeftSingleChild(),e.computeBoundingBoxLeftSingleChild(),i.computeBoundingBoxLeftSingleChild()}}class ft extends T{constructor(t){super(t,r.operatorStandalone)}toLatexWithAnnotation(t){p.computeUtf16ToLatexMap();const e=this.textContentOrInitialContent();return e in p.utf16ToLatexMap?new w(p.utf16ToLatexMap[e]):new w(`\\${e}`)}computeDimensions(){this.computeDimensionsOperatorStandalone()}computeDimensionsOperatorStandalone(){let t=this.children[0],e={"∑":.066,"∫":.066},i={"∑":1.033,"∫":1},n=0,o=t.initialContent;o in e&&(n=e[o]);let s=1;o in i&&(s=i[o]);let r=t.boundingBox.height;t.boundingBox.top=-r*n,this.boundingBox.height=r*s,this.boundingBox.width=t.boundingBox.width,this.boundingBox.fractionLineHeight=r*(s+n)/2}}class bt extends T{constructor(t){super(t,r.operatorWithSubscript)}applyBackspaceToTheRight(){return this.applyBackspaceToTheRightAsLeftArrow()}applyBackspaceToTheLeftEndOfOperatorSubscript(){let t=this.children[1],e=Rt.horizontalMathFromArray(this.equationEditor,[t.children[0]]);e.normalizeHorizontalMath();let i=this.parent,n=this.indexInParent;return i.replaceChildAtPosition(n,e),i.normalizeHorizontalMath(),i.updateDOM(),i.focusRestore(),!0}computeDimensions(){let t=this.children[0],e=this.children[1],i=.1*t.boundingBox.height;t.boundingBox.top=0,e.boundingBox.top=t.boundingBox.height+i,this.boundingBox.height=t.boundingBox.height+i+e.boundingBox.height,this.boundingBox.width=Math.max(t.boundingBox.width,e.boundingBox.width),this.boundingBox.fractionLineHeight=t.boundingBox.fractionLineHeight,this.boundingBox.needsMiddleAlignment=!0,e.boundingBox.width=this.boundingBox.width,t.boundingBox.width=this.boundingBox.width,t.computeBoundingBoxLeftSingleChild(),e.computeBoundingBoxLeftSingleChild()}toLatexWithAnnotation(t){let e=this.children[0].toLatexWithAnnotation(t).latex,i=this.children[1].toLatexWithAnnotation(t).latex;return""!==i&&(e+=`_{${i}}`),new w(e)}}class yt extends T{constructor(t){super(t,r.operatorSubscript)}applyBackspaceToTheLeft(){return this.parent.applyBackspaceToTheLeftEndOfOperatorSubscript()}}class Bt extends T{constructor(t){super(t,r.operatorSuperscript)}applyBackspaceToTheLeft(){return this.parent.applyBackspaceToTheLeftEndOfOperatorSubscript()}}class St{constructor(t,e){this.columnIndex=t,this.stripIndex=e}}class Ct{constructor(t){this.style=t,this.nextStyleStartCharacter=0,this.currentColumnAlignment="",this.verticalBarRightCount=0,this.verticalBarLeftCount=0,this.exhausted=!1}reset(){this.nextStyleStartCharacter=0,this.currentColumnAlignment="",this.verticalBarRightCount=0,this.verticalBarLeftCount=0,this.exhausted=!1}next(){if(this.currentColumnAlignment="",this.verticalBarRightCount=0,this.verticalBarLeftCount=0,this.nextStyleStartCharacter>=this.style.length)this.exhausted=!0;else for(let t=this.nextStyleStartCharacter;t<this.style.length;t++){let e=this.style[t];if("c"===e||"r"===e||"l"===e){if(""!==this.currentColumnAlignment)return;this.currentColumnAlignment=e}this.nextStyleStartCharacter=t+1,"|"===e&&(""===this.currentColumnAlignment?this.verticalBarLeftCount++:this.verticalBarRightCount++)}}applyStyleToMatrix(t){if(t.type.type!==r.matrix.type)return;let e=t.children[0].children[1];for(let t=0;t<e.children.length;t++){let i=e.children[t];this.applyStyleToRow(i)}}applyStyleToRow(t){this.reset(),this.next();for(let e=0;e<t.children.length&&!this.isExhausted();e++,this.next())t.children[e].latexExtraStyle=this.currentColumnAlignment}verticalSeparators(t){this.reset(),this.next();let e=[],i=0;for(;!this.isExhausted();this.next()){for(let n=0;n<this.verticalBarLeftCount;n++)e.push(Rt.matrixVerticalLine(t,i,n));i++;for(let n=0;n<this.verticalBarRightCount;n++)e.push(Rt.matrixVerticalLine(t,i,n))}return e}borderFromVerticalBarCount(t){return t<=0?"":1===t?"1px solid black":"1px double black"}isExhausted(){return this.exhausted}}class wt{constructor(t,e){this.parent=t,this.indexInParent=e}}class Et{constructor(t,e,i,n,o){this.startIndex=t,this.startIndexData=e,this.closeIndexData=i,this.closeIndex=n,this.content=o.slice(this.startIndexData,i+1)}}class Tt{constructor(t){null==t&&(t={sanitizeLatexSource:!1,removeDisplayStyle:!1,logTiming:!1,extraAttributes:{},svgAndDOM:!1,svgOnly:!1,style:null,copyButton:!1}),this.sanitizeLatexSource=t.sanitizeLatexSource,void 0===this.sanitizeLatexSource&&(this.sanitizeLatexSource=!1),this.removeDisplayStyle=t.removeDisplayStyle,void 0===this.removeDisplayStyle&&(this.removeDisplayStyle=!1),this.logTiming=t.logTiming,void 0!==this.logTiming&&null!==this.logTiming||(this.logTiming=!1),this.logTiming&&console.log("Logging parsing speed times; to turn off, set logTiming=false."),this.extraAttributes=t.extraAttributes,null!==this.extraAttributes&&void 0!==this.extraAttributes||(this.extraAttributes={}),this.svgAndDOM=t.svgAndDOM,void 0!==this.svgAndDOM&&null!==this.svgAndDOM||(this.svgAndDOM=!1),this.svgOnly=t.svgOnly,null!==this.svgOnly&&void 0!==this.svgOnly||(this.svgOnly=!1),this.elementProcessed=null,this.hiddenContainer=null,this.startTime=0,this.lastTimeSample=0,this.typesetTimeout=50,this.elementsToTypeset=-1,this.typesetTotal=0;let e=t.style;this.copyButton=!1,!0===t.copyButton&&(this.copyButton=!0),null===e&&(e={display:"inline-block"});let i=document.createElement("DIV");for(let t in e)i.style[t]=e[t];this.style={fontFamily:i.style.fontFamily,display:i.style.display,fontSize:i.style.fontSize,verticalAlign:i.style.verticalAlign,marginBottom:i.style.marginBottom,maxWidth:i.style.maxWidth},this.mathElementsDOM=[],this.mathElementsSVG=[]}getMathTagEmpty(){let t=document.createElement("DIV");return t.style.fontFamily=this.style.fontFamily,t.style.display=this.style.display,t.style.fontSize=this.style.fontSize,t.style.verticalAlign=this.style.verticalAlign,t.style.marginBottom=this.style.marginBottom,t.style.maxWidth=this.style.maxWidth,t}convertTags(t,e){if(0===e.length)return;let i=t.textContent,n=[];for(let t=0;t<e.length;t++){let o=0;t>0&&(o=e[t-1].closeIndex+1);let s=i.slice(o,e[t].startIndex);s.length>0&&n.push(document.createTextNode(s));let r=this.getMathTagEmpty();if(r.textContent=e[t].content,r.className="mathcalculator",this.mathElementsDOM.push(r),n.push(r),this.svgOnly)this.mathElementsSVG.push(r);else if(this.svgAndDOM){let t=this.getMathTagEmpty();t.className="mathcalculatorSVG",this.mathElementsSVG.push(t),n.push(t)}}let o=e[e.length-1].closeIndex+1,s=i.slice(o);""!==s&&null!==s&&n.push(document.createTextNode(s)),t.textContent="";let r=document.createElement("span");for(let t=0;t<n.length;t++)r.appendChild(n[t]);t.parentElement.replaceChild(r,t)}processTextContent(t){if(""===t.textContent||null===t.textContent)return;let e=t.textContent,i=-1,n=[];for(let t=1;t<e.length;t++){let o=e[t-1],s=e[t];if("\\"===o)if(-1===i){if("("===s){i=t;continue}}else")"===s&&(n.push(new Et(i-1,i+1,t-2,t,e)),i=-1)}this.convertTags(t,n)}convertTagsRecursive(t,e){if(e>40)console.log("While converting mathtags, reached recursion depth limits");else if(0!==t.childNodes.length)for(let i=0;i<t.childNodes.length;i++)this.convertTagsRecursive(t.childNodes[i],e+1);else this.processTextContent(t)}typeset(t,e){this.elementProcessed=t,this.startTime=(new Date).getTime(),this.lastTimeSample=this.startTime;let i=document.getElementsByClassName("mathcalculator");null!==this.elementProcessed&&this.convertTagsRecursive(this.elementProcessed,0);for(let t=0;t<i.length;t++)this.mathElementsDOM.push(i[t]),this.mathElementsSVG.push(null);this.typesetMathTags(e)}postponeTypeset(t){let e=(new Date).getTime();return!(e-this.lastTimeSample<this.typesetTimeout||this.typesetTotal>=this.elementsToTypeset)&&(this.lastTimeSample=e,setTimeout(()=>{this.typesetMathTags(t)},10),this.logTiming&&console.log(`Typeset ${this.typesetTotal} out of ${this.elementsToTypeset} elements.`),!0)}typesetMathTags(t){for(this.elementsToTypeset<0&&(this.elementsToTypeset=this.mathElementsDOM.length,this.typesetTotal=0);this.typesetTotal<this.mathElementsDOM.length;this.typesetTotal++){if(this.postponeTypeset(t))return;let e=this.mathElementsDOM[this.typesetTotal],i=this.mathElementsSVG[this.typesetTotal];if("true"===e.typeset)continue;e.typeset="true";let n=(new Date).getTime();h(e,!1,this.sanitizeLatexSource,this.removeDisplayStyle,t,i,this.copyButton),this.svgOnly&&console.log("svgOnly not implemented yet.");let o=(new Date).getTime()-n;this.logTiming&&console.log(`Typeset of element ${this.typesetTotal+1} out of ${this.elementsToTypeset} took ${o} ms.`)}}}class At{constructor(t,e){this.command=t,this.isKeyPress=e}execute(t){this.isKeyPress?(t.focusInformation.restoreSelection(t),t.dispatchKey(this.command)):t.writeLatexLastFocused(this.command)}}class kt{constructor(t,e,i,n,o){this.commands=[],""!==t&&null!==t&&this.commands.push(new At(t,e)),this.label=i,this.additionalStyle={},null!=n&&(this.additionalStyle=n),this.className="",null!=o&&(this.className=o)}addEditorAction(t){this.commands.push(t)}getButton(t){let e=document.createElement("button");for(let t in this.additionalStyle)e.style[t]=this.additionalStyle[t];return e.textContent=this.label,""!==this.className&&(e.className=this.className),this.attachToClick(e,t)}attachToClick(t,e){return t.addEventListener("click",()=>{this.clickFunction(e)}),t}attachToClickById(t,e){let i=document.getElementById(t);return null===i?null:this.attachToClick(i,e)}clickFunction(t){for(let e=0;e<this.commands.length;e++)this.commands[e].execute(t)}}let Lt={plus:new kt("+",!0,"+",{width:"100%"},""),minus:new kt("-",!0,"-",{width:"100%"},""),product:new kt("*",!0,"*",{width:"100%"},""),divide:new kt("/",!0,"/",{width:"100%"},""),exponent:new kt("^",!0,"^",{width:"100%"},""),times:new kt("\\times",!0,"×",{width:"100%"},""),fraction:new kt("\\frac{\\cursor}{}",!1,"(•)/(•)",{width:"100%"},""),leftParenthesis:new kt("(",!0,"(",{width:"100%"},""),rightParenthesis:new kt(")",!0,")",{width:"100%"},""),sqrt:new kt("\\sqrt",!0,"√",{width:"100%"},""),integral:new kt("\\int",!1,"∫",{width:"100%"},""),sum:new kt("\\sum",!1,"Σ",{width:"100%"},""),prod:new kt("\\prod",!1,"Π",{width:"100%"},""),matrix2x2:new kt("\\begin{matrix}\\cursor&\\\\&\\end{matrix}",!1,"2x2",{width:"100%"},""),pmatrix2x2:new kt("\\begin{pmatrix}\\cursor&\\\\&\\end{pmatrix}",!1,"(2x2)",{width:"100%"},""),bmatrix2x2:new kt("\\begin{bmatrix}\\cursor&\\\\&\\end{bmatrix}",!1,"[2x2]",{width:"100%"},""),bmatrix3x3:new kt("\\begin{bmatrix}\\cursor&&\\\\&&\\\\&&\\end{bmatrix}",!1,"[3x3]",{width:"100%"},""),bmatrix1x3:new kt("\\begin{bmatrix}\\cursor \\\\~\\\\~ \\end{bmatrix}",!1,"[1x3]",{width:"100%"},""),bmatrix1x2:new kt("\\begin{bmatrix}\\cursor \\\\~\\end{bmatrix}",!1,"[1x2]",{width:"100%"},""),bmatrix2x1:new kt("\\begin{bmatrix}\\cursor &~ \\end{bmatrix}",!1,"[2x1]",{width:"100%"},""),cases2x1:new kt("\\begin{cases}\\cursor \\\\~ \\end{cases}",!1,"{2x1",{width:"100%"},""),cases3x1:new kt("\\begin{cases}\\cursor\\\\ ~\\\\ ~\\end{cases}",!1,"{3x1",{width:"100%"},""),cases3x3:new kt("\\begin{cases}\\cursor&=&\\\\ &=& \\\\ &=&\\end{cases}",!1,"{3x3",{width:"100%"},""),det3x3:new kt("\\begin{vmatrix}\\cursor&&\\\\ && \\\\ &&\\end{vmatrix}",!1,"|3x3|",{width:"100%"},""),det2x2:new kt("\\begin{vmatrix}\\cursor&\\\\ &\\end{vmatrix}",!1,"|2x2|",{width:"100%"},""),array3x3:new kt("\\begin{array}{rcl}\\cursor&=&\\\\ &=& \\\\ &=&\\end{array}",!1,"3x3",{width:"100%"},""),align3x3:new kt("\\begin{align}\\cursor&=&\\\\ &=& \\\\ &=&\\end{align}",!1,"al3x1",{width:"100%"},""),pi:new kt("\\pi",!1,"π",{width:"100%"},""),degrees:function(t,e,i,n){let o=new kt("",!0,e,i,n);for(let e=0;e<t.length;e++)o.addEditorAction(new At(t[e],!0));return o}(["^","\\circ"],"∘",{width:"100%"},""),alpha:new kt("\\alpha",!1,"α",{width:"100%"},""),beta:new kt("\\beta",!1,"β",{width:"100%"},""),gamma:new kt("\\gamma",!1,"γ",{width:"100%"},""),underscore:new kt("_",!0,"_",{width:"100%"},""),binom:new kt("\\binom{\\cursor}{}",!0,"bin",{width:"100%"},""),cup:new kt("\\cup",!0,"∪",{width:"100%"},""),cap:new kt("\\cap",!0,"∩",{width:"100%"},""),limit:new kt("\\lim_{\\cursor}",!1,"lim",{width:"100%"},"")};let Rt=new class{horizontalMath(t,e){const i=new $(t);return null===e&&(e=this.atom(t,"")),i.appendChild(e),i}genericMathBox(t,e){const i=new O(t);return i.appendChild(this.horizontalMath(t,e)),i}horizontalMathFromArray(t,e){let i=null;e.length>0&&(i=e[0]);let n=this.horizontalMath(t,i);for(let t=1;t<e.length;t++)null!==e[t]&&n.appendChild(e[t]);return n.normalizeHorizontalMath(),n}atom(t,e){const i=new D(t);return i.positionCursorBeforeKeyEvents=e.length,i.initialContent=e,i}atomImmutable(t,e){const i=new P(t);if(e in p.operatorsExtraPadding){let t=p.operatorsExtraPadding[e];i.type.paddingLeft=t,i.type.paddingRight=t}return e in p.operatorsExtraVerticalPadding&&(i.type.paddingBottom=p.operatorsExtraVerticalPadding[e]),e in p.operatorsExtraVerticalPaddingForSVG&&(i.type.paddingBottomRatioForSVG=p.operatorsExtraVerticalPaddingForSVG[e]),i.initialContent=e,i}fraction(t,e,i){const n=new I(t),o=new z(t),s=new q(t);return o.appendChild(this.horizontalMath(t,e)),s.appendChild(this.horizontalMath(t,i)),n.appendChild(o),n.appendChild(s),n}rootMath(t){const e=new H(t);return e.appendChild(this.horizontalMath(t,null)),e}error(t,e){const i=new F(t);return i.initialContent=e,i}cancel(t,e){const i=new N(t),n=new T(t,r.cancelSign),o=this.horizontalMath(t,e);let s=new V(t);return s.appendChild(o),s.normalizeHorizontalMath(),i.appendChild(n),i.appendChild(s),i}sqrtSign(t){let e=new K(t);return e.appendChild(new T(t,r.sqrtSignDecoration)),e.appendChild(new T(t,r.sqrtSignLeft)),e.appendChild(new T(t,r.sqrtSignRight)),e}sqrt(t,e,i){const n=new G(t),o=new T(t,r.radicalExponentBox);o.appendChild(this.horizontalMath(t,i)),n.appendChild(o),n.appendChild(Rt.sqrtSign(t));const s=new ut(t);return s.appendChild(Rt.horizontalMath(t,e)),n.appendChild(s),n}formInput(t,e){let i=e.split(",");return i.length<2&&(i.push(""),i.push("")),i[0]=i[0].trim(),i[1]=i[1].trim(),new Y(t,i[0],i[1])}overLine(t,e){const i=new U(t),n=this.horizontalMath(t,e);return i.appendChild(n),i}overBrace(t,e,i){const n=new Q(t),o=Rt.horizontalMath(t,e),s=new T(t,r.topLeftQuarterCircle),l=new T(t,r.horizontalLineBottomMargin),h=new T(t,r.bottomRightQuarterCircle),a=new T(t,r.bottomLeftQuarterCircle),d=new T(t,r.horizontalLineBottomMargin),c=new T(t,r.topRightQuarterCircle),u=new j(t,!0);u.appendChildren([s,l,h,a,d,c]);let p=Rt.genericMathBox(t,i);return n.appendChild(o),n.appendChild(u),n.appendChild(p),n}underBrace(t,e,i){const n=new X(t),o=Rt.horizontalMath(t,e),s=new T(t,r.bottomLeftQuarterCircle),l=new T(t,r.horizontalLineBottomMargin),h=new T(t,r.topRightQuarterCircle),a=new T(t,r.topLeftQuarterCircle),d=new T(t,r.horizontalLineBottomMargin),c=new T(t,r.bottomRightQuarterCircle),u=new j(t,!1);u.appendChildren([s,l,h,a,d,c]);let p=Rt.genericMathBox(t,i);return n.appendChild(o),n.appendChild(u),n.appendChild(p),n}baseWithExponent(t,e,i){const n=new W(t),o=new _(t);let s=this.horizontalMath(t,i);s.normalizeHorizontalMath(),s.ensureEditableAtoms(),o.appendChild(s);const r=new $(t);return r.appendChild(e),r.normalizeHorizontalMath(),n.appendChild(r),n.appendChild(o),n}baseWithSubscript(t,e,i){const n=new Z(t);let o=this.horizontalMath(t,i);o.normalizeHorizontalMath(),o.ensureEditableAtoms(),n.appendChild(o);const s=new $(t);s.appendChild(e),s.normalizeHorizontalMath();const r=new J(t);return r.appendChild(s),r.appendChild(n),r}leftParenthesis(t,e){return this.leftDelimiter(t,"(",e)}leftDelimiter(t,e,i){const n=new tt(t);return n.implied=i,""===e?n:(n.appendChild(this.delimiterMark(t,e,!0,i)),n.extraData=e,n)}delimiterMark(t,e,i,n){switch(e){case"⟩":e="\\rangle";break;case"⟨":e="\\langle"}let o=null;switch(e){case"|":o=new nt(t,i);break;case"\\rangle":case"\\langle":o=new ht(t,i),i?(o.appendChild(new T(t,r.verticalLineLeftMargin)),o.appendChild(new T(t,r.verticalLineLeftMargin))):(o.appendChild(new T(t,r.verticalLineRightMargin)),o.appendChild(new T(t,r.verticalLineRightMargin)));break;case"\\lceil":case"\\rceil":o=new lt(t,i);break;case"\\lfloor":case"\\rfloor":o=new rt(t,i);break;case"[":case"]":o=new st(t,i);break;case"(":case")":o=new at(t,i),i?o.appendChild(new T(t,r.verticalLineLeftMargin)):o.appendChild(new T(t,r.verticalLineRightMargin));break;case"{":case"}":default:o=new dt(t,i),i?(o.appendChild(new T(t,r.topLeftQuarterCircle)),o.appendChild(new T(t,r.verticalLineLeftMargin)),o.appendChild(new T(t,r.bottomRightQuarterCircle)),o.appendChild(new T(t,r.topRightQuarterCircle)),o.appendChild(new T(t,r.verticalLineLeftMargin)),o.appendChild(new T(t,r.bottomLeftQuarterCircle))):(o.appendChild(new T(t,r.topRightQuarterCircle)),o.appendChild(new T(t,r.verticalLineLeftMargin)),o.appendChild(new T(t,r.bottomLeftQuarterCircle)),o.appendChild(new T(t,r.topRightQuarterCircle)),o.appendChild(new T(t,r.verticalLineLeftMargin)),o.appendChild(new T(t,r.bottomRightQuarterCircle)))}return o.implied=n,o}rightParenthesis(t,e){return this.rightDelimiter(t,")",e)}rightDelimiter(t,e,i){const n=new et(t);return n.implied=i,""===e?n:(n.appendChild(this.delimiterMark(t,e,!1,i)),n.extraData=e,n)}matrix(t,e,i,n,o){const s=new T(t,r.matrixTable);for(let n=0;n<e;n++)s.appendChild(this.matrixRow(t,i));let l=null,h=null;""===n?"bmatrix"===o?(l=this.leftDelimiter(t,"[",!1),h=this.rightDelimiter(t,"]",!1)):"pmatrix"===o||"binom"==o?(l=this.leftParenthesis(t,!1),h=this.rightParenthesis(t,!1)):"vmatrix"==o?(l=this.leftDelimiter(t,"|",!1),h=this.rightDelimiter(t,"|",!1)):"cases"===o?(l=this.leftDelimiter(t,"{",!1),h=this.rightDelimiter(t,"",!1)):(l=this.leftDelimiter(t,"",!1),h=this.rightDelimiter(t,"",!1)):(l=this.leftDelimiter(t,"",!1),h=this.rightDelimiter(t,"",!1));let a=this.horizontalMath(t,l);a.appendChild(s),a.appendChild(h);let d=new ct(t,o);return d.latexExtraStyle=n,d.appendChild(a),d.appendChildren(new Ct(n).verticalSeparators(t)),d}matrixRow(t,e){let i=new pt(t);for(let n=0;n<e;n++)i.appendChild(this.matrixRowEntry(t,null));return i}matrixRowEntry(t,e){let i=new mt(t);return i.appendChild(this.horizontalMath(t,e)),i}matrixVerticalLine(t,e,i){let n=new gt(t);return n.extraData=new St(e,i),n}operatorWithSuperAndSubscript(t,e,i,n){let o=new xt(t),s=new Bt(t),r=new yt(t),l=new ft(t);return s.appendChild(this.horizontalMath(t,i)),r.appendChild(this.horizontalMath(t,n)),l.appendChild(this.atomImmutable(t,e)),o.appendChild(s),o.appendChild(l),o.appendChild(r),o}operatorWithSubscript(t,e,i){let n=new bt(t),o=new yt(t);o.type.fontSizeRatio=.8;let s=new ft(t);return s.type.fontSizeRatio=1,o.appendChild(this.horizontalMath(t,i)),s.appendChild(this.atomImmutable(t,e)),n.appendChild(s),n.appendChild(o),n}};void 0===t&&(t={exports:null}),t.exports={typeset:function(t,e,i){void 0===e&&(e=null),new Tt(i).typeset(t,e)},EquationEditor:B,EquationEditorButtonFactory:kt,EquationEditorAction:At,buttonFactories:Lt,EquationEditorOptions:g,EquationEditorButtonPanel:class{constructor(t,e,i){this.editor=t,this.panelContainer=e,this.expandableDiv=null,this.buttonTable=null,this.panelHeight="",this.collapseButton=null===i.collapseButton||void 0===i.collapseButton?null:i.collapseButton,this.expandButton=null===i.expandButton||null==i.expandButton?null:i.expandButton,this.numberOfColumns=void 0===i.numberOfColumns?8:i.numberOfColumns,this.desiredButtons=[],this.startsExpanded=void 0===i.startsExpanded||i.startsExpanded,this.expanded=!1,!0!==i.useDefaultButtonFactories&&void 0!==i.useDefaultButtonFactories||(this.desiredButtons=[Lt.plus,Lt.minus,Lt.product,Lt.divide,Lt.exponent,Lt.times,Lt.fraction,Lt.leftParenthesis,Lt.rightParenthesis,Lt.sqrt,Lt.integral,Lt.sum,Lt.limit,Lt.pi,Lt.degrees,Lt.alpha,Lt.beta,Lt.underscore,Lt.cup,Lt.cap,Lt.matrix2x2,Lt.pmatrix2x2,Lt.bmatrix3x3,Lt.bmatrix2x2,Lt.bmatrix1x3,Lt.bmatrix1x2,Lt.bmatrix2x1,Lt.det2x2,Lt.det3x3,Lt.cases3x3,Lt.array3x3,Lt.align3x3])}addButtonFactory(t,e,i,n,o){this.desiredButtons.push(new kt(t,e,i,n,o))}constructPanelDOM(){this.panelContainer.textContent="",this.buttonTable=document.createElement("table");let t=this.buttonTable.insertRow(-1);for(let e=0;e<this.desiredButtons.length;e++){t.cells.length>=this.numberOfColumns&&(t=this.buttonTable.insertRow(-1));let i=this.desiredButtons[e];t.insertCell(-1).appendChild(i.getButton(this.editor))}this.expandableDiv=document.createElement("div"),this.expandableDiv.appendChild(this.buttonTable),this.buttonTable.style.marginLeft="auto",this.buttonTable.style.marginRight="auto",this.expandableDiv.style.textAlign="center",this.expandableDiv.style.transition="all 1s",this.panelContainer.appendChild(this.expandableDiv),this.expanded=this.startsExpanded,null!==this.collapseButton&&this.collapseButton.addEventListener("click",()=>{this.collapse()}),null!==this.expandButton&&this.expandButton.addEventListener("click",()=>{this.expand()}),this.panelHeight=window.getComputedStyle(this.expandableDiv).height,setTimeout(()=>{this.matchExpandedStatus()},0)}collapse(){this.expanded=!1,this.matchExpandedStatus()}expand(){this.expanded=!0,this.matchExpandedStatus()}matchExpandedStatus(){this.expanded?(this.expandableDiv.style.maxHeight=this.panelHeight,this.expandableDiv.style.height=this.panelHeight,setTimeout(()=>{this.buttonTable.style.display=""},1e3),null!==this.expandButton&&(this.expandButton.style.display="none"),null!==this.collapseButton&&(this.collapseButton.style.display="")):(this.expandableDiv.style.maxHeight="0px",this.expandableDiv.style.height="0px",this.buttonTable.style.display="none",null!==this.expandButton&&(this.expandButton.style.display=""),null!==this.collapseButton&&(this.collapseButton.style.display="none"))}},mathFromLatex:a,mathFromElement:h,latexConstants:p,MathNode:T,knownTypes:r}}]);